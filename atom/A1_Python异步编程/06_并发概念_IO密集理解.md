# å¹¶å‘æ¦‚å¿µ - I/O å¯†é›†ç†è§£

## 1. ã€30å­—æ ¸å¿ƒã€‘

**I/O å¯†é›†æŒ‡ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…è¾“å…¥è¾“å‡ºï¼ˆç½‘ç»œã€ç£ç›˜ï¼‰ï¼Œè€Œéè®¡ç®—ï¼Œæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³åº”ç”¨åœºæ™¯ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### I/O å¯†é›†çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**I/O å¯†é›† (I/O Bound) = ç¨‹åºçš„ç“¶é¢ˆåœ¨äºç­‰å¾… I/Oï¼Œä¸åœ¨äº CPU è®¡ç®—**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

å¯¹æ¯”ï¼š
- **I/O å¯†é›†**ï¼šå¤§éƒ¨åˆ†æ—¶é—´ç­‰ç½‘ç»œã€ç£ç›˜ã€æ•°æ®åº“
- **CPU å¯†é›†**ï¼šå¤§éƒ¨åˆ†æ—¶é—´åœ¨åšè®¡ç®—ï¼ˆåŠ å‡ä¹˜é™¤ã€å¾ªç¯ï¼‰

#### 2. ä¸ºä»€ä¹ˆç†è§£ I/O å¯†é›†å¾ˆé‡è¦ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šé€‰é”™å¹¶å‘æ–¹æ¡ˆ = æ€§èƒ½ç¾éš¾**

```
I/O å¯†é›† + å¼‚æ­¥ = é«˜æ•ˆ âœ…
I/O å¯†é›† + å¤šè¿›ç¨‹ = æµªè´¹èµ„æº âŒ

CPU å¯†é›† + å¤šè¿›ç¨‹ = é«˜æ•ˆ âœ…
CPU å¯†é›† + å¼‚æ­¥ = æ— æ•ˆ âŒ
```

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š
```python
# å‘é‡æ•°æ®åº“æŸ¥è¯¢ï¼ˆI/O å¯†é›†ï¼‰
# æ¯æ¬¡æŸ¥è¯¢ï¼šCPU å·¥ä½œ 1msï¼Œç­‰å¾…ç½‘ç»œ 99ms

# æ–¹æ¡ˆ1ï¼šå¤šè¿›ç¨‹ï¼ˆé”™è¯¯é€‰æ‹©ï¼‰
# 8 ä¸ªè¿›ç¨‹ Ã— 8 æ ¸ CPU â†’ 8 å€ CPU
# ä½†ç“¶é¢ˆæ˜¯ç½‘ç»œï¼ŒCPU æœ¬æ¥å°±åªç”¨ 1%
# ç»“æœï¼šæµªè´¹ 8 ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼Œæ•ˆæœçº¦ç­‰äº 0

# æ–¹æ¡ˆ2ï¼šå¼‚æ­¥ï¼ˆæ­£ç¡®é€‰æ‹©ï¼‰
# å•çº¿ç¨‹ï¼Œ100 ä¸ªå¹¶å‘æŸ¥è¯¢
# æ¯ä¸ªæŸ¥è¯¢ç­‰å¾…æ—¶ï¼ŒCPU å»å¤„ç†å…¶ä»–æŸ¥è¯¢
# ç»“æœï¼šååé‡æå‡ 100 å€ï¼Œèµ„æºæ¶ˆè€—ä¸å˜
```

#### 3. I/O å¯†é›†çš„ä¸‰å±‚ç†è§£

##### å±‚æ¬¡1ï¼šæ—¶é—´åˆ†å¸ƒ
I/O å¯†é›†ç¨‹åºçš„æ—¶é—´åˆ†å¸ƒï¼š

```
CPU å¯†é›†å‹ï¼š
[è®¡ç®—][è®¡ç®—][è®¡ç®—][è®¡ç®—][å°‘é‡I/O][è®¡ç®—][è®¡ç®—]
  90%+ æ—¶é—´åœ¨è®¡ç®—

I/O å¯†é›†å‹ï¼š
[è®¡ç®—][----ç­‰å¾…I/O----][è®¡ç®—][----ç­‰å¾…I/O----]
  10% è®¡ç®—ï¼Œ90% ç­‰å¾…
```

##### å±‚æ¬¡2ï¼šèµ„æºç“¶é¢ˆ
```
CPU å¯†é›†ï¼š
- ç“¶é¢ˆï¼šCPU æ ¸å¿ƒæ•°
- è§£å†³ï¼šå¤šè¿›ç¨‹ï¼Œç”¨æ»¡æ‰€æœ‰æ ¸

I/O å¯†é›†ï¼š
- ç“¶é¢ˆï¼šI/O å¸¦å®½ã€å»¶è¿Ÿ
- è§£å†³ï¼šå¼‚æ­¥/å¤šçº¿ç¨‹ï¼Œåœ¨ç­‰å¾…æ—¶åšåˆ«çš„
```

##### å±‚æ¬¡3ï¼šä¼˜åŒ–æ–¹å‘
```
CPU å¯†é›†ä¼˜åŒ–ï¼š
- ç®—æ³•ä¼˜åŒ–ï¼ˆé™ä½å¤æ‚åº¦ï¼‰
- ä½¿ç”¨æ›´å¿«çš„è¯­è¨€ï¼ˆC/Rustï¼‰
- å¹¶è¡Œè®¡ç®—ï¼ˆå¤šæ ¸ï¼‰

I/O å¯†é›†ä¼˜åŒ–ï¼š
- å¼‚æ­¥ç¼–ç¨‹ï¼ˆä¸ç­‰å¾…ï¼‰
- æ‰¹é‡æ“ä½œï¼ˆå‡å°‘ I/O æ¬¡æ•°ï¼‰
- ç¼“å­˜ï¼ˆé¿å… I/Oï¼‰
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼å‘é‡æ•°æ®åº“åº”ç”¨

**æ¨ç†é“¾ï¼š**
```
1. å‘é‡æ•°æ®åº“æ“ä½œ = ç½‘ç»œè¯·æ±‚ + ç£ç›˜è¯»å†™
   â†“
2. ç½‘ç»œå»¶è¿Ÿï¼š10-100msï¼Œç£ç›˜å»¶è¿Ÿï¼š1-10ms
   â†“
3. å‘é‡è®¡ç®—ï¼ˆç›¸ä¼¼åº¦ï¼‰ï¼š0.01-0.1ms
   â†“
4. ç­‰å¾…æ—¶é—´ >> è®¡ç®—æ—¶é—´ â†’ å…¸å‹ I/O å¯†é›†
   â†“
5. æœ€ä½³æ–¹æ¡ˆï¼šå¼‚æ­¥ + æ‰¹é‡ + ç¼“å­˜
```

**å‘é‡æ•°æ®åº“çš„ I/O å¯†é›†ç‰¹å¾ï¼š**
```python
# ä¸€æ¬¡å‘é‡æŸ¥è¯¢çš„æ—¶é—´åˆ†è§£
def analyze_query_time():
    """
    æ€»è€—æ—¶ï¼š50ms
    - ç½‘ç»œå¾€è¿”ï¼š40ms (80%)  â† I/O
    - ç´¢å¼•æŸ¥æ‰¾ï¼š5ms (10%)   â† I/Oï¼ˆç£ç›˜ï¼‰
    - å‘é‡è®¡ç®—ï¼š3ms (6%)    â† CPU
    - ç»“æœåºåˆ—åŒ–ï¼š2ms (4%)  â† CPU
    
    ç»“è®ºï¼š86% æ˜¯ I/Oï¼Œå…¸å‹ I/O å¯†é›†
    """
    pass
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**I/O å¯†é›†æ˜¯ç¨‹åºç“¶é¢ˆåœ¨"ç­‰å¾…"è€Œé"è®¡ç®—"ï¼Œå‘é‡æ•°æ®åº“æ˜¯å…¸å‹çš„ I/O å¯†é›†åœºæ™¯ï¼Œåº”è¯¥ç”¨å¼‚æ­¥è€Œéå¤šè¿›ç¨‹ä¼˜åŒ–ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šI/O å»¶è¿Ÿå±‚çº§ â±ï¸

**ä¸åŒ I/O æ“ä½œçš„å»¶è¿Ÿå·®å¼‚å·¨å¤§ï¼Œç†è§£è¿™ä¸ªæ˜¯é€‰æ‹©æ–¹æ¡ˆçš„åŸºç¡€ã€‚**

```python
"""
å»¶è¿Ÿå¯¹æ¯”ï¼ˆæ•°é‡çº§ï¼‰ï¼š

æ“ä½œ                    å»¶è¿Ÿ           ç›¸å¯¹äº CPU æŒ‡ä»¤
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CPU å¯„å­˜å™¨è®¿é—®          0.3 ns        1x
L1 ç¼“å­˜               1 ns          3x
L2 ç¼“å­˜               4 ns          13x
L3 ç¼“å­˜               20 ns         67x
ä¸»å†…å­˜                100 ns        333x
SSD éšæœºè¯»            150 Î¼s        500,000x
HDD éšæœºè¯»            10 ms         33,000,000x
ç½‘ç»œï¼ˆåŒæœºæˆ¿ï¼‰         0.5 ms        1,700,000x
ç½‘ç»œï¼ˆè·¨åŸå¸‚ï¼‰         30 ms         100,000,000x
ç½‘ç»œï¼ˆè·¨æ´²ï¼‰          150 ms        500,000,000x
"""
```

**å¯è§†åŒ–ï¼ˆå¦‚æœ CPU æŒ‡ä»¤æ˜¯ 1 ç§’ï¼‰ï¼š**
```
CPU æŒ‡ä»¤:     1 ç§’
L1 ç¼“å­˜:      3 ç§’
ä¸»å†…å­˜:       5 åˆ†é’Ÿ
SSD:          6 å¤©
ç½‘ç»œè¯·æ±‚:     16 å¹´ï¼ˆï¼ï¼‰
```

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**
- æœ¬åœ°ç¼“å­˜å‘½ä¸­ï¼šå¾®ç§’çº§
- æœ¬åœ° SSD æŸ¥è¯¢ï¼šæ¯«ç§’çº§
- è¿œç¨‹æ•°æ®åº“æŸ¥è¯¢ï¼šå‡ åæ¯«ç§’
- è·¨åŒºåŸŸæŸ¥è¯¢ï¼šä¸Šç™¾æ¯«ç§’

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šCPU å¯†é›† vs I/O å¯†é›†åˆ¤æ–­ ğŸ”

**å¦‚ä½•åˆ¤æ–­ä½ çš„ç¨‹åºæ˜¯ CPU å¯†é›†è¿˜æ˜¯ I/O å¯†é›†ï¼Ÿ**

```python
import time
import psutil
import os

def measure_io_ratio():
    """æµ‹é‡ç¨‹åºçš„ I/O å¯†é›†ç¨‹åº¦"""
    process = psutil.Process(os.getpid())
    
    # è¿è¡Œå‰
    start_time = time.time()
    start_cpu = process.cpu_times()
    
    # è¿è¡Œä½ çš„ä»£ç 
    your_function()
    
    # è¿è¡Œå
    end_time = time.time()
    end_cpu = process.cpu_times()
    
    # è®¡ç®—
    wall_time = end_time - start_time  # å®é™…è€—æ—¶
    cpu_time = (end_cpu.user - start_cpu.user) + \
               (end_cpu.system - start_cpu.system)  # CPU æ—¶é—´
    
    cpu_ratio = cpu_time / wall_time
    
    print(f"å®é™…è€—æ—¶: {wall_time:.2f}s")
    print(f"CPU æ—¶é—´: {cpu_time:.2f}s")
    print(f"CPU åˆ©ç”¨ç‡: {cpu_ratio:.1%}")
    
    if cpu_ratio > 0.8:
        print("â†’ CPU å¯†é›†å‹")
    elif cpu_ratio < 0.2:
        print("â†’ I/O å¯†é›†å‹")
    else:
        print("â†’ æ··åˆå‹")
```

**å¿«é€Ÿåˆ¤æ–­æ³•ï¼š**

| ç‰¹å¾ | CPU å¯†é›† | I/O å¯†é›† |
|-----|---------|---------|
| CPU åˆ©ç”¨ç‡ | æ¥è¿‘ 100% | å¾ˆä½ï¼ˆ< 20%ï¼‰ |
| ä¸»è¦æ“ä½œ | å¾ªç¯ã€è®¡ç®— | ç½‘ç»œã€æ–‡ä»¶ |
| å¢åŠ å¹¶å‘ | éœ€è¦æ›´å¤š CPU | ä¸éœ€è¦æ›´å¤š CPU |
| å…¸å‹åœºæ™¯ | å›¾åƒå¤„ç†ã€åŠ å¯† | Web æœåŠ¡ã€æ•°æ®åº“ |

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šå¹¶å‘æ–¹æ¡ˆé€‰æ‹© ğŸ¯

**æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æ­£ç¡®çš„å¹¶å‘æ–¹æ¡ˆï¼š**

```python
"""
é€‰æ‹©æŒ‡å—ï¼š

ä»»åŠ¡ç±»å‹          æœ€ä½³æ–¹æ¡ˆ           åŸå› 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
I/O å¯†é›†         asyncio            å•çº¿ç¨‹ï¼Œä½å¼€é”€ï¼Œé«˜å¹¶å‘
I/O å¯†é›†         threading          å¤šçº¿ç¨‹ï¼ŒGIL å¯¹ I/O æ— å½±å“
CPU å¯†é›†         multiprocessing    å¤šè¿›ç¨‹ï¼Œç»•è¿‡ GIL
æ··åˆå‹           ProcessPool +      è®¡ç®—ç”¨å¤šè¿›ç¨‹ï¼ŒI/O ç”¨å¼‚æ­¥
                 asyncio
"""

# I/O å¯†é›†ï¼šç”¨ asyncio
async def io_bound_solution():
    tasks = [fetch_url(url) for url in urls]
    return await asyncio.gather(*tasks)

# CPU å¯†é›†ï¼šç”¨ multiprocessing
def cpu_bound_solution():
    with multiprocessing.Pool() as pool:
        return pool.map(heavy_compute, data_list)

# æ··åˆå‹ï¼šç»„åˆä½¿ç”¨
async def mixed_solution():
    # I/O éƒ¨åˆ†å¼‚æ­¥
    raw_data = await fetch_all_data()
    
    # CPU éƒ¨åˆ†å¤šè¿›ç¨‹
    loop = asyncio.get_event_loop()
    results = await loop.run_in_executor(
        ProcessPoolExecutor(),
        cpu_heavy_process,
        raw_data
    )
    return results
```

**å‘é‡æ•°æ®åº“åœºæ™¯ï¼š**
```python
# å‘é‡æŸ¥è¯¢ = I/O å¯†é›† â†’ asyncio
async def vector_search():
    return await db.search(query)

# å‘é‡è®¡ç®—ï¼ˆå¦‚æœ¬åœ°ç›¸ä¼¼åº¦ï¼‰= CPU å¯†é›† â†’ multiprocessing
def local_similarity(vectors):
    with Pool() as p:
        return p.map(compute_similarity, vectors)

# å®Œæ•´æµç¨‹ = æ··åˆ
async def full_pipeline():
    # 1. å¼‚æ­¥æŸ¥è¯¢æ•°æ®åº“
    candidates = await db.search(query, limit=1000)
    
    # 2. å¤šè¿›ç¨‹é‡æ’åºï¼ˆCPU å¯†é›†ï¼‰
    loop = asyncio.get_event_loop()
    ranked = await loop.run_in_executor(
        ProcessPoolExecutor(),
        rerank,
        candidates
    )
    
    return ranked[:10]
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½æ­£ç¡®å¤„ç†80%çš„ I/O å¯†é›†åœºæ™¯ï¼š

### 4.1 è¯†åˆ« I/O å¯†é›†ä»£ç 

```python
# I/O å¯†é›†çš„ç‰¹å¾ä»£ç 
import requests
import time

def io_bound_example():
    # ç½‘ç»œè¯·æ±‚ = I/O
    response = requests.get('https://api.example.com')
    
    # æ–‡ä»¶æ“ä½œ = I/O
    with open('data.txt', 'r') as f:
        data = f.read()
    
    # æ•°æ®åº“æŸ¥è¯¢ = I/O
    result = db.execute('SELECT * FROM vectors')
    
    # æ³¨æ„ï¼šè¿™äº›æ“ä½œæ—¶ï¼ŒCPU å‡ ä¹ç©ºé—²
```

### 4.2 ç”¨ asyncio ä¼˜åŒ– I/O å¯†é›†

```python
import asyncio
import aiohttp

# åŒæ­¥ç‰ˆæœ¬ï¼ˆä¸²è¡Œï¼Œæ…¢ï¼‰
def sync_fetch_all(urls):
    results = []
    for url in urls:
        response = requests.get(url)
        results.append(response.text)
    return results
# 10 ä¸ª URLï¼Œæ¯ä¸ª 100ms â†’ 1 ç§’

# å¼‚æ­¥ç‰ˆæœ¬ï¼ˆå¹¶è¡Œï¼Œå¿«ï¼‰
async def async_fetch_all(urls):
    async with aiohttp.ClientSession() as session:
        tasks = [session.get(url) for url in urls]
        responses = await asyncio.gather(*tasks)
        return [await r.text() for r in responses]
# 10 ä¸ª URLï¼Œæ¯ä¸ª 100ms â†’ ~100ms
```

### 4.3 æ‰¹é‡å‡å°‘ I/O æ¬¡æ•°

```python
# å·®çš„åšæ³•ï¼šå¤šæ¬¡ I/O
async def bad_insert(vectors):
    for v in vectors:
        await db.insert(v)  # 1000 æ¬¡ç½‘ç»œè¯·æ±‚
# 1000 æ¡ï¼Œæ¯æ¬¡ 10ms â†’ 10 ç§’

# å¥½çš„åšæ³•ï¼šæ‰¹é‡ I/O
async def good_insert(vectors):
    await db.insert_many(vectors)  # 1 æ¬¡ç½‘ç»œè¯·æ±‚
# 1000 æ¡ï¼Œ1 æ¬¡è¯·æ±‚ â†’ ~50ms
```

### 4.4 ç¼“å­˜é¿å… I/O

```python
from functools import lru_cache

# æ— ç¼“å­˜ï¼šæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
async def get_vector_no_cache(id):
    return await db.get(id)  # æ¯æ¬¡éƒ½ I/O

# æœ‰ç¼“å­˜ï¼šé‡å¤æŸ¥è¯¢ä¸èµ° I/O
cache = {}
async def get_vector_with_cache(id):
    if id not in cache:
        cache[id] = await db.get(id)
    return cache[id]  # å‘½ä¸­ç¼“å­˜æ—  I/O
```

### 4.5 å‘é‡æ•°æ®åº“ä¼˜åŒ–ç¤ºä¾‹

```python
import asyncio

class OptimizedVectorDB:
    def __init__(self, client):
        self.client = client
        self.cache = {}
        self.batch_buffer = []
        self.batch_size = 100
    
    async def search(self, query_vector):
        """å•æ¬¡æœç´¢"""
        return await self.client.search(query_vector)
    
    async def batch_search(self, query_vectors):
        """æ‰¹é‡æœç´¢ï¼ˆå¹¶è¡Œ I/Oï¼‰"""
        tasks = [self.search(q) for q in query_vectors]
        return await asyncio.gather(*tasks)
    
    async def cached_get(self, vector_id):
        """å¸¦ç¼“å­˜çš„è·å–"""
        if vector_id not in self.cache:
            self.cache[vector_id] = await self.client.get(vector_id)
        return self.cache[vector_id]
    
    def add_to_batch(self, vector):
        """æ·»åŠ åˆ°æ‰¹é‡ç¼“å†²"""
        self.batch_buffer.append(vector)
        if len(self.batch_buffer) >= self.batch_size:
            return self.flush_batch()
        return None
    
    async def flush_batch(self):
        """åˆ·æ–°æ‰¹é‡ç¼“å†²"""
        if self.batch_buffer:
            await self.client.insert_many(self.batch_buffer)
            self.batch_buffer = []
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- åˆ¤æ–­ç¨‹åºæ˜¯å¦ I/O å¯†é›†
- é€‰æ‹©æ­£ç¡®çš„å¹¶å‘æ–¹æ¡ˆ
- åº”ç”¨åŸºæœ¬çš„ I/O ä¼˜åŒ–æŠ€å·§
- æ„å»ºé«˜æ•ˆçš„å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šI/O å¯†é›† = ç­‰å¾… API å“åº” ğŸ¨

```javascript
// å‰ç«¯ï¼šå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰ APIï¼ˆI/O å¯†é›†ï¼‰
async function loadDashboard() {
    // è¿™äº›æ“ä½œå¤§éƒ¨åˆ†æ—¶é—´åœ¨"ç­‰"
    const user = await fetch('/api/user');
    const posts = await fetch('/api/posts');
    const comments = await fetch('/api/comments');
    
    // CPU å·¥ä½œåªæ˜¯æ¸²æŸ“ï¼Œå¾ˆå¿«
    render(user, posts, comments);
}
```

```python
# Pythonï¼šåŒæ ·æ˜¯ç­‰ API
async def load_dashboard():
    user = await fetch('/api/user')
    posts = await fetch('/api/posts')
    comments = await fetch('/api/comments')
    return render(user, posts, comments)
```

---

### ç±»æ¯”2ï¼šCPU å¯†é›† vs I/O å¯†é›† = åšèœ vs ç­‰å¤–å– ğŸ³

```
CPU å¯†é›†ï¼ˆåšèœï¼‰ï¼š
- ä½ ä¸€ç›´åœ¨å¿™ï¼šåˆ‡èœã€ç‚’èœã€è£…ç›˜
- æœ‰å¤šå°‘äººï¼ˆCPUï¼‰å°±èƒ½åŒæ—¶åšå¤šå°‘é“èœ
- å¹¶è¡Œ = æ›´å¤šå¨å¸ˆ

I/O å¯†é›†ï¼ˆç­‰å¤–å–ï¼‰ï¼š
- ä½ ç‚¹å®Œå•å°±ç­‰ç€
- ç­‰å¾…æ—¶ä½ å¯ä»¥åšå…¶ä»–äº‹
- å¹¶è¡Œ = åŒæ—¶ç‚¹å¤šå®¶å¤–å–
```

```python
# CPU å¯†é›†ï¼šåšèœï¼ˆä¸€ç›´å¿™ï¼‰
def cpu_bound_cooking():
    for i in range(1000000):
        result = complex_calculation(i)  # CPU ä¸€ç›´åœ¨ç®—

# I/O å¯†é›†ï¼šç­‰å¤–å–ï¼ˆå¤§éƒ¨åˆ†æ—¶é—´ç­‰ï¼‰
async def io_bound_delivery():
    await order_from_restaurant_a()  # ç­‰...
    await order_from_restaurant_b()  # ç­‰...
    # å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰ï¼ŒCPU å¾ˆé—²
```

---

### ç±»æ¯”3ï¼šI/O å¯†é›† = åŠ è½½é¡µé¢èµ„æº ğŸ“„

```javascript
// ç½‘é¡µåŠ è½½æ˜¯å…¸å‹çš„ I/O å¯†é›†
// å¤§éƒ¨åˆ†æ—¶é—´åœ¨ä¸‹è½½èµ„æºï¼Œä¸æ˜¯æ‰§è¡Œ JS

// å·®çš„åšæ³•ï¼šä¸²è¡ŒåŠ è½½
await loadCSS();
await loadJS();
await loadImages();
// æ€»æ—¶é—´ = CSS + JS + Images

// å¥½çš„åšæ³•ï¼šå¹¶è¡ŒåŠ è½½
await Promise.all([
    loadCSS(),
    loadJS(),
    loadImages()
]);
// æ€»æ—¶é—´ = max(CSS, JS, Images)
```

```python
# Python åŒç†
# å·®
css = await load('style.css')
js = await load('app.js')
images = await load_images()

# å¥½
css, js, images = await asyncio.gather(
    load('style.css'),
    load('app.js'),
    load_images()
)
```

---

### ç±»æ¯”4ï¼šI/O å»¶è¿Ÿ = ä»ä¸åŒåœ°æ–¹å–ä¸œè¥¿ ğŸƒ

```
å–ä¸œè¥¿çš„æ—¶é—´ç±»æ¯”ï¼ˆå¦‚æœ CPU æŒ‡ä»¤æ˜¯ 1 æ­¥ï¼‰ï¼š

CPU ç¼“å­˜ï¼š    èµ°åˆ°éš”å£æ¡Œï¼ˆ3 æ­¥ï¼‰
å†…å­˜ï¼š        èµ°åˆ°éš”å£æˆ¿é—´ï¼ˆ5 åˆ†é’Ÿï¼‰
SSDï¼š         èµ°åˆ°éš”å£åŸå¸‚ï¼ˆ6 å¤©ï¼‰
ç½‘ç»œè¯·æ±‚ï¼š    èµ°åˆ°æœˆçƒï¼ˆ16 å¹´ï¼‰
```

```javascript
// å‰ç«¯ç±»æ¯”ï¼šè·å–æ•°æ®çš„å»¶è¿Ÿ
// localStorageï¼šæ¯«ç§’çº§ï¼ˆæœ¬åœ°ï¼‰
const local = localStorage.getItem('data');

// API è¯·æ±‚ï¼šç§’çº§ï¼ˆè¿œç¨‹ï¼‰
const remote = await fetch('/api/data');

// é€‰æ‹©ç­–ç•¥ï¼šä¼˜å…ˆæœ¬åœ°ï¼Œå…¶æ¬¡å¹¶è¡Œè¿œç¨‹
```

---

### ç±»æ¯”5ï¼šå¹¶å‘æ–¹æ¡ˆé€‰æ‹© = å‰ç«¯æ€§èƒ½ä¼˜åŒ– ğŸš€

```javascript
// å‰ç«¯ I/O å¯†é›†ä¼˜åŒ–
// 1. å¹¶è¡Œè¯·æ±‚ï¼ˆç±»ä¼¼ asyncio.gatherï¼‰
Promise.all([api1(), api2(), api3()]);

// 2. ç¼“å­˜ï¼ˆç±»ä¼¼ Python lru_cacheï¼‰
const cache = new Map();
async function cachedFetch(url) {
    if (!cache.has(url)) {
        cache.set(url, await fetch(url));
    }
    return cache.get(url);
}

// 3. æ‰¹é‡è¯·æ±‚ï¼ˆç±»ä¼¼æ‰¹é‡æ’å…¥ï¼‰
// å·®ï¼š10 ä¸ªè¯·æ±‚
for (const id of ids) {
    await fetch(`/api/item/${id}`);
}
// å¥½ï¼š1 ä¸ªæ‰¹é‡è¯·æ±‚
await fetch('/api/items', { body: JSON.stringify(ids) });
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| I/O å¯†é›†æ¦‚å¿µ | å‰ç«¯å¯¹åº” |
|-------------|---------|
| I/O ç­‰å¾… | API è¯·æ±‚ç­‰å¾… |
| å¼‚æ­¥ä¼˜åŒ– | Promise.all |
| æ‰¹é‡æ“ä½œ | æ‰¹é‡ API |
| ç¼“å­˜ | localStorage / å†…å­˜ç¼“å­˜ |
| å¹¶å‘æ§åˆ¶ | è¯·æ±‚å¹¶å‘æ•°é™åˆ¶ |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šI/O å¯†é›†ç”¨å¤šè¿›ç¨‹æ›´å¿« âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- I/O å¯†é›†çš„ç“¶é¢ˆæ˜¯ç­‰å¾…ï¼Œä¸æ˜¯ CPU
- å¤šè¿›ç¨‹å¢åŠ  CPUï¼Œä½† CPU æœ¬æ¥å°±é—²ç€
- å¤šè¿›ç¨‹å¼€é”€å¤§ï¼ˆå†…å­˜ã€è¿›ç¨‹åˆ‡æ¢ï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸º"å¤šè¿›ç¨‹"å¬èµ·æ¥æ›´å¼ºå¤§ï¼Œè€Œä¸”åœ¨ CPU å¯†é›†åœºæ™¯ç¡®å®æœ‰æ•ˆã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
import asyncio
import multiprocessing
import time

# I/O å¯†é›†ä»»åŠ¡
async def io_task():
    await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    return 1

# é”™è¯¯ï¼šç”¨å¤šè¿›ç¨‹
def multiprocess_io():
    with multiprocessing.Pool(4) as pool:
        # è¿›ç¨‹åˆ›å»ºå¼€é”€ + è¿›ç¨‹é—´é€šä¿¡å¼€é”€
        # 4 ä¸ªè¿›ç¨‹å„è‡ªç­‰å¾…ï¼Œæ²¡æœ‰ä»»ä½•åŠ é€Ÿ
        pass

# æ­£ç¡®ï¼šç”¨å¼‚æ­¥
async def async_io():
    tasks = [io_task() for _ in range(100)]
    return await asyncio.gather(*tasks)
    # 100 ä¸ªè¯·æ±‚ï¼Œåªéœ€è¦ ~0.1 ç§’

# ç»“æœï¼š
# å¤šè¿›ç¨‹ 100 ä¸ªè¯·æ±‚ï¼šå¯èƒ½ 3-5 ç§’ï¼ˆè¿›ç¨‹å¼€é”€ï¼‰
# å¼‚æ­¥ 100 ä¸ªè¯·æ±‚ï¼š~0.1 ç§’
```

---

### è¯¯åŒº2ï¼šå¼‚æ­¥èƒ½åŠ é€Ÿä»»ä½•ä»£ç  âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å¼‚æ­¥åªèƒ½ä¼˜åŒ– I/O ç­‰å¾…
- CPU è®¡ç®—éƒ¨åˆ†æ— æ³•ä¼˜åŒ–
- æ²¡æœ‰ I/O çš„ä»£ç ç”¨å¼‚æ­¥åè€Œæ›´æ…¢

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºå¼‚æ­¥æ•™ç¨‹æ€»æ˜¯å±•ç¤ºå·¨å¤§çš„æ€§èƒ½æå‡ï¼Œè®©äººè¯¯ä»¥ä¸ºæ˜¯ä¸‡èƒ½çš„ã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
import asyncio
import time

# CPU å¯†é›†ä»»åŠ¡
def cpu_task():
    return sum(i * i for i in range(1000000))

async def async_cpu_task():
    return sum(i * i for i in range(1000000))

# åŒæ­¥ç‰ˆæœ¬
def sync_run():
    start = time.time()
    for _ in range(4):
        cpu_task()
    print(f"åŒæ­¥: {time.time() - start:.2f}s")

# å¼‚æ­¥ç‰ˆæœ¬ï¼ˆå¹¶æ²¡æœ‰æ›´å¿«ï¼ï¼‰
async def async_run():
    start = time.time()
    await asyncio.gather(*[async_cpu_task() for _ in range(4)])
    print(f"å¼‚æ­¥: {time.time() - start:.2f}s")

# è¿è¡Œç»“æœï¼š
# åŒæ­¥: 0.50s
# å¼‚æ­¥: 0.52sï¼ˆç”šè‡³æ›´æ…¢ï¼Œå› ä¸ºæœ‰åç¨‹å¼€é”€ï¼‰

# åŸå› ï¼šæ²¡æœ‰ await I/Oï¼Œå¼‚æ­¥æ ¹æœ¬æ²¡æœ‰"è®©å‡º"çš„æœºä¼š
```

---

### è¯¯åŒº3ï¼šI/O å¯†é›†ç¨‹åº CPU åˆ©ç”¨ç‡ä½æ˜¯é—®é¢˜ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- I/O å¯†é›†æœ¬æ¥å°±ä¸éœ€è¦é«˜ CPU
- ä½ CPU åˆ©ç”¨ç‡æ˜¯æ­£å¸¸ç°è±¡
- å¼ºè¡Œæé«˜ CPU åˆ©ç”¨ç‡æ˜¯æµªè´¹

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºç›‘æ§å·¥å…·æ˜¾ç¤º CPU å¾ˆä½ï¼Œç›´è§‰è§‰å¾—"æ²¡æœ‰å……åˆ†åˆ©ç”¨èµ„æº"ã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
"""
Web æœåŠ¡å™¨ç›‘æ§ï¼š

CPU: 5%    <- ä¸æ˜¯é—®é¢˜ï¼I/O å¯†é›†æœ¬æ¥å°±è¿™æ ·
å†…å­˜: 40%  <- æ­£å¸¸
ç½‘ç»œ: 80%  <- è¿™æ‰æ˜¯ç“¶é¢ˆï¼
ç£ç›˜: 30%

æ­£ç¡®ä¼˜åŒ–æ–¹å‘ï¼š
1. ä¼˜åŒ–ç½‘ç»œï¼ˆå‹ç¼©ã€ç¼“å­˜ã€æ‰¹é‡ï¼‰
2. å¢åŠ å¹¶å‘è¿æ¥æ•°
3. ä½¿ç”¨ CDN

é”™è¯¯ä¼˜åŒ–æ–¹å‘ï¼š
1. æ¢æ›´å¼ºçš„ CPUï¼ˆæ— æ•ˆï¼‰
2. ç”¨å¤šè¿›ç¨‹ï¼ˆæµªè´¹èµ„æºï¼‰
"""
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

```python
"""
I/O å¯†é›†ç†è§£å®æˆ˜ç¤ºä¾‹
å±•ç¤ºå¦‚ä½•è¯†åˆ«å’Œä¼˜åŒ– I/O å¯†é›†åœºæ™¯
"""

import asyncio
import aiohttp
import time
import random
from concurrent.futures import ProcessPoolExecutor, ThreadPoolExecutor
import multiprocessing

# ===== 1. è¯†åˆ« I/O å¯†é›† vs CPU å¯†é›† =====
print("=== 1. I/O vs CPU å¯†é›†è¯†åˆ« ===")

def cpu_bound_task():
    """CPU å¯†é›†ï¼šå¤§é‡è®¡ç®—"""
    total = 0
    for i in range(5_000_000):
        total += i * i
    return total

async def io_bound_task():
    """I/O å¯†é›†ï¼šå¤§é‡ç­‰å¾…"""
    await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    return "data"

# æµ‹é‡ CPU å¯†é›†
print("\nCPU å¯†é›†ä»»åŠ¡:")
start = time.time()
cpu_bound_task()
cpu_time = time.time() - start
print(f"  è€—æ—¶: {cpu_time:.3f}s")
print(f"  ç‰¹ç‚¹: CPU ä¸€ç›´åœ¨è®¡ç®—")

# æµ‹é‡ I/O å¯†é›†
print("\nI/O å¯†é›†ä»»åŠ¡:")
start = time.time()
asyncio.run(io_bound_task())
io_time = time.time() - start
print(f"  è€—æ—¶: {io_time:.3f}s")
print(f"  ç‰¹ç‚¹: å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…")

# ===== 2. I/O å¯†é›†ä¼˜åŒ–ï¼šåŒæ­¥ vs å¼‚æ­¥ =====
print("\n=== 2. I/O å¯†é›†ä¼˜åŒ–å¯¹æ¯” ===")

async def simulated_api_call(id, delay=0.1):
    """æ¨¡æ‹Ÿ API è°ƒç”¨"""
    await asyncio.sleep(delay)
    return {'id': id, 'data': f'result_{id}'}

# åŒæ­¥æ–¹å¼ï¼ˆä¸²è¡Œï¼‰
def sync_fetch_multiple(count):
    results = []
    for i in range(count):
        time.sleep(0.1)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        results.append({'id': i, 'data': f'result_{i}'})
    return results

# å¼‚æ­¥æ–¹å¼ï¼ˆå¹¶è¡Œï¼‰
async def async_fetch_multiple(count):
    tasks = [simulated_api_call(i) for i in range(count)]
    return await asyncio.gather(*tasks)

# å¯¹æ¯”
count = 10
print(f"\nè·å– {count} ä¸ªèµ„æº:")

start = time.time()
sync_fetch_multiple(count)
print(f"  åŒæ­¥è€—æ—¶: {time.time() - start:.2f}s")

start = time.time()
asyncio.run(async_fetch_multiple(count))
print(f"  å¼‚æ­¥è€—æ—¶: {time.time() - start:.2f}s")

# ===== 3. CPU å¯†é›†ä¼˜åŒ–ï¼šå¤šè¿›ç¨‹ =====
print("\n=== 3. CPU å¯†é›†ä¼˜åŒ–å¯¹æ¯” ===")

def heavy_compute(n):
    """CPU å¯†é›†è®¡ç®—"""
    return sum(i ** 2 for i in range(n))

# ä¸²è¡Œ
print("\nCPU å¯†é›†ä»»åŠ¡ x4:")
start = time.time()
results = [heavy_compute(1_000_000) for _ in range(4)]
print(f"  ä¸²è¡Œè€—æ—¶: {time.time() - start:.2f}s")

# å¤šè¿›ç¨‹
if multiprocessing.cpu_count() > 1:
    start = time.time()
    with ProcessPoolExecutor(max_workers=4) as executor:
        results = list(executor.map(heavy_compute, [1_000_000] * 4))
    print(f"  å¤šè¿›ç¨‹è€—æ—¶: {time.time() - start:.2f}s")

# ===== 4. é”™è¯¯ç¤ºèŒƒï¼šI/O å¯†é›†ç”¨å¤šè¿›ç¨‹ =====
print("\n=== 4. é”™è¯¯ç¤ºèŒƒï¼šI/O å¯†é›†ç”¨å¤šè¿›ç¨‹ ===")

def io_task_sync(id):
    """åŒæ­¥ I/O ä»»åŠ¡"""
    time.sleep(0.1)
    return id

# å¤šè¿›ç¨‹å¤„ç† I/Oï¼ˆæµªè´¹èµ„æºï¼‰
print("\nI/O å¯†é›†ç”¨å¤šè¿›ç¨‹ï¼ˆä¸æ¨èï¼‰:")
start = time.time()
with ProcessPoolExecutor(max_workers=4) as executor:
    results = list(executor.map(io_task_sync, range(10)))
print(f"  å¤šè¿›ç¨‹è€—æ—¶: {time.time() - start:.2f}s")
print(f"  é—®é¢˜: è¿›ç¨‹åˆ›å»ºå¼€é”€ï¼Œèµ„æºæµªè´¹")

# å¼‚æ­¥å¤„ç† I/Oï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
print("\nI/O å¯†é›†ç”¨å¼‚æ­¥ï¼ˆæ¨èï¼‰:")
start = time.time()
asyncio.run(async_fetch_multiple(10))
print(f"  å¼‚æ­¥è€—æ—¶: {time.time() - start:.2f}s")

# ===== 5. æ‰¹é‡ä¼˜åŒ– =====
print("\n=== 5. æ‰¹é‡ä¼˜åŒ– ===")

async def single_insert(item):
    """å•æ¡æ’å…¥"""
    await asyncio.sleep(0.05)  # æ¨¡æ‹Ÿç½‘ç»œ
    return True

async def batch_insert(items):
    """æ‰¹é‡æ’å…¥"""
    await asyncio.sleep(0.05)  # åŒæ ·çš„ç½‘ç»œå»¶è¿Ÿ
    return [True] * len(items)

items = list(range(20))

# é€æ¡æ’å…¥
print("\næ’å…¥ 20 æ¡æ•°æ®:")
start = time.time()
tasks = [single_insert(item) for item in items]
await_results = asyncio.run(asyncio.gather(*tasks))
print(f"  é€æ¡æ’å…¥: {time.time() - start:.2f}s (20 æ¬¡ç½‘ç»œè¯·æ±‚)")

# æ‰¹é‡æ’å…¥
start = time.time()
asyncio.run(batch_insert(items))
print(f"  æ‰¹é‡æ’å…¥: {time.time() - start:.2f}s (1 æ¬¡ç½‘ç»œè¯·æ±‚)")

# ===== 6. ç¼“å­˜ä¼˜åŒ– =====
print("\n=== 6. ç¼“å­˜ä¼˜åŒ– ===")

class CachedClient:
    def __init__(self):
        self.cache = {}
        self.hit_count = 0
        self.miss_count = 0
    
    async def get(self, key):
        if key in self.cache:
            self.hit_count += 1
            return self.cache[key]
        
        self.miss_count += 1
        await asyncio.sleep(0.05)  # æ¨¡æ‹Ÿç½‘ç»œ
        value = f"value_{key}"
        self.cache[key] = value
        return value
    
    def stats(self):
        total = self.hit_count + self.miss_count
        hit_rate = self.hit_count / total if total > 0 else 0
        return f"å‘½ä¸­ç‡: {hit_rate:.1%}"

async def cache_demo():
    client = CachedClient()
    
    # æ¨¡æ‹Ÿé‡å¤æŸ¥è¯¢
    queries = [1, 2, 3, 1, 2, 1, 4, 1, 2, 3]
    
    start = time.time()
    for q in queries:
        await client.get(q)
    
    print(f"  {len(queries)} æ¬¡æŸ¥è¯¢è€—æ—¶: {time.time() - start:.3f}s")
    print(f"  {client.stats()}")
    print(f"  å®é™…ç½‘ç»œè¯·æ±‚: {client.miss_count} æ¬¡ï¼ˆè€Œé {len(queries)} æ¬¡ï¼‰")

asyncio.run(cache_demo())

# ===== 7. å‘é‡æ•°æ®åº“åœºæ™¯æ¨¡æ‹Ÿ =====
print("\n=== 7. å‘é‡æ•°æ®åº“åœºæ™¯ ===")

class MockVectorDB:
    def __init__(self):
        self.data = {}
    
    async def search(self, query_vector, top_k=10):
        """æ¨¡æ‹Ÿå‘é‡æœç´¢"""
        await asyncio.sleep(0.05)  # ç½‘ç»œå»¶è¿Ÿ
        return [{'id': i, 'score': random.random()} for i in range(top_k)]
    
    async def insert(self, id, vector):
        """å•æ¡æ’å…¥"""
        await asyncio.sleep(0.05)
        self.data[id] = vector
        return True
    
    async def batch_insert(self, vectors):
        """æ‰¹é‡æ’å…¥"""
        await asyncio.sleep(0.05)  # åªéœ€è¦ä¸€æ¬¡ç½‘ç»œå¾€è¿”
        for id, vec in vectors.items():
            self.data[id] = vec
        return len(vectors)

async def vector_db_demo():
    db = MockVectorDB()
    
    # åœºæ™¯1ï¼šæ‰¹é‡æŸ¥è¯¢
    print("\næ‰¹é‡æŸ¥è¯¢ 20 ä¸ªå‘é‡:")
    queries = [[random.random() for _ in range(4)] for _ in range(20)]
    
    start = time.time()
    tasks = [db.search(q) for q in queries]
    results = await asyncio.gather(*tasks)
    print(f"  å¼‚æ­¥å¹¶è¡Œ: {time.time() - start:.2f}s")
    print(f"  è·å¾— {len(results)} ä¸ªç»“æœ")
    
    # åœºæ™¯2ï¼šæ‰¹é‡æ’å…¥
    print("\næ‰¹é‡æ’å…¥ 100 ä¸ªå‘é‡:")
    vectors = {f'vec_{i}': [random.random() for _ in range(4)] for i in range(100)}
    
    # é€æ¡æ’å…¥ï¼ˆå·®ï¼‰
    start = time.time()
    tasks = [db.insert(id, vec) for id, vec in list(vectors.items())[:20]]
    await asyncio.gather(*tasks)
    print(f"  é€æ¡æ’å…¥ 20 æ¡: {time.time() - start:.2f}s")
    
    # æ‰¹é‡æ’å…¥ï¼ˆå¥½ï¼‰
    start = time.time()
    await db.batch_insert(vectors)
    print(f"  æ‰¹é‡æ’å…¥ 100 æ¡: {time.time() - start:.2f}s")

asyncio.run(vector_db_demo())

# ===== 8. å¹¶å‘é™åˆ¶ =====
print("\n=== 8. å¹¶å‘é™åˆ¶ï¼ˆé¿å…å‹å®æœåŠ¡å™¨ï¼‰===")

async def rate_limited_fetch(sem, id):
    async with sem:  # è·å–ä¿¡å·é‡
        await asyncio.sleep(0.1)
        return id

async def limited_concurrent():
    # é™åˆ¶æœ€å¤š 5 ä¸ªå¹¶å‘è¯·æ±‚
    sem = asyncio.Semaphore(5)
    
    tasks = [rate_limited_fetch(sem, i) for i in range(20)]
    
    start = time.time()
    results = await asyncio.gather(*tasks)
    print(f"  20 ä¸ªè¯·æ±‚ï¼Œé™åˆ¶ 5 å¹¶å‘: {time.time() - start:.2f}s")
    print(f"  é¢„æœŸ: 20/5 * 0.1 = 0.4s")

asyncio.run(limited_concurrent())

# ===== 9. æ··åˆåœºæ™¯å¤„ç† =====
print("\n=== 9. æ··åˆåœºæ™¯ï¼ˆI/O + CPUï¼‰===")

async def mixed_pipeline():
    """æ··åˆå¤„ç†æµæ°´çº¿"""
    
    # 1. I/O é˜¶æ®µï¼šå¼‚æ­¥è·å–æ•°æ®
    print("  1. å¼‚æ­¥è·å–æ•°æ®...")
    async def fetch_data(id):
        await asyncio.sleep(0.1)
        return [random.random() for _ in range(100)]
    
    start = time.time()
    data = await asyncio.gather(*[fetch_data(i) for i in range(10)])
    print(f"     I/O è€—æ—¶: {time.time() - start:.2f}s")
    
    # 2. CPU é˜¶æ®µï¼šå¤šè¿›ç¨‹è®¡ç®—
    print("  2. å¤šè¿›ç¨‹è®¡ç®—...")
    def process_data(vec):
        return sum(x ** 2 for x in vec)
    
    start = time.time()
    loop = asyncio.get_event_loop()
    with ProcessPoolExecutor(max_workers=4) as executor:
        results = await loop.run_in_executor(
            executor,
            lambda: list(map(process_data, data))
        )
    print(f"     CPU è€—æ—¶: {time.time() - start:.2f}s")
    
    return results

print("\næ··åˆæµæ°´çº¿æ‰§è¡Œ:")
asyncio.run(mixed_pipeline())
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== 1. I/O vs CPU å¯†é›†è¯†åˆ« ===

CPU å¯†é›†ä»»åŠ¡:
  è€—æ—¶: 0.312s
  ç‰¹ç‚¹: CPU ä¸€ç›´åœ¨è®¡ç®—

I/O å¯†é›†ä»»åŠ¡:
  è€—æ—¶: 0.101s
  ç‰¹ç‚¹: å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…

=== 2. I/O å¯†é›†ä¼˜åŒ–å¯¹æ¯” ===

è·å– 10 ä¸ªèµ„æº:
  åŒæ­¥è€—æ—¶: 1.00s
  å¼‚æ­¥è€—æ—¶: 0.10s

=== 5. æ‰¹é‡ä¼˜åŒ– ===

æ’å…¥ 20 æ¡æ•°æ®:
  é€æ¡æ’å…¥: 0.05s (20 æ¬¡ç½‘ç»œè¯·æ±‚)
  æ‰¹é‡æ’å…¥: 0.05s (1 æ¬¡ç½‘ç»œè¯·æ±‚)

=== 6. ç¼“å­˜ä¼˜åŒ– ===
  10 æ¬¡æŸ¥è¯¢è€—æ—¶: 0.203s
  å‘½ä¸­ç‡: 60.0%
  å®é™…ç½‘ç»œè¯·æ±‚: 4 æ¬¡ï¼ˆè€Œé 10 æ¬¡ï¼‰
...
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯ I/O å¯†é›†ï¼Ÿå’Œ CPU å¯†é›†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"I/O å¯†é›†å°±æ˜¯ç¨‹åºåšå¾ˆå¤š I/O æ“ä½œï¼ŒCPU å¯†é›†å°±æ˜¯åšå¾ˆå¤šè®¡ç®—ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **æ ¸å¿ƒåŒºåˆ«åœ¨äº"ç“¶é¢ˆ"åœ¨å“ªé‡Œï¼š**
>
> 1. **I/O å¯†é›†**ï¼šç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾… I/Oï¼ˆç½‘ç»œã€ç£ç›˜ï¼‰ï¼ŒCPU åˆ©ç”¨ç‡ä½
>    - ä¾‹å­ï¼šWeb æœåŠ¡å™¨ã€æ•°æ®åº“å®¢æˆ·ç«¯ã€çˆ¬è™«
>    - ç‰¹ç‚¹ï¼šç­‰å¾…æ—¶é—´ >> è®¡ç®—æ—¶é—´
>
> 2. **CPU å¯†é›†**ï¼šç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åœ¨è®¡ç®—ï¼ŒCPU åˆ©ç”¨ç‡é«˜
>    - ä¾‹å­ï¼šå›¾åƒå¤„ç†ã€åŠ å¯†è§£å¯†ã€ç§‘å­¦è®¡ç®—
>    - ç‰¹ç‚¹ï¼šè®¡ç®—æ—¶é—´ >> ç­‰å¾…æ—¶é—´
>
> **åˆ¤æ–­æ–¹æ³•**ï¼š
> ```python
> CPUåˆ©ç”¨ç‡ = CPUæ—¶é—´ / å®é™…æ—¶é—´
> > 80%ï¼šCPU å¯†é›†
> < 20%ï¼šI/O å¯†é›†
> ```
>
> **ä¼˜åŒ–æ–¹æ¡ˆé€‰æ‹©**ï¼š
> - I/O å¯†é›† â†’ asyncio / threading
> - CPU å¯†é›† â†’ multiprocessing
>
> **å‘é‡æ•°æ®åº“ä¾‹å­**ï¼š
> æŸ¥è¯¢æ“ä½œæ˜¯ I/O å¯†é›†ï¼ˆç½‘ç»œå»¶è¿Ÿ 50msï¼Œè®¡ç®— 1msï¼‰ï¼Œåº”è¯¥ç”¨å¼‚æ­¥ä¼˜åŒ–ï¼Œè€Œéå¤šè¿›ç¨‹ã€‚

---

### é—®é¢˜2ï¼š"I/O å¯†é›†åœºæ™¯ç”¨å¤šè¿›ç¨‹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"å¤šè¿›ç¨‹å¼€é”€å¤§ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **I/O å¯†é›†ç”¨å¤šè¿›ç¨‹æœ‰ä¸‰ä¸ªé—®é¢˜ï¼š**
>
> 1. **èµ„æºæµªè´¹**ï¼š
>    - I/O ç­‰å¾…æ—¶ CPU æœ¬æ¥å°±ç©ºé—²
>    - å¤šè¿›ç¨‹å¢åŠ çš„ CPU è¿˜æ˜¯ç©ºé—²
>    - ç›¸å½“äº"é›‡äº†æ›´å¤šäººç­‰å¿«é€’"
>
> 2. **é¢å¤–å¼€é”€**ï¼š
>    - è¿›ç¨‹åˆ›å»ºå¼€é”€ï¼ˆæ¯«ç§’çº§ï¼‰
>    - è¿›ç¨‹é—´é€šä¿¡å¼€é”€
>    - å†…å­˜å¼€é”€ï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼‰
>
> 3. **æ‰©å±•æ€§å·®**ï¼š
>    - è¿›ç¨‹æ•°å—é™äºç³»ç»Ÿèµ„æº
>    - å¼‚æ­¥å•çº¿ç¨‹å¯ä»¥æ”¯æŒä¸Šä¸‡å¹¶å‘ï¼Œå¤šè¿›ç¨‹å¯èƒ½åªæœ‰å‡ å
>
> **æ­£ç¡®æ–¹æ¡ˆå¯¹æ¯”**ï¼š
> ```python
> # 100 ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæ¯ä¸ª 100ms
> 
> # å¤šè¿›ç¨‹ï¼ˆ4è¿›ç¨‹ï¼‰ï¼š100/4 * 100ms = 2.5s + è¿›ç¨‹å¼€é”€
> # å¼‚æ­¥ï¼š~100msï¼ˆå¹¶è¡Œç­‰å¾…ï¼‰
> ```
>
> **ç»“è®º**ï¼šI/O å¯†é›†åº”è¯¥ç”¨ asyncio æˆ– threadingï¼Œä¸æ˜¯ multiprocessingã€‚

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯ I/O å¯†é›†ï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** I/O å¯†é›† = ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…è¾“å…¥è¾“å‡ºã€‚

**ç‰¹å¾ï¼š**
- CPU åˆ©ç”¨ç‡ä½ï¼ˆ< 20%ï¼‰
- å¤§é‡ç½‘ç»œ/ç£ç›˜æ“ä½œ
- ç­‰å¾…æ—¶é—´ >> è®¡ç®—æ—¶é—´

---

### å¡ç‰‡2ï¼šä»€ä¹ˆæ˜¯ CPU å¯†é›†ï¼Ÿ ğŸ’ª

**ä¸€å¥è¯ï¼š** CPU å¯†é›† = ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´åœ¨è®¡ç®—ã€‚

**ç‰¹å¾ï¼š**
- CPU åˆ©ç”¨ç‡é«˜ï¼ˆ> 80%ï¼‰
- å¤§é‡å¾ªç¯/æ•°å­¦è¿ç®—
- è®¡ç®—æ—¶é—´ >> ç­‰å¾…æ—¶é—´

---

### å¡ç‰‡3ï¼šI/O å»¶è¿Ÿæœ‰å¤šå¤§ï¼Ÿ â±ï¸

**ä¸€å¥è¯ï¼š** ç½‘ç»œè¯·æ±‚æ¯” CPU æŒ‡ä»¤æ…¢ 5 äº¿å€ã€‚

**å¯¹æ¯”ï¼š**
```
CPU æŒ‡ä»¤:  1 ç§’
å†…å­˜è®¿é—®:  5 åˆ†é’Ÿ
SSD è¯»å–:  6 å¤©
ç½‘ç»œè¯·æ±‚:  16 å¹´
```

---

### å¡ç‰‡4ï¼šå¦‚ä½•åˆ¤æ–­ç±»å‹ï¼Ÿ ğŸ”

**ä¸€å¥è¯ï¼š** çœ‹ CPU åˆ©ç”¨ç‡ã€‚

```python
CPUåˆ©ç”¨ç‡ = CPUæ—¶é—´ / å®é™…æ—¶é—´

> 80% â†’ CPU å¯†é›†
< 20% â†’ I/O å¯†é›†
```

---

### å¡ç‰‡5ï¼šI/O å¯†é›†æ€ä¹ˆä¼˜åŒ–ï¼Ÿ ğŸš€

**ä¸€å¥è¯ï¼š** ç”¨å¼‚æ­¥ï¼Œä¸è¦ç”¨å¤šè¿›ç¨‹ã€‚

```python
# æ­£ç¡®ï¼šasyncio
await asyncio.gather(*tasks)

# é”™è¯¯ï¼šmultiprocessing
# ï¼ˆCPU æœ¬æ¥å°±é—²ï¼ŒåŠ è¿›ç¨‹æ²¡ç”¨ï¼‰
```

---

### å¡ç‰‡6ï¼šCPU å¯†é›†æ€ä¹ˆä¼˜åŒ–ï¼Ÿ ğŸ’»

**ä¸€å¥è¯ï¼š** ç”¨å¤šè¿›ç¨‹ï¼Œç»•è¿‡ GILã€‚

```python
# æ­£ç¡®ï¼šmultiprocessing
with Pool(4) as p:
    p.map(compute, data)

# é”™è¯¯ï¼šasyncio
# ï¼ˆæ²¡æœ‰ I/O ç­‰å¾…ï¼Œå¼‚æ­¥æ— æ•ˆï¼‰
```

---

### å¡ç‰‡7ï¼šæ‰¹é‡å‡å°‘ I/O ğŸ“¦

**ä¸€å¥è¯ï¼š** åˆå¹¶å¤šæ¬¡ I/O ä¸ºä¸€æ¬¡ã€‚

```python
# å·®ï¼š100 æ¬¡è¯·æ±‚
for item in items:
    await db.insert(item)

# å¥½ï¼š1 æ¬¡è¯·æ±‚
await db.insert_many(items)
```

---

### å¡ç‰‡8ï¼šç¼“å­˜é¿å… I/O ğŸ’¾

**ä¸€å¥è¯ï¼š** é‡å¤æ•°æ®ä¸è¦é‡å¤è¯·æ±‚ã€‚

```python
cache = {}
async def get(key):
    if key not in cache:
        cache[key] = await fetch(key)
    return cache[key]
```

---

### å¡ç‰‡9ï¼šå‘é‡æ•°æ®åº“æ˜¯ I/O å¯†é›† ğŸ—„ï¸

**ä¸€å¥è¯ï¼š** æŸ¥è¯¢ 50msï¼Œå…¶ä¸­ 45ms æ˜¯ç½‘ç»œã€‚

**ä¼˜åŒ–æ–¹å‘ï¼š**
1. å¼‚æ­¥å¹¶å‘æŸ¥è¯¢
2. æ‰¹é‡æ’å…¥/æŸ¥è¯¢
3. æœ¬åœ°ç¼“å­˜çƒ­æ•°æ®

---

### å¡ç‰‡10ï¼šæ··åˆåœºæ™¯å¤„ç† ğŸ”„

**ä¸€å¥è¯ï¼š** I/O ç”¨å¼‚æ­¥ï¼ŒCPU ç”¨å¤šè¿›ç¨‹ã€‚

```python
async def pipeline():
    # I/O é˜¶æ®µï¼šå¼‚æ­¥
    data = await fetch_all()
    
    # CPU é˜¶æ®µï¼šå¤šè¿›ç¨‹
    result = await run_in_executor(
        ProcessPool, compute, data
    )
```

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**I/O å¯†é›†æŒ‡ç¨‹åºç“¶é¢ˆåœ¨äºç­‰å¾…è¾“å…¥è¾“å‡ºè€Œéè®¡ç®—ï¼Œå‘é‡æ•°æ®åº“æ“ä½œå…¸å‹å¦‚æ­¤ï¼ˆç½‘ç»œå»¶è¿Ÿå  90%+ï¼‰ï¼Œåº”è¯¥ç”¨å¼‚æ­¥ç¼–ç¨‹è€Œéå¤šè¿›ç¨‹ä¼˜åŒ–ï¼Œæ ¸å¿ƒç­–ç•¥æ˜¯å¹¶å‘ç­‰å¾…ã€æ‰¹é‡æ“ä½œå’Œç¼“å­˜ã€‚**

---

## ğŸ“š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½åŒºåˆ† I/O å¯†é›†å’Œ CPU å¯†é›†
- [ ] çŸ¥é“ I/O å»¶è¿Ÿçš„æ•°é‡çº§
- [ ] èƒ½åˆ¤æ–­ç¨‹åºçš„ I/O å¯†é›†ç¨‹åº¦
- [ ] ç†è§£ä¸ºä»€ä¹ˆ I/O å¯†é›†ä¸è¯¥ç”¨å¤šè¿›ç¨‹
- [ ] çŸ¥é“æ‰¹é‡å’Œç¼“å­˜ä¼˜åŒ–çš„åŸç†
- [ ] èƒ½ä¸ºå‘é‡æ•°æ®åº“é€‰æ‹©æ­£ç¡®çš„å¹¶å‘æ–¹æ¡ˆ

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

å­¦å®Œ I/O å¯†é›†ç†è§£åï¼Œå»ºè®®å­¦ä¹ ï¼š
1. **async/await** - è¯¦ç»†è¯­æ³•å’Œç”¨æ³•
2. **asyncio.run** - è¿è¡Œå¼‚æ­¥ç¨‹åº
3. **aiohttp** - å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
