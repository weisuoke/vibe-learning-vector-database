# é—­åŒ… (Closure)

## 1. ã€30å­—æ ¸å¿ƒã€‘

**é—­åŒ…æ˜¯èƒ½å¤Ÿè®°ä½å¹¶è®¿é—®å…¶åˆ›å»ºæ—¶æ‰€åœ¨ä½œç”¨åŸŸå˜é‡çš„å‡½æ•°ï¼Œæ˜¯å®ç°çŠ¶æ€ä¿æŒå’Œæ•°æ®å°è£…çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### é—­åŒ…çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**é—­åŒ… = å‡½æ•° + å‡½æ•°åˆ›å»ºæ—¶çš„ç¯å¢ƒï¼ˆå˜é‡ï¼‰**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœå®ƒèƒ½"è®°ä½"è‡ªå·±è¢«åˆ›å»ºæ—¶å‘¨å›´çš„å˜é‡ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªé—­åŒ…ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦é—­åŒ…ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå®ƒçš„å±€éƒ¨å˜é‡å°±ä¼šè¢«é”€æ¯ã€‚ä½†æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›æŸäº›å˜é‡èƒ½å¤Ÿ"æ´»"å¾—æ›´ä¹…ã€‚**

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š
- ä½ å†™äº†ä¸€ä¸ªè®¡æ•°å™¨å‡½æ•°
- æ¯æ¬¡è°ƒç”¨å®ƒï¼Œè®¡æ•°å™¨åŠ 1
- é—®é¢˜ï¼šè®¡æ•°å€¼å­˜åœ¨å“ªé‡Œï¼Ÿ

```python
# æ²¡æœ‰é—­åŒ…çš„å›°å¢ƒ
count = 0  # è¢«è¿«ä½¿ç”¨å…¨å±€å˜é‡

def increment():
    global count
    count += 1
    return count

# é—®é¢˜ï¼šå…¨å±€å˜é‡å®¹æ˜“è¢«æ„å¤–ä¿®æ”¹ï¼Œä¸å®‰å…¨
```

#### 3. é—­åŒ…çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šçŠ¶æ€ä¿æŒ
é—­åŒ…è®©å‡½æ•°èƒ½å¤Ÿ"è®°ä½"çŠ¶æ€ï¼Œè€Œä¸æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸã€‚

```python
def make_counter():
    count = 0  # è¿™ä¸ªå˜é‡è¢«"å°é—­"åœ¨é—­åŒ…ä¸­
    def increment():
        nonlocal count
        count += 1
        return count
    return increment

counter = make_counter()
print(counter())  # 1
print(counter())  # 2 - çŠ¶æ€è¢«ä¿æŒäº†ï¼
```

##### ä»·å€¼2ï¼šæ•°æ®å°è£…
é—­åŒ…æä¾›äº†ä¸€ç§"ç§æœ‰å˜é‡"çš„å®ç°æ–¹å¼ã€‚

```python
def create_account(initial_balance):
    balance = initial_balance  # å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®
    
    def deposit(amount):
        nonlocal balance
        balance += amount
        return balance
    
    def get_balance():
        return balance
    
    return deposit, get_balance
```

##### ä»·å€¼3ï¼šå‡½æ•°å·¥å‚
é—­åŒ…å¯ä»¥åˆ›å»ºå…·æœ‰ä¸åŒé…ç½®çš„å‡½æ•°ã€‚

```python
def make_multiplier(factor):
    def multiply(x):
        return x * factor
    return multiply

double = make_multiplier(2)
triple = make_multiplier(3)

print(double(5))  # 10
print(triple(5))  # 15
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼å‘é‡æ•°æ®åº“åº”ç”¨

**æ¨ç†é“¾ï¼š**
```
1. å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯éœ€è¦ä¿æŒè¿æ¥é…ç½®
   â†“
2. æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å¤ç”¨è¿™äº›é…ç½®
   â†“
3. é—­åŒ…å¯ä»¥"è®°ä½"é…ç½®ï¼Œåˆ›å»ºé¢„é…ç½®çš„æŸ¥è¯¢å‡½æ•°
   â†“
4. åº”ç”¨ï¼šåˆ›å»ºå¸¦æœ‰ç‰¹å®šå‚æ•°ï¼ˆå¦‚top_kã€è·ç¦»é˜ˆå€¼ï¼‰çš„æœç´¢å‡½æ•°
```

```python
def create_vector_searcher(collection, top_k=10, threshold=0.8):
    """åˆ›å»ºä¸€ä¸ªé¢„é…ç½®çš„å‘é‡æœç´¢å‡½æ•°"""
    def search(query_vector):
        # collection, top_k, threshold è¢«é—­åŒ…"è®°ä½"
        results = collection.search(
            query_vector,
            limit=top_k,
            score_threshold=threshold
        )
        return results
    return search

# ä½¿ç”¨
fast_search = create_vector_searcher(my_collection, top_k=5)
precise_search = create_vector_searcher(my_collection, top_k=100, threshold=0.95)
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**é—­åŒ…æ˜¯å‡½æ•°æºå¸¦å…¶è¯ç”Ÿç¯å¢ƒçš„èƒ½åŠ›ï¼Œè®©å‡½æ•°å¯ä»¥"è®°ä½"è¿‡å»ï¼Œä»è€Œå®ç°çŠ¶æ€ä¿æŒå’Œæ•°æ®å°è£…ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šè‡ªç”±å˜é‡ (Free Variable) ğŸ”¢

**è‡ªç”±å˜é‡æ˜¯æŒ‡åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼Œä½†æ—¢ä¸æ˜¯å‡½æ•°å‚æ•°ä¹Ÿä¸æ˜¯å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ã€‚**

```python
def outer():
    x = 10  # è¿™æ˜¯ inner çš„è‡ªç”±å˜é‡
    
    def inner():
        print(x)  # x åœ¨è¿™é‡Œè¢«ä½¿ç”¨ï¼Œä½†ä¸æ˜¯ inner å®šä¹‰çš„
    
    return inner

closure = outer()
print(closure.__code__.co_freevars)  # ('x',) - æŸ¥çœ‹è‡ªç”±å˜é‡
```

**è¯¦ç»†è§£é‡Šï¼š**
- è‡ªç”±å˜é‡æ˜¯é—­åŒ…çš„"è®°å¿†"å†…å®¹
- Python ä¼šæŠŠè‡ªç”±å˜é‡å­˜å‚¨åœ¨å‡½æ•°çš„ `__closure__` å±æ€§ä¸­
- è¿™äº›å˜é‡å³ä½¿å¤–å±‚å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿä¸ä¼šè¢«é”€æ¯

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**
æŸ¥è¯¢å‡½æ•°"è®°ä½"è¿æ¥å¯¹è±¡ã€ç´¢å¼•åç§°ç­‰é…ç½®ä¿¡æ¯ã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šnonlocal å…³é”®å­— ğŸ“

**nonlocal å£°æ˜ä¸€ä¸ªå˜é‡ä¸æ˜¯å±€éƒ¨å˜é‡ï¼Œè€Œæ˜¯è¦å¼•ç”¨å¤–å±‚å‡½æ•°çš„å˜é‡ã€‚**

```python
def counter():
    count = 0
    
    def increment():
        nonlocal count  # å£°æ˜ count æ¥è‡ªå¤–å±‚
        count += 1      # ç°åœ¨å¯ä»¥ä¿®æ”¹å®ƒäº†
        return count
    
    return increment

c = counter()
print(c())  # 1
print(c())  # 2
```

**è¯¦ç»†è§£é‡Šï¼š**
- æ²¡æœ‰ `nonlocal`ï¼ŒPython ä¼šè®¤ä¸ºä½ åœ¨åˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡
- `nonlocal` è®©ä½ å¯ä»¥ä¿®æ”¹å¤–å±‚å‡½æ•°çš„å˜é‡
- è¿™æ˜¯å®ç°"å¯å˜çŠ¶æ€"é—­åŒ…çš„å…³é”®

**å¯¹æ¯”ï¼š**
```python
# é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰ nonlocal
def broken_counter():
    count = 0
    def increment():
        count = count + 1  # UnboundLocalError!
        return count
    return increment
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šé—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸ â³

**é—­åŒ…çš„è‡ªç”±å˜é‡ä¼šä¸€ç›´å­˜æ´»ï¼Œç›´åˆ°é—­åŒ…æœ¬èº«è¢«é”€æ¯ã€‚**

```python
def create_closure():
    large_data = [1] * 1000000  # 1ç™¾ä¸‡ä¸ªå…ƒç´ 
    
    def closure():
        return len(large_data)
    
    return closure

# large_data ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œå› ä¸º closure è¿˜åœ¨å¼•ç”¨å®ƒ
c = create_closure()
print(c())  # 1000000

# åªæœ‰å½“ c è¢«åˆ é™¤åï¼Œlarge_data æ‰ä¼šè¢«å›æ”¶
del c
```

**è¯¦ç»†è§£é‡Šï¼š**
- é—­åŒ…ä¼šå»¶é•¿è‡ªç”±å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ
- è¿™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆå¦‚æœé—­åŒ…å¼•ç”¨äº†å¤§å¯¹è±¡ï¼‰
- éœ€è¦æ³¨æ„é—­åŒ…çš„ä½¿ç”¨åœºæ™¯

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**
åˆ›å»ºæ‰¹é‡æ“ä½œçš„é—­åŒ…æ—¶ï¼Œæ³¨æ„ä¸è¦æ„å¤–ä¿ç•™å¤§é‡æ•°æ®ï¼š

```python
def create_batch_inserter(collection):
    # å¥½çš„åšæ³•ï¼šåªä¿ç•™å¿…è¦çš„å¼•ç”¨
    def insert(vectors):
        collection.insert(vectors)
    return insert
    
    # ä¸å¥½çš„åšæ³•ï¼šåœ¨é—­åŒ…ä¸­ç´¯ç§¯æ•°æ®
    # accumulated = []
    # def insert(vector):
    #     accumulated.append(vector)  # å†…å­˜ä¼šæŒç»­å¢é•¿
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½åœ¨80%çš„åœºæ™¯ä¸­ä½¿ç”¨é—­åŒ…ï¼š

### 4.1 åˆ›å»ºåŸºæœ¬é—­åŒ…

```python
def outer(x):
    def inner(y):
        return x + y  # inner è®°ä½äº† x
    return inner

add_5 = outer(5)
print(add_5(3))  # 8
```

### 4.2 ä½¿ç”¨ nonlocal ä¿®æ”¹çŠ¶æ€

```python
def make_counter(start=0):
    count = start
    def increment():
        nonlocal count
        count += 1
        return count
    return increment

counter = make_counter()
print(counter(), counter(), counter())  # 1 2 3
```

### 4.3 åˆ›å»ºå‡½æ•°å·¥å‚

```python
def make_validator(min_val, max_val):
    def validate(value):
        return min_val <= value <= max_val
    return validate

is_valid_score = make_validator(0, 100)
print(is_valid_score(85))   # True
print(is_valid_score(150))  # False
```

### 4.4 ç»“åˆå‘é‡æ•°æ®åº“ä½¿ç”¨

```python
def create_similarity_filter(threshold):
    """åˆ›å»ºä¸€ä¸ªç›¸ä¼¼åº¦è¿‡æ»¤å™¨"""
    def filter_results(results):
        return [r for r in results if r['score'] >= threshold]
    return filter_results

high_quality_filter = create_similarity_filter(0.9)
results = [{'id': 1, 'score': 0.95}, {'id': 2, 'score': 0.7}]
print(high_quality_filter(results))  # [{'id': 1, 'score': 0.95}]
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- åˆ›å»ºå¸¦è®°å¿†çš„å‡½æ•°
- å®ç°ç®€å•çš„çŠ¶æ€ç®¡ç†
- ä¸ºå‘é‡æ•°æ®åº“åˆ›å»ºé…ç½®åŒ–çš„å·¥å…·å‡½æ•°
- ç†è§£æ›´é«˜çº§çš„æ¦‚å¿µï¼ˆå¦‚è£…é¥°å™¨ï¼‰

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šé—­åŒ… = JavaScript é—­åŒ… ğŸ¨

Python é—­åŒ…å’Œ JavaScript é—­åŒ…åŸç†å®Œå…¨ä¸€è‡´ï¼

```javascript
// JavaScript
function createCounter() {
    let count = 0;
    return function() {
        count++;
        return count;
    };
}

const counter = createCounter();
console.log(counter()); // 1
console.log(counter()); // 2
```

```python
# Python
def create_counter():
    count = 0
    def increment():
        nonlocal count
        count += 1
        return count
    return increment

counter = create_counter()
print(counter())  # 1
print(counter())  # 2
```

**å”¯ä¸€åŒºåˆ«ï¼š** Python éœ€è¦ `nonlocal` å…³é”®å­—æ¥ä¿®æ”¹å¤–å±‚å˜é‡ã€‚

---

### ç±»æ¯”2ï¼šé—­åŒ… = React çš„ useState Hook ğŸª

React çš„ `useState` åº•å±‚å°±æ˜¯é—­åŒ…çš„åº”ç”¨ï¼

```javascript
// React useState ç®€åŒ–å®ç°
function useState(initialValue) {
    let state = initialValue;  // è¢«é—­åŒ…æ•è·
    
    function setState(newValue) {
        state = newValue;
        // è§¦å‘é‡æ–°æ¸²æŸ“...
    }
    
    function getState() {
        return state;
    }
    
    return [getState, setState];
}
```

```python
# Python ç­‰ä»·å®ç°
def use_state(initial_value):
    state = {'value': initial_value}  # ç”¨å­—å…¸ç»•è¿‡ nonlocal
    
    def get_state():
        return state['value']
    
    def set_state(new_value):
        state['value'] = new_value
    
    return get_state, set_state

get_count, set_count = use_state(0)
print(get_count())  # 0
set_count(5)
print(get_count())  # 5
```

---

### ç±»æ¯”3ï¼šé—­åŒ… = äº‹ä»¶å¤„ç†å™¨çš„ä¸Šä¸‹æ–‡ ğŸ“±

å‰ç«¯äº‹ä»¶å¤„ç†å™¨ç»å¸¸ä½¿ç”¨é—­åŒ…æ¥è®°ä½ä¸Šä¸‹æ–‡ï¼š

```javascript
// JavaScript - æŒ‰é’®ç‚¹å‡»è®¡æ•°å™¨
function setupButton(buttonId) {
    let clickCount = 0;  // é—­åŒ…å˜é‡
    
    document.getElementById(buttonId).addEventListener('click', function() {
        clickCount++;
        console.log(`Button clicked ${clickCount} times`);
    });
}
```

```python
# Python ç­‰ä»· - å›è°ƒå‡½æ•°å·¥å‚
def create_click_handler(button_name):
    click_count = 0
    
    def handle_click():
        nonlocal click_count
        click_count += 1
        print(f"{button_name} clicked {click_count} times")
    
    return handle_click

submit_handler = create_click_handler("Submit")
submit_handler()  # Submit clicked 1 times
submit_handler()  # Submit clicked 2 times
```

---

### ç±»æ¯”4ï¼šé—­åŒ… = æŸ¯é‡ŒåŒ– (Currying) ğŸ›

å‰ç«¯å‡½æ•°å¼ç¼–ç¨‹ä¸­å¸¸ç”¨çš„æŸ¯é‡ŒåŒ–æœ¬è´¨å°±æ˜¯é—­åŒ…ï¼š

```javascript
// JavaScript æŸ¯é‡ŒåŒ–
const add = (a) => (b) => (c) => a + b + c;
console.log(add(1)(2)(3));  // 6
```

```python
# Python æŸ¯é‡ŒåŒ–
def add(a):
    def add_b(b):
        def add_c(c):
            return a + b + c  # a, b éƒ½è¢«é—­åŒ…æ•è·
        return add_c
    return add_b

print(add(1)(2)(3))  # 6
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| Python é—­åŒ…æ¦‚å¿µ | å‰ç«¯å¯¹åº”æ¦‚å¿µ |
|----------------|-------------|
| é—­åŒ…å‡½æ•° | JavaScript é—­åŒ… |
| nonlocal å˜é‡ | let/var åœ¨å¤–å±‚ä½œç”¨åŸŸ |
| å‡½æ•°å·¥å‚ | é«˜é˜¶ç»„ä»¶ (HOC) |
| çŠ¶æ€ä¿æŒ | useState Hook |
| è‡ªç”±å˜é‡ | è¯æ³•ä½œç”¨åŸŸæ•è· |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šé—­åŒ…æ•è·çš„æ˜¯å˜é‡çš„"å€¼" âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- é—­åŒ…æ•è·çš„æ˜¯å˜é‡çš„**å¼•ç”¨**ï¼Œä¸æ˜¯å€¼
- å¦‚æœå˜é‡åæ¥è¢«ä¿®æ”¹ï¼Œé—­åŒ…çœ‹åˆ°çš„æ˜¯ä¿®æ”¹åçš„å€¼

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºæˆ‘ä»¬ä¹ æƒ¯æ€§åœ°è®¤ä¸º"è®°ä½"å°±æ˜¯"å¤åˆ¶ä¸€ä»½"ã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
# ç»å…¸é™·é˜±ï¼šå¾ªç¯ä¸­åˆ›å»ºé—­åŒ…
funcs = []
for i in range(3):
    def f():
        return i  # æ•è·çš„æ˜¯å˜é‡ iï¼Œä¸æ˜¯å€¼
    funcs.append(f)

# æ‰€æœ‰å‡½æ•°éƒ½è¿”å› 2ï¼ˆå¾ªç¯ç»“æŸå i çš„å€¼ï¼‰
print([f() for f in funcs])  # [2, 2, 2]

# æ­£ç¡®åšæ³•ï¼šç”¨å‚æ•°é»˜è®¤å€¼æ•è·å½“å‰å€¼
funcs = []
for i in range(3):
    def f(x=i):  # x=i åœ¨å®šä¹‰æ—¶æ±‚å€¼
        return x
    funcs.append(f)

print([f() for f in funcs])  # [0, 1, 2]
```

---

### è¯¯åŒº2ï¼šæ²¡æœ‰ nonlocal ä¹Ÿèƒ½ä¿®æ”¹å¤–å±‚å˜é‡ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- æ²¡æœ‰ `nonlocal`ï¼Œèµ‹å€¼è¯­å¥ä¼šåˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡
- Python åœ¨ç¼–è¯‘æ—¶å†³å®šå˜é‡æ˜¯å±€éƒ¨è¿˜æ˜¯è‡ªç”±çš„

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸º"è¯»å–"å¤–å±‚å˜é‡ä¸éœ€è¦ä»»ä½•å£°æ˜ï¼Œæ‰€ä»¥ä»¥ä¸º"å†™å…¥"ä¹Ÿä¸€æ ·ã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
def outer():
    count = 0
    
    def inner():
        # è¿™é‡Œ count = count + 1 ä¼šæŠ¥é”™
        # å› ä¸º Python çœ‹åˆ°èµ‹å€¼ï¼Œè®¤ä¸º count æ˜¯å±€éƒ¨å˜é‡
        # ä½†å³è¾¹çš„ count è¿˜æ²¡å®šä¹‰
        count = count + 1  # UnboundLocalError!
        return count
    
    return inner

# æ­£ç¡®åšæ³•
def outer():
    count = 0
    
    def inner():
        nonlocal count  # å£°æ˜ï¼šæˆ‘è¦ç”¨å¤–å±‚çš„ count
        count = count + 1
        return count
    
    return inner
```

---

### è¯¯åŒº3ï¼šé—­åŒ…ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œåº”è¯¥é¿å…ä½¿ç”¨ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- é—­åŒ…æ˜¯æ­£å¸¸çš„è¯­è¨€ç‰¹æ€§ï¼Œä¸æ˜¯"æ³„æ¼"
- åªè¦ä¸å†å¼•ç”¨é—­åŒ…ï¼Œç›¸å…³å†…å­˜å°±ä¼šè¢«å›æ”¶
- çœŸæ­£çš„é—®é¢˜æ˜¯æ„å¤–åœ°ä¿æŒäº†ä¸éœ€è¦çš„å¼•ç”¨

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºæ—©æœŸ JavaScript åœ¨ IE ä¸­ç¡®å®æœ‰é—­åŒ…å¯¼è‡´çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œè¿™ä¸ªå°è±¡è¢«è¿‡åº¦æ³›åŒ–äº†ã€‚

**æ­£ç¡®ç†è§£ï¼š**
```python
# ä¸æ˜¯å†…å­˜æ³„æ¼ï¼šæ­£å¸¸ä½¿ç”¨
def create_processor():
    config = {'threshold': 0.8}  # å°å¯¹è±¡ï¼Œé—®é¢˜ä¸å¤§
    def process(data):
        return [d for d in data if d > config['threshold']]
    return process

# æ½œåœ¨é—®é¢˜ï¼šæ„å¤–ä¿ç•™å¤§å¯¹è±¡
def create_analyzer():
    huge_dataset = load_huge_file()  # åŠ è½½äº†å¤§æ–‡ä»¶
    
    def analyze(query):
        # åªç”¨åˆ°äº† huge_dataset çš„ä¸€å°éƒ¨åˆ†
        return search(huge_dataset, query)
    
    return analyze
    
# æ›´å¥½çš„åšæ³•ï¼šåªä¿ç•™éœ€è¦çš„éƒ¨åˆ†
def create_analyzer():
    huge_dataset = load_huge_file()
    index = build_index(huge_dataset)  # åªä¿ç•™ç´¢å¼•
    del huge_dataset  # é‡Šæ”¾åŸå§‹æ•°æ®
    
    def analyze(query):
        return search_index(index, query)
    
    return analyze
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

```python
"""
é—­åŒ…å®æˆ˜ç¤ºä¾‹ï¼šå‘é‡æ•°æ®åº“æŸ¥è¯¢å·¥å…·
å±•ç¤ºé—­åŒ…åœ¨å®é™…å¼€å‘ä¸­çš„åº”ç”¨
"""

# ===== 1. åŸºç¡€é—­åŒ…ï¼šè®¡æ•°å™¨ =====
print("=== 1. åŸºç¡€é—­åŒ…ï¼šè®¡æ•°å™¨ ===")

def create_counter(name):
    """åˆ›å»ºä¸€ä¸ªå‘½åè®¡æ•°å™¨"""
    count = 0
    
    def increment():
        nonlocal count
        count += 1
        return f"{name}: {count}"
    
    def reset():
        nonlocal count
        count = 0
        return f"{name} reset"
    
    return increment, reset

# åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨
query_counter, query_reset = create_counter("æŸ¥è¯¢æ¬¡æ•°")
insert_counter, insert_reset = create_counter("æ’å…¥æ¬¡æ•°")

print(query_counter())   # æŸ¥è¯¢æ¬¡æ•°: 1
print(query_counter())   # æŸ¥è¯¢æ¬¡æ•°: 2
print(insert_counter())  # æ’å…¥æ¬¡æ•°: 1
print(query_reset())     # æŸ¥è¯¢æ¬¡æ•° reset
print(query_counter())   # æŸ¥è¯¢æ¬¡æ•°: 1

# ===== 2. å‡½æ•°å·¥å‚ï¼šåˆ›å»ºè¿‡æ»¤å™¨ =====
print("\n=== 2. å‡½æ•°å·¥å‚ï¼šåˆ›å»ºè¿‡æ»¤å™¨ ===")

def create_score_filter(min_score, max_score=1.0):
    """åˆ›å»ºä¸€ä¸ªç›¸ä¼¼åº¦åˆ†æ•°è¿‡æ»¤å™¨"""
    def filter_func(results):
        """è¿‡æ»¤æœç´¢ç»“æœ"""
        return [
            r for r in results 
            if min_score <= r.get('score', 0) <= max_score
        ]
    return filter_func

# æ¨¡æ‹Ÿå‘é‡æœç´¢ç»“æœ
search_results = [
    {'id': 1, 'text': 'æœºå™¨å­¦ä¹ å…¥é—¨', 'score': 0.95},
    {'id': 2, 'text': 'æ·±åº¦å­¦ä¹ åŸºç¡€', 'score': 0.87},
    {'id': 3, 'text': 'Pythonç¼–ç¨‹', 'score': 0.72},
    {'id': 4, 'text': 'æ•°æ®ç»“æ„', 'score': 0.65},
]

# åˆ›å»ºä¸åŒé˜ˆå€¼çš„è¿‡æ»¤å™¨
high_quality = create_score_filter(0.9)
medium_quality = create_score_filter(0.7, 0.9)

print("é«˜è´¨é‡ç»“æœ:", [r['text'] for r in high_quality(search_results)])
print("ä¸­ç­‰è´¨é‡ç»“æœ:", [r['text'] for r in medium_quality(search_results)])

# ===== 3. é…ç½®åŒ–æŸ¥è¯¢æ„å»ºå™¨ =====
print("\n=== 3. é…ç½®åŒ–æŸ¥è¯¢æ„å»ºå™¨ ===")

def create_search_config(collection_name, default_limit=10):
    """åˆ›å»ºä¸€ä¸ªé¢„é…ç½®çš„æœç´¢é…ç½®ç”Ÿæˆå™¨"""
    query_count = 0
    
    def build_query(vector, limit=None, filters=None):
        nonlocal query_count
        query_count += 1
        
        return {
            'collection': collection_name,
            'vector': vector,
            'limit': limit or default_limit,
            'filters': filters or {},
            'query_id': query_count
        }
    
    def get_stats():
        return f"Collection '{collection_name}' å·²æ‰§è¡Œ {query_count} æ¬¡æŸ¥è¯¢"
    
    return build_query, get_stats

# ä¸ºä¸åŒé›†åˆåˆ›å»ºæŸ¥è¯¢æ„å»ºå™¨
doc_search, doc_stats = create_search_config('documents', default_limit=5)
img_search, img_stats = create_search_config('images', default_limit=20)

# æ„å»ºæŸ¥è¯¢
query1 = doc_search([0.1, 0.2, 0.3])
query2 = doc_search([0.4, 0.5, 0.6], limit=3, filters={'type': 'pdf'})
query3 = img_search([0.7, 0.8, 0.9])

print(f"Query 1: collection={query1['collection']}, limit={query1['limit']}")
print(f"Query 2: filters={query2['filters']}")
print(doc_stats())
print(img_stats())

# ===== 4. ç¼“å­˜è£…é¥°å™¨ï¼ˆé—­åŒ…çš„é«˜çº§åº”ç”¨ï¼‰=====
print("\n=== 4. ç¼“å­˜è£…é¥°å™¨ ===")

def create_cache(max_size=100):
    """åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å¤§å°é™åˆ¶çš„ç¼“å­˜"""
    cache = {}
    access_order = []
    
    def get(key):
        if key in cache:
            # LRU: æ›´æ–°è®¿é—®é¡ºåº
            access_order.remove(key)
            access_order.append(key)
            return cache[key], True
        return None, False
    
    def set(key, value):
        if key not in cache and len(cache) >= max_size:
            # ç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„
            oldest = access_order.pop(0)
            del cache[oldest]
        
        cache[key] = value
        if key in access_order:
            access_order.remove(key)
        access_order.append(key)
    
    def stats():
        return f"ç¼“å­˜å¤§å°: {len(cache)}/{max_size}"
    
    return get, set, stats

# æ¨¡æ‹Ÿå‘é‡ç¼“å­˜
cache_get, cache_set, cache_stats = create_cache(max_size=3)

# ç¼“å­˜ä¸€äº›å‘é‡
cache_set('vec_1', [0.1, 0.2])
cache_set('vec_2', [0.3, 0.4])
cache_set('vec_3', [0.5, 0.6])
print(cache_stats())

# æŸ¥è¯¢ç¼“å­˜
result, hit = cache_get('vec_1')
print(f"æŸ¥è¯¢ vec_1: {result}, å‘½ä¸­: {hit}")

# æ·»åŠ æ–°é¡¹ï¼Œè§¦å‘æ·˜æ±°
cache_set('vec_4', [0.7, 0.8])
result, hit = cache_get('vec_2')  # vec_2 åº”è¯¥è¢«æ·˜æ±°äº†
print(f"æŸ¥è¯¢ vec_2: å‘½ä¸­={hit}")

# ===== 5. æ‰¹å¤„ç†ç´¯åŠ å™¨ =====
print("\n=== 5. æ‰¹å¤„ç†ç´¯åŠ å™¨ ===")

def create_batch_processor(batch_size, process_func):
    """åˆ›å»ºä¸€ä¸ªæ‰¹å¤„ç†å™¨ï¼Œç´¯ç§¯æ•°æ®åˆ°æŒ‡å®šå¤§å°åå¤„ç†"""
    buffer = []
    total_processed = 0
    
    def add(item):
        nonlocal total_processed
        buffer.append(item)
        
        if len(buffer) >= batch_size:
            # å¤„ç†æ•´æ‰¹æ•°æ®
            process_func(buffer.copy())
            total_processed += len(buffer)
            buffer.clear()
            return True
        return False
    
    def flush():
        """å¼ºåˆ¶å¤„ç†å‰©ä½™æ•°æ®"""
        nonlocal total_processed
        if buffer:
            process_func(buffer.copy())
            total_processed += len(buffer)
            buffer.clear()
    
    def get_stats():
        return f"å·²å¤„ç†: {total_processed}, ç¼“å†²ä¸­: {len(buffer)}"
    
    return add, flush, get_stats

# æ¨¡æ‹Ÿæ‰¹é‡æ’å…¥å‘é‡
def mock_insert(vectors):
    print(f"  -> æ’å…¥ {len(vectors)} æ¡å‘é‡")

batch_add, batch_flush, batch_stats = create_batch_processor(3, mock_insert)

# æ·»åŠ å‘é‡
for i in range(7):
    triggered = batch_add({'id': i, 'vector': [i * 0.1]})
    if triggered:
        print(f"  æ‰¹æ¬¡å·²æ»¡ï¼Œè§¦å‘å¤„ç†")

print(batch_stats())
batch_flush()  # å¤„ç†å‰©ä½™
print(batch_stats())
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== 1. åŸºç¡€é—­åŒ…ï¼šè®¡æ•°å™¨ ===
æŸ¥è¯¢æ¬¡æ•°: 1
æŸ¥è¯¢æ¬¡æ•°: 2
æ’å…¥æ¬¡æ•°: 1
æŸ¥è¯¢æ¬¡æ•° reset
æŸ¥è¯¢æ¬¡æ•°: 1

=== 2. å‡½æ•°å·¥å‚ï¼šåˆ›å»ºè¿‡æ»¤å™¨ ===
é«˜è´¨é‡ç»“æœ: ['æœºå™¨å­¦ä¹ å…¥é—¨']
ä¸­ç­‰è´¨é‡ç»“æœ: ['æ·±åº¦å­¦ä¹ åŸºç¡€', 'Pythonç¼–ç¨‹']

=== 3. é…ç½®åŒ–æŸ¥è¯¢æ„å»ºå™¨ ===
Query 1: collection=documents, limit=5
Query 2: filters={'type': 'pdf'}
Collection 'documents' å·²æ‰§è¡Œ 2 æ¬¡æŸ¥è¯¢
Collection 'images' å·²æ‰§è¡Œ 1 æ¬¡æŸ¥è¯¢

=== 4. ç¼“å­˜è£…é¥°å™¨ ===
ç¼“å­˜å¤§å°: 3/3
æŸ¥è¯¢ vec_1: [0.1, 0.2], å‘½ä¸­: True
æŸ¥è¯¢ vec_2: å‘½ä¸­=False

=== 5. æ‰¹å¤„ç†ç´¯åŠ å™¨ ===
  -> æ’å…¥ 3 æ¡å‘é‡
  æ‰¹æ¬¡å·²æ»¡ï¼Œè§¦å‘å¤„ç†
  -> æ’å…¥ 3 æ¡å‘é‡
  æ‰¹æ¬¡å·²æ»¡ï¼Œè§¦å‘å¤„ç†
å·²å¤„ç†: 6, ç¼“å†²ä¸­: 1
  -> æ’å…¥ 1 æ¡å‘é‡
å·²å¤„ç†: 7, ç¼“å†²ä¸­: 0
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿè¯·ä¸¾ä¾‹è¯´æ˜"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **é—­åŒ…æœ‰ä¸‰å±‚ç†è§£ï¼š**
>
> 1. **å®šä¹‰å±‚é¢**ï¼šé—­åŒ…æ˜¯å‡½æ•°å’Œå…¶è¯æ³•ç¯å¢ƒçš„ç»„åˆã€‚ç®€å•è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå‡½æ•°"æ‰“åŒ…å¸¦èµ°"äº†å®ƒåˆ›å»ºæ—¶èƒ½è®¿é—®çš„å˜é‡ã€‚
>
> 2. **å®ç°å±‚é¢**ï¼šå½“å†…éƒ¨å‡½æ•°å¼•ç”¨äº†å¤–éƒ¨å‡½æ•°çš„å˜é‡æ—¶ï¼ŒPython ä¼šæŠŠè¿™äº›å˜é‡å­˜å‚¨åœ¨å‡½æ•°çš„ `__closure__` å±æ€§ä¸­ã€‚è¿™äº›å˜é‡å«åš"è‡ªç”±å˜é‡"ã€‚
>
> 3. **åº”ç”¨å±‚é¢**ï¼šé—­åŒ…ä¸»è¦ç”¨äºä¸‰ä¸ªåœºæ™¯ï¼š
>    - **çŠ¶æ€ä¿æŒ**ï¼šè®©å‡½æ•°è®°ä½è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€
>    - **æ•°æ®å°è£…**ï¼šå®ç°ç±»ä¼¼ç§æœ‰å˜é‡çš„æ•ˆæœ
>    - **å‡½æ•°å·¥å‚**ï¼šåˆ›å»ºé…ç½®åŒ–çš„å‡½æ•°
>
> **ä¸¾ä¸ªä¾‹å­ï¼š** åœ¨å‘é‡æ•°æ®åº“å¼€å‘ä¸­ï¼Œæˆ‘ä¼šç”¨é—­åŒ…åˆ›å»ºé¢„é…ç½®çš„æŸ¥è¯¢å‡½æ•°ï¼š
>
> ```python
> def create_searcher(collection, top_k=10):
>     def search(query):
>         return collection.search(query, limit=top_k)
>     return search
> ```
>
> è¿™æ ·å¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒé…ç½®çš„æœç´¢å™¨ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½ä¼ é€’é…ç½®å‚æ•°ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†å±‚æ¬¡è§£é‡Šï¼Œå±•ç¤ºæ·±åº¦ç†è§£
2. âœ… æåˆ°äº†å…·ä½“çš„å®ç°ç»†èŠ‚ï¼ˆ`__closure__`ï¼‰
3. âœ… ç»“åˆå®é™…åº”ç”¨åœºæ™¯ï¼ˆå‘é‡æ•°æ®åº“ï¼‰
4. âœ… ç»™å‡ºäº†ç®€æ´çš„ä»£ç ç¤ºä¾‹

---

### é—®é¢˜2ï¼š"é—­åŒ…æœ‰ä»€ä¹ˆé™·é˜±ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"é—­åŒ…ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **é—­åŒ…ä¸»è¦æœ‰ä¸¤ä¸ªå¸¸è§é™·é˜±ï¼š**
>
> 1. **å¾ªç¯å˜é‡é™·é˜±**ï¼š
>    ```python
>    funcs = [lambda: i for i in range(3)]
>    print([f() for f in funcs])  # [2, 2, 2] ä¸æ˜¯ [0, 1, 2]
>    ```
>    åŸå› æ˜¯é—­åŒ…æ•è·çš„æ˜¯å˜é‡çš„å¼•ç”¨ï¼Œä¸æ˜¯å€¼ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ç”¨é»˜è®¤å‚æ•°ï¼š`lambda x=i: x`
>
> 2. **å¿˜è®° nonlocal**ï¼š
>    ```python
>    def counter():
>        count = 0
>        def inc():
>            count += 1  # UnboundLocalError!
>        return inc
>    ```
>    Python çœ‹åˆ°èµ‹å€¼ä¼šè®¤ä¸ºæ˜¯å±€éƒ¨å˜é‡ã€‚éœ€è¦ç”¨ `nonlocal count` å£°æ˜ã€‚
>
> **å…³äºå†…å­˜**ï¼šé—­åŒ…æœ¬èº«ä¸ä¼š"æ³„æ¼"ï¼Œä½†è¦æ³¨æ„ä¸è¦æ„å¤–ä¿ç•™å¤§å¯¹è±¡çš„å¼•ç”¨ã€‚è§£å†³æ–¹æ¡ˆæ˜¯åªä¿ç•™å¿…è¦çš„æ•°æ®ï¼Œæˆ–è€…ç”¨å¼±å¼•ç”¨ã€‚

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** é—­åŒ… = å‡½æ•° + å®ƒèƒ½è®¿é—®çš„å¤–éƒ¨å˜é‡

**ä¸¾ä¾‹ï¼š**
```python
def outer():
    x = 10
    def inner():
        return x  # inner å°±æ˜¯é—­åŒ…ï¼Œå®ƒ"è®°ä½"äº† x
    return inner
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“ä¸­ç”¨äºåˆ›å»ºè®°ä½é…ç½®çš„æŸ¥è¯¢å‡½æ•°ã€‚

---

### å¡ç‰‡2ï¼šä¸ºä»€ä¹ˆéœ€è¦é—­åŒ…ï¼Ÿ ğŸ¤”

**ä¸€å¥è¯ï¼š** å‡½æ•°æ‰§è¡Œå®Œå˜é‡å°±é”€æ¯äº†ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬æƒ³è®©æŸäº›å˜é‡"æ´»"å¾—æ›´ä¹…ã€‚

**ä¸¾ä¾‹ï¼š**
```python
# æ²¡æœ‰é—­åŒ…ï¼Œè¢«è¿«ç”¨å…¨å±€å˜é‡
count = 0  # ä¸å®‰å…¨ï¼Œä»»ä½•äººéƒ½èƒ½æ”¹

# æœ‰äº†é—­åŒ…
def make_counter():
    count = 0  # å®‰å…¨ï¼Œå¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®
    def inc():
        nonlocal count
        count += 1
        return count
    return inc
```

**åº”ç”¨ï¼š** å®‰å…¨åœ°ä¿å­˜æ•°æ®åº“è¿æ¥çŠ¶æ€ã€‚

---

### å¡ç‰‡3ï¼šè‡ªç”±å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ”¢

**ä¸€å¥è¯ï¼š** åœ¨å‡½æ•°å†…ä½¿ç”¨ã€ä½†ä¸æ˜¯å‚æ•°ä¹Ÿä¸æ˜¯å±€éƒ¨å˜é‡çš„å˜é‡ã€‚

**ä¸¾ä¾‹ï¼š**
```python
def outer():
    x = 10  # x æ˜¯ inner çš„è‡ªç”±å˜é‡
    def inner(y):  # y æ˜¯å‚æ•°ï¼Œä¸æ˜¯è‡ªç”±å˜é‡
        z = 5      # z æ˜¯å±€éƒ¨å˜é‡
        return x + y + z
    return inner

f = outer()
print(f.__code__.co_freevars)  # ('x',)
```

**åº”ç”¨ï¼š** ç†è§£é—­åŒ…"è®°ä½"äº†ä»€ä¹ˆã€‚

---

### å¡ç‰‡4ï¼šnonlocal å…³é”®å­— ğŸ“

**ä¸€å¥è¯ï¼š** å‘Šè¯‰ Python "æˆ‘è¦ä¿®æ”¹å¤–å±‚çš„å˜é‡ï¼Œä¸æ˜¯åˆ›å»ºæ–°çš„"ã€‚

**ä¸¾ä¾‹ï¼š**
```python
def counter():
    count = 0
    def inc():
        nonlocal count  # æ²¡è¿™è¡Œä¼šæŠ¥é”™
        count += 1
        return count
    return inc
```

**è§„åˆ™ï¼š** è¯»å–å¤–å±‚å˜é‡ä¸éœ€è¦ nonlocalï¼Œä¿®æ”¹æ‰éœ€è¦ã€‚

---

### å¡ç‰‡5ï¼šé—­åŒ… vs ç±» âš–ï¸

**ä¸€å¥è¯ï¼š** é—­åŒ…æ˜¯è½»é‡çº§çš„"å¸¦æ–¹æ³•çš„æ•°æ®"ï¼Œç±»æ˜¯é‡é‡çº§çš„ã€‚

**å¯¹æ¯”ï¼š**
```python
# é—­åŒ…ç‰ˆ
def make_counter():
    count = 0
    def inc():
        nonlocal count
        count += 1
        return count
    return inc

# ç±»ç‰ˆ
class Counter:
    def __init__(self):
        self.count = 0
    def inc(self):
        self.count += 1
        return self.count
```

**é€‰æ‹©ï¼š** ç®€å•çŠ¶æ€ç”¨é—­åŒ…ï¼Œå¤æ‚é€»è¾‘ç”¨ç±»ã€‚

---

### å¡ç‰‡6ï¼šå¾ªç¯é™·é˜± âš ï¸

**ä¸€å¥è¯ï¼š** å¾ªç¯ä¸­åˆ›å»ºçš„é—­åŒ…ï¼Œéƒ½å¼•ç”¨åŒä¸€ä¸ªå¾ªç¯å˜é‡ã€‚

**é™·é˜±ï¼š**
```python
funcs = [lambda: i for i in range(3)]
[f() for f in funcs]  # [2, 2, 2] ä¸æ˜¯ [0, 1, 2]
```

**è§£å†³ï¼š**
```python
funcs = [lambda x=i: x for i in range(3)]  # ç”¨é»˜è®¤å‚æ•°æ•è·å€¼
```

---

### å¡ç‰‡7ï¼šå‡½æ•°å·¥å‚æ¨¡å¼ ğŸ­

**ä¸€å¥è¯ï¼š** ç”¨é—­åŒ…åˆ›å»ºä¸åŒé…ç½®çš„å‡½æ•°ã€‚

**ä¸¾ä¾‹ï¼š**
```python
def make_multiplier(n):
    def multiply(x):
        return x * n
    return multiply

double = make_multiplier(2)
triple = make_multiplier(3)
print(double(5), triple(5))  # 10 15
```

**åº”ç”¨ï¼š** åˆ›å»ºä¸åŒ top_k çš„å‘é‡æœç´¢å‡½æ•°ã€‚

---

### å¡ç‰‡8ï¼šé—­åŒ…ä¸å†…å­˜ ğŸ’¾

**ä¸€å¥è¯ï¼š** é—­åŒ…ä¼šå»¶é•¿è‡ªç”±å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ³¨æ„ä¸è¦æ„å¤–ä¿ç•™å¤§å¯¹è±¡ã€‚

**æ³¨æ„ï¼š**
```python
def bad():
    huge_data = load_huge_file()  # 1GB æ•°æ®
    def search(q):
        return query(huge_data, q)  # huge_data ä¸€ç›´åœ¨å†…å­˜ä¸­
    return search

def good():
    huge_data = load_huge_file()
    index = build_index(huge_data)  # åªä¿ç•™ç´¢å¼•
    del huge_data  # é‡Šæ”¾åŸå§‹æ•°æ®
    def search(q):
        return query(index, q)
    return search
```

---

### å¡ç‰‡9ï¼šè£…é¥°å™¨æœ¬è´¨æ˜¯é—­åŒ… ğŸ€

**ä¸€å¥è¯ï¼š** è£…é¥°å™¨æ˜¯é—­åŒ…çš„é«˜çº§åº”ç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```python
def timer(func):  # æ¥æ”¶å‡½æ•°
    def wrapper(*args):  # è¿”å›æ–°å‡½æ•°
        start = time.time()
        result = func(*args)  # func æ˜¯è‡ªç”±å˜é‡ï¼
        print(f"è€—æ—¶: {time.time() - start}s")
        return result
    return wrapper

@timer
def slow_search(query):
    ...
```

**åº”ç”¨ï¼š** ä¸ºå‘é‡æœç´¢æ·»åŠ è®¡æ—¶ã€ç¼“å­˜ã€é‡è¯•ç­‰åŠŸèƒ½ã€‚

---

### å¡ç‰‡10ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ ğŸ—„ï¸

**ä¸€å¥è¯ï¼š** é—­åŒ…ç”¨äºåˆ›å»ºé¢„é…ç½®çš„æ•°æ®åº“æ“ä½œå‡½æ•°ã€‚

**å®ä¾‹ï¼š**
```python
def create_searcher(client, collection, top_k=10, threshold=0.8):
    def search(query_vector):
        results = client.search(
            collection=collection,
            vector=query_vector,
            limit=top_k
        )
        return [r for r in results if r.score >= threshold]
    return search

# ä¸ºä¸åŒåœºæ™¯åˆ›å»ºæœç´¢å™¨
fast_search = create_searcher(client, "docs", top_k=5)
precise_search = create_searcher(client, "docs", top_k=100, threshold=0.95)
```

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**é—­åŒ…æ˜¯å‡½æ•°ä¸å…¶è¯ç”Ÿæ—¶è¯æ³•ç¯å¢ƒçš„ç»“åˆä½“ï¼Œèƒ½å¤Ÿ"è®°ä½"åˆ›å»ºæ—¶çš„å˜é‡ï¼Œåœ¨å‘é‡æ•°æ®åº“å¼€å‘ä¸­å¸¸ç”¨äºåˆ›å»ºé¢„é…ç½®çš„æŸ¥è¯¢å‡½æ•°ã€å®ç°çŠ¶æ€ä¿æŒå’Œæ•°æ®å°è£…ã€‚**

---

## ğŸ“š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½ç”¨è‡ªå·±çš„è¯è§£é‡Šä»€ä¹ˆæ˜¯é—­åŒ…
- [ ] ç†è§£è‡ªç”±å˜é‡çš„æ¦‚å¿µ
- [ ] çŸ¥é“ä½•æ—¶ä½¿ç”¨ nonlocal
- [ ] èƒ½é¿å…å¾ªç¯ä¸­åˆ›å»ºé—­åŒ…çš„é™·é˜±
- [ ] èƒ½ç”¨é—­åŒ…å®ç°ç®€å•çš„è®¡æ•°å™¨
- [ ] èƒ½ç”¨é—­åŒ…åˆ›å»ºå‡½æ•°å·¥å‚
- [ ] ç†è§£é—­åŒ…ä¸å†…å­˜çš„å…³ç³»

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

å­¦å®Œé—­åŒ…åï¼Œå»ºè®®å­¦ä¹ ï¼š
1. **ç”Ÿæˆå™¨ (yield)** - é—­åŒ…çš„"æš‚åœç‰ˆ"
2. **è£…é¥°å™¨** - é—­åŒ…çš„é«˜çº§åº”ç”¨
3. **å‡½æ•°å¼ç¼–ç¨‹** - é—­åŒ…çš„è®¾è®¡å“²å­¦
