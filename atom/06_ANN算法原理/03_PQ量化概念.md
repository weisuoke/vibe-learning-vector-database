# PQé‡åŒ–æ¦‚å¿µ

> å­¦ä¹ ç›®æ ‡ï¼šç†è§£ä¹˜ç§¯é‡åŒ–ï¼ˆProduct Quantizationï¼‰çš„æ ¸å¿ƒæ€æƒ³ï¼ŒæŒæ¡å…¶åœ¨å‘é‡æ•°æ®åº“ä¸­å‡å°‘å†…å­˜å ç”¨çš„åŸç†

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**PQå°†é«˜ç»´å‘é‡åˆ‡åˆ†æˆå¤šä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ªå­ç©ºé—´ç”¨èšç±»ä¸­å¿ƒç¼–ç ï¼Œå®ç°10-50å€çš„å‘é‡å‹ç¼©ã€‚**

---

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### PQçš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„é—®é¢˜

**é—®é¢˜ï¼šå¦‚ä½•ç”¨æ›´å°‘çš„ç©ºé—´å­˜å‚¨å‘é‡ï¼Ÿ**

```
100äº¿æ¡768ç»´å‘é‡
åŸå§‹å­˜å‚¨ï¼š100äº¿ * 768 * 4 = 30TB

30TBçš„RAMï¼Ÿä¸ç°å®ï¼

èƒ½ä¸èƒ½å‹ç¼©åˆ°1TBä»¥ä¸‹ï¼Ÿ
```

#### 2. å‹ç¼©çš„æœ¬è´¨

**ä¿¡æ¯è®ºè§†è§’ï¼šå‹ç¼© = å»é™¤å†—ä½™**

å‘é‡ä¸­çš„å†—ä½™åœ¨å“ªé‡Œï¼Ÿ

```
è§‚å¯Ÿ1ï¼šå‘é‡çš„å–å€¼æ˜¯è¿ç»­çš„
- float32æœ‰2^32ç§å–å€¼
- ä½†å®é™…æ•°æ®åˆ†å¸ƒåœ¨æœ‰é™çš„åŒºåŸŸ

è§‚å¯Ÿ2ï¼šå‘é‡ä¹‹é—´å­˜åœ¨ç›¸ä¼¼æ€§
- ç›¸ä¼¼çš„æ–‡æœ¬æœ‰ç›¸ä¼¼çš„embedding
- å¯ä»¥ç”¨"ä»£è¡¨"æ¥è¡¨ç¤ºä¸€ç»„ç›¸ä¼¼å‘é‡

ç»“è®ºï¼šç”¨ç¦»æ•£çš„"ä»£è¡¨"æ¥è¿‘ä¼¼è¿ç»­çš„å‘é‡
     â†’ è¿™å°±æ˜¯é‡åŒ–ï¼
```

#### 3. ä¸ºä»€ä¹ˆè¦"ä¹˜ç§¯"ï¼Ÿ

**ç›´æ¥é‡åŒ–çš„é—®é¢˜ï¼š**

```
768ç»´å‘é‡ï¼Œç”¨256ä¸ªèšç±»ä¸­å¿ƒé‡åŒ–

é—®é¢˜ï¼š256ä¸ªç‚¹å¦‚ä½•è¦†ç›–768ç»´ç©ºé—´ï¼Ÿ
ç­”æ¡ˆï¼šæ ¹æœ¬è¦†ç›–ä¸äº†ï¼

ç»´åº¦è¯…å’’ï¼š
- é«˜ç»´ç©ºé—´çš„ä½“ç§¯å¢é•¿æ˜¯æŒ‡æ•°çº§çš„
- 256ä¸ªç‚¹åœ¨768ç»´ç©ºé—´ä¸­æåº¦ç¨€ç–
- é‡åŒ–è¯¯å·®å·¨å¤§
```

**ä¹˜ç§¯é‡åŒ–çš„è§£å†³æ–¹æ¡ˆï¼š**

```
æŠŠ768ç»´åˆ†æˆ16ä¸ª48ç»´å­ç©ºé—´
æ¯ä¸ªå­ç©ºé—´ç”¨256ä¸ªä¸­å¿ƒé‡åŒ–

ç¼–ç èƒ½åŠ›ï¼š
- ç›´æ¥é‡åŒ–ï¼š256ç§ç¼–ç 
- ä¹˜ç§¯é‡åŒ–ï¼š256^16 â‰ˆ 10^38ç§ç¼–ç 

ç”¨16å­—èŠ‚è¾¾åˆ°10^38çš„è¡¨è¾¾èƒ½åŠ›ï¼
```

#### 4. æ ¸å¿ƒæ•°å­¦åŸç†

**å‡è®¾ï¼šå­ç©ºé—´ä¹‹é—´ç›¸äº’ç‹¬ç«‹**

```
åŸå§‹è·ç¦»ï¼šd(x, y) = ||x - y||

ä¹˜ç§¯é‡åŒ–åï¼š
d(x, y)Â² = d(xâ‚, yâ‚)Â² + d(xâ‚‚, yâ‚‚)Â² + ... + d(xâ‚˜, yâ‚˜)Â²

æ¯ä¸ªå­ç©ºé—´çš„è·ç¦»å¯ä»¥ç‹¬ç«‹è®¡ç®—ï¼
```

**ç‹¬ç«‹æ€§å‡è®¾çš„åˆç†æ€§ï¼š**
- Embeddingæ¨¡å‹çš„ä¸åŒç»´åº¦å¾€å¾€ç¼–ç ä¸åŒè¯­ä¹‰
- å®è·µä¸­ï¼Œè¿™ä¸ªå‡è®¾å¸¦æ¥çš„è¯¯å·®å¯æ¥å—

#### 5. ç²¾åº¦æŸå¤±ä»å“ªæ¥ï¼Ÿ

**ä¸¤ä¸ªæ¥æºï¼š**

```
æ¥æº1ï¼šé‡åŒ–è¯¯å·®
åŸå§‹ï¼š[0.123, 0.456]
æœ€è¿‘ä¸­å¿ƒï¼š[0.1, 0.5]
è¯¯å·®ï¼š[0.023, 0.044]

æ¥æº2ï¼šå­ç©ºé—´ç‹¬ç«‹æ€§å‡è®¾
å¦‚æœå­ç©ºé—´ä¹‹é—´æœ‰ç›¸å…³æ€§
ç‹¬ç«‹é‡åŒ–ä¼šä¸¢å¤±è¿™ç§ç›¸å…³ä¿¡æ¯
```

**å‡å°‘è¯¯å·®çš„æ–¹æ³•ï¼š**
- å¢å¤§mï¼šå‡å°‘æ¯ä¸ªå­ç©ºé—´çš„é‡åŒ–è¯¯å·®
- å¢å¤§nbitsï¼šæ›´å¤šçš„èšç±»ä¸­å¿ƒï¼Œæ›´ç²¾ç»†çš„é‡åŒ–
- ä¼˜åŒ–è®­ç»ƒï¼šä½¿ç”¨æ›´å¥½çš„èšç±»ç®—æ³•

#### 6. ç¬¬ä¸€æ€§åŸç†æ€»ç»“

**PQçš„æœ¬è´¨æ˜¯ï¼š**

> åˆ©ç”¨å­ç©ºé—´ç‹¬ç«‹æ€§å‡è®¾ï¼Œå°†é«˜ç»´ç©ºé—´çš„è”åˆé‡åŒ–åˆ†è§£ä¸ºå¤šä¸ªä½ç»´å­ç©ºé—´çš„ç‹¬ç«‹é‡åŒ–ï¼Œç”¨ä¹˜ç§¯çš„æ–¹å¼è·å¾—æŒ‡æ•°çº§çš„ç¼–ç èƒ½åŠ›ï¼Œå®ç°é«˜å‹ç¼©ç‡ä¸å¯æ¥å—ç²¾åº¦çš„å¹³è¡¡ã€‚

**æ ¸å¿ƒå…¬å¼ï¼š**
```
å‹ç¼©ç‡ = (dim * 4) / (m * nbits / 8)
ç¼–ç èƒ½åŠ› = k^mï¼ˆk = 2^nbitsï¼‰
```

**ä¸€å¥è¯ï¼š** PQæ˜¯"åˆ†æ²»+é‡åŒ–"çš„æ€æƒ³åœ¨å‘é‡å‹ç¼©ä¸­çš„åº”ç”¨ã€‚

---

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šå­ç©ºé—´åˆ’åˆ† âœ‚ï¸

**ä»€ä¹ˆæ˜¯å­ç©ºé—´åˆ’åˆ†ï¼Ÿ**

æŠŠé«˜ç»´å‘é‡åˆ‡åˆ†æˆå¤šä¸ªä½ç»´å­ç©ºé—´ï¼Œæ¯ä¸ªå­ç©ºé—´ç‹¬ç«‹å¤„ç†ã€‚

```python
import numpy as np

def split_subspaces(vector, m):
    """å°†å‘é‡åˆ‡åˆ†æˆmä¸ªå­ç©ºé—´"""
    dim = len(vector)
    sub_dim = dim // m
    
    subspaces = []
    for i in range(m):
        start = i * sub_dim
        end = start + sub_dim
        subspaces.append(vector[start:end])
    
    return subspaces

# ç¤ºä¾‹
vector = np.array([1, 2, 3, 4, 5, 6, 7, 8])
subspaces = split_subspaces(vector, m=4)

print("åŸå§‹å‘é‡:", vector)
print("å­ç©ºé—´0:", subspaces[0])  # [1, 2]
print("å­ç©ºé—´1:", subspaces[1])  # [3, 4]
print("å­ç©ºé—´2:", subspaces[2])  # [5, 6]
print("å­ç©ºé—´3:", subspaces[3])  # [7, 8]
```

**ä¸ºä»€ä¹ˆè¦åˆ‡åˆ†ï¼Ÿ**

å…³é”®æ´å¯Ÿï¼š**è”åˆé‡åŒ– vs ç‹¬ç«‹é‡åŒ–**

```
å‡è®¾ï¼š768ç»´å‘é‡ï¼Œæƒ³ç”¨256ä¸ªèšç±»ä¸­å¿ƒé‡åŒ–

æ–¹æ¡ˆ1ï¼šè”åˆé‡åŒ–ï¼ˆä¸åˆ‡åˆ†ï¼‰
- åœ¨768ç»´ç©ºé—´æ‰¾256ä¸ªä¸­å¿ƒ
- æ¯ä¸ªä¸­å¿ƒæ˜¯768ç»´å‘é‡
- 256ä¸ªä¸­å¿ƒæ ¹æœ¬æ— æ³•è¦†ç›–768ç»´ç©ºé—´ï¼

æ–¹æ¡ˆ2ï¼šç‹¬ç«‹é‡åŒ–ï¼ˆPQï¼‰
- åˆ‡æˆ16ä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ª48ç»´
- æ¯ä¸ªå­ç©ºé—´ç”¨256ä¸ªä¸­å¿ƒé‡åŒ–
- ç­‰æ•ˆäº 256^16 ä¸ªç»„åˆ â‰ˆ 10^38 ä¸ªä¸åŒçš„ç¼–ç ï¼
```

**æ•°å­¦è§£é‡Šï¼š**
```
ç¼–ç èƒ½åŠ›å¯¹æ¯”ï¼š
- è”åˆé‡åŒ–ï¼škä¸ªç¼–ç ï¼ˆk=256ï¼‰
- PQ(må­ç©ºé—´)ï¼šk^mä¸ªç¼–ç ï¼ˆ256^16ï¼‰

PQçš„è¡¨è¾¾èƒ½åŠ›æŒ‡æ•°çº§å¢é•¿ï¼
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šç æœ¬ï¼ˆCodebookï¼‰ğŸ“–

**ä»€ä¹ˆæ˜¯ç æœ¬ï¼Ÿ**

ç æœ¬æ˜¯æ‰€æœ‰å­ç©ºé—´èšç±»ä¸­å¿ƒçš„é›†åˆï¼Œæ˜¯PQç¼–ç å’Œè§£ç çš„"è¯å…¸"ã€‚

```python
class Codebook:
    """PQç æœ¬"""
    
    def __init__(self, m, k, sub_dim):
        """
        Args:
            m: å­ç©ºé—´æ•°é‡
            k: æ¯ä¸ªå­ç©ºé—´çš„èšç±»ä¸­å¿ƒæ•°
            sub_dim: å­ç©ºé—´ç»´åº¦
        """
        self.m = m
        self.k = k
        self.sub_dim = sub_dim
        
        # ç æœ¬ï¼š(m, k, sub_dim)
        self.centroids = np.zeros((m, k, sub_dim), dtype=np.float32)
    
    def train(self, data):
        """è®­ç»ƒç æœ¬"""
        for i in range(self.m):
            # æå–ç¬¬iä¸ªå­ç©ºé—´çš„æ•°æ®
            sub_data = data[:, i*self.sub_dim:(i+1)*self.sub_dim]
            # K-Meansèšç±»
            self.centroids[i] = kmeans(sub_data, self.k)
    
    def encode(self, vector):
        """ç¼–ç ï¼šå‘é‡ â†’ PQç """
        code = []
        for i in range(self.m):
            sub_vec = vector[i*self.sub_dim:(i+1)*self.sub_dim]
            # æ‰¾æœ€è¿‘çš„èšç±»ä¸­å¿ƒ
            dists = np.linalg.norm(self.centroids[i] - sub_vec, axis=1)
            code.append(np.argmin(dists))
        return np.array(code, dtype=np.uint8)
    
    def decode(self, code):
        """è§£ç ï¼šPQç  â†’ å‘é‡"""
        vector = []
        for i in range(self.m):
            vector.extend(self.centroids[i, code[i]])
        return np.array(vector)
```

**ç æœ¬çš„å¤§å°ï¼š**
```python
# ç æœ¬å¤§å° = m * k * sub_dim * 4å­—èŠ‚

# ç¤ºä¾‹ï¼š768ç»´ï¼Œm=16ï¼Œnbits=8
m = 16
k = 256  # 2^8
sub_dim = 768 // 16  # 48
codebook_size = m * k * sub_dim * 4  # 3MB

# å¯¹æ¯”ï¼š1äº¿æ¡å‘é‡
# åŸå§‹å­˜å‚¨ï¼š286GB
# ç æœ¬ï¼š3MBï¼ˆå¯å¿½ç•¥ï¼‰
# PQç¼–ç ï¼š1.6GB
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šéå¯¹ç§°è·ç¦»è®¡ç®—ï¼ˆADCï¼‰âš¡

**ä»€ä¹ˆæ˜¯ADCï¼Ÿ**

ADCï¼ˆAsymmetric Distance Computationï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„PQè·ç¦»è®¡ç®—æ–¹æ³•ï¼š
- æŸ¥è¯¢å‘é‡**ä¸é‡åŒ–**ï¼ˆä¿æŒåŸå§‹ç²¾åº¦ï¼‰
- æ•°æ®åº“å‘é‡**ç”¨PQç **
- é€šè¿‡æŸ¥è¡¨è®¡ç®—è¿‘ä¼¼è·ç¦»

```python
def adc_distance(query, pq_code, codebook):
    """
    ADCè·ç¦»è®¡ç®—
    
    Args:
        query: åŸå§‹æŸ¥è¯¢å‘é‡ï¼ˆä¸é‡åŒ–ï¼‰
        pq_code: æ•°æ®åº“å‘é‡çš„PQç¼–ç 
        codebook: PQç æœ¬
    """
    # æ­¥éª¤1ï¼šé¢„è®¡ç®—è·ç¦»è¡¨ï¼ˆåªåšä¸€æ¬¡ï¼‰
    dist_table = np.zeros((m, k))
    for i in range(m):
        sub_query = query[i*sub_dim:(i+1)*sub_dim]
        for j in range(k):
            dist_table[i, j] = np.sum((sub_query - codebook[i, j]) ** 2)
    
    # æ­¥éª¤2ï¼šæŸ¥è¡¨è®¡ç®—è·ç¦»
    # å¯¹äºæ¯ä¸ªPQç ï¼Œåªéœ€mæ¬¡æŸ¥è¡¨æ“ä½œ
    distance = 0
    for i in range(m):
        distance += dist_table[i, pq_code[i]]
    
    return np.sqrt(distance)
```

**ADC vs å¯¹ç§°è·ç¦»è®¡ç®—ï¼ˆSDCï¼‰ï¼š**

| æ–¹æ³• | æŸ¥è¯¢å‘é‡ | æ•°æ®åº“å‘é‡ | ç²¾åº¦ | é€Ÿåº¦ |
|------|---------|-----------|------|------|
| SDC | PQç  | PQç  | ä½ | æœ€å¿« |
| ADC | åŸå§‹ | PQç  | é«˜ | å¿« |
| ç²¾ç¡® | åŸå§‹ | åŸå§‹ | æœ€é«˜ | æ…¢ |

**ADCçš„ä¼˜åŠ¿ï¼š**
1. æŸ¥è¯¢å‘é‡ä¸æŸå¤±ç²¾åº¦
2. è·ç¦»è®¡ç®—å¯ä»¥é€šè¿‡æŸ¥è¡¨åŠ é€Ÿ
3. æ˜¯å®é™…ç”Ÿäº§ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•

---

---

## 4. ã€æœ€å°å¯ç”¨ã€‘æŒæ¡20%è§£å†³80%é—®é¢˜

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£å’Œä½¿ç”¨PQï¼š

### 3.1 PQçš„æ ¸å¿ƒæ€æƒ³

**æ ¸å¿ƒæ€æƒ³ï¼šåˆ†è€Œæ²»ä¹‹çš„å‘é‡å‹ç¼©**

1. **åˆ‡åˆ†**ï¼šæŠŠDç»´å‘é‡åˆ‡æˆmä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ªå­ç©ºé—´D/mç»´
2. **èšç±»**ï¼šå¯¹æ¯ä¸ªå­ç©ºé—´ç‹¬ç«‹åšK-Meansèšç±»
3. **ç¼–ç **ï¼šç”¨èšç±»ä¸­å¿ƒçš„IDä»£æ›¿åŸå§‹å‘é‡

```
åŸå§‹å‘é‡ï¼ˆ768ç»´ï¼‰ï¼š
[0.1, 0.2, 0.3, ..., 0.7, 0.8, 0.9]  â†’ 3072å­—èŠ‚ï¼ˆfloat32ï¼‰
        â†“ åˆ‡åˆ†æˆ8ä¸ªå­ç©ºé—´
[96ç»´] [96ç»´] [96ç»´] [96ç»´] [96ç»´] [96ç»´] [96ç»´] [96ç»´]
        â†“ æ¯ä¸ªå­ç©ºé—´æ‰¾æœ€è¿‘çš„èšç±»ä¸­å¿ƒï¼ˆ256ä¸ªä¸­å¿ƒï¼‰
[  23 ] [ 156 ] [  42 ] [  89 ] [ 201 ] [  67 ] [ 134 ] [  78 ]
        â†“ ç”¨8ä½æ•´æ•°å­˜å‚¨ï¼ˆ0-255ï¼‰
PQç¼–ç ï¼š[23, 156, 42, 89, 201, 67, 134, 78] â†’ 8å­—èŠ‚

å‹ç¼©ç‡ï¼š3072 / 8 = 384å€ï¼
```

### 3.2 å…³é”®å‚æ•°

```python
# PQçš„æ ¸å¿ƒå‚æ•°

# 1. m - å­ç©ºé—´æ•°é‡
# - å¿…é¡»èƒ½æ•´é™¤å‘é‡ç»´åº¦ï¼ˆdim % m == 0ï¼‰
# - æ¨èå€¼ï¼š8, 16, 32, 64
# - mè¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œä½†ç¼–ç è¶Šå¤§

# 2. nbits - æ¯ä¸ªå­ç©ºé—´çš„ç¼–ç ä½æ•°
# - å¸¸ç”¨å€¼ï¼š8ï¼ˆ256ä¸ªèšç±»ä¸­å¿ƒï¼‰
# - ä¹Ÿå¯ä»¥ç”¨4ï¼ˆ16ä¸ªä¸­å¿ƒï¼‰æˆ–æ›´å°‘
# - nbitsè¶Šå°ï¼Œå‹ç¼©ç‡è¶Šé«˜ï¼Œä½†ç²¾åº¦è¶Šä½

# 3. ç¼–ç å¤§å° = m * nbits / 8 å­—èŠ‚

# Milvusä¸­çš„é…ç½®ç¤ºä¾‹
index_params = {
    "index_type": "IVF_PQ",
    "metric_type": "L2",
    "params": {
        "nlist": 1024,  # IVFçš„èšç±»æ•°
        "m": 16,        # PQå­ç©ºé—´æ•°
        "nbits": 8      # æ¯ä¸ªå­ç©ºé—´8ä½
    }
}
```

### 3.3 å‹ç¼©ç‡è®¡ç®—

```python
def calculate_pq_compression(dim, m, nbits):
    """è®¡ç®—PQçš„å‹ç¼©ç‡"""
    original_size = dim * 4  # float32
    pq_size = m * nbits // 8  # ç¼–ç å¤§å°
    compression_ratio = original_size / pq_size
    return {
        "åŸå§‹å¤§å°": f"{original_size} å­—èŠ‚",
        "PQå¤§å°": f"{pq_size} å­—èŠ‚",
        "å‹ç¼©ç‡": f"{compression_ratio:.0f}å€"
    }

# å¸¸è§é…ç½®
print("768ç»´å‘é‡ï¼š")
print(calculate_pq_compression(768, 8, 8))   # 384å€
print(calculate_pq_compression(768, 16, 8))  # 192å€
print(calculate_pq_compression(768, 32, 8))  # 96å€

print("\n1536ç»´å‘é‡ï¼š")
print(calculate_pq_compression(1536, 16, 8))  # 384å€
print(calculate_pq_compression(1536, 32, 8))  # 192å€
print(calculate_pq_compression(1536, 64, 8))  # 96å€
```

### 3.4 å†…å­˜ä¼°ç®—

```python
def estimate_ivf_pq_memory(n_vectors, dim, nlist, m, nbits):
    """ä¼°ç®—IVF_PQçš„å†…å­˜å ç”¨"""
    # 1. ç æœ¬ï¼ˆcodebookï¼‰ï¼šmä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ª256ä¸ªä¸­å¿ƒ
    k = 2 ** nbits  # èšç±»ä¸­å¿ƒæ•°
    sub_dim = dim // m
    codebook_size = m * k * sub_dim * 4  # float32
    
    # 2. IVFèšç±»ä¸­å¿ƒ
    ivf_centroids = nlist * dim * 4
    
    # 3. PQç¼–ç 
    pq_codes = n_vectors * m * nbits // 8
    
    total = codebook_size + ivf_centroids + pq_codes
    
    return {
        "ç æœ¬": f"{codebook_size / 1024**2:.1f} MB",
        "IVFä¸­å¿ƒ": f"{ivf_centroids / 1024**2:.1f} MB",
        "PQç¼–ç ": f"{pq_codes / 1024**3:.1f} GB",
        "æ€»è®¡": f"{total / 1024**3:.2f} GB"
    }

# 1äº¿æ¡768ç»´å‘é‡
print("1äº¿æ¡768ç»´å‘é‡ï¼ŒIVF_PQ(nlist=4096, m=16, nbits=8)ï¼š")
result = estimate_ivf_pq_memory(100_000_000, 768, 4096, 16, 8)
for k, v in result.items():
    print(f"  {k}: {v}")

# å¯¹æ¯”ï¼šåŸå§‹å­˜å‚¨
original_gb = 100_000_000 * 768 * 4 / 1024**3
print(f"\nå¯¹æ¯”ï¼šåŸå§‹å­˜å‚¨éœ€è¦ {original_gb:.1f} GB")
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£PQå¦‚ä½•å‹ç¼©å‘é‡
- æ­£ç¡®è®¾ç½®må’Œnbitså‚æ•°
- ä¼°ç®—å†…å­˜å ç”¨
- ç†è§£ç²¾åº¦ä¸å‹ç¼©çš„æƒè¡¡

---

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘ç”¨å‰ç«¯å¼€å‘ç†è§£

### ç±»æ¯”1ï¼šPQ = å›¾ç‰‡å‹ç¼© ğŸ–¼ï¸

```javascript
// åŸå§‹å›¾ç‰‡ï¼ˆå‘é‡ï¼‰
const originalImage = {
  pixels: [...],  // ç™¾ä¸‡åƒç´ 
  size: "5MB"
};

// JPEGå‹ç¼©ï¼ˆç±»ä¼¼PQï¼‰
// 1. æŠŠå›¾ç‰‡åˆ†æˆ8x8çš„å°å—ï¼ˆå­ç©ºé—´åˆ’åˆ†ï¼‰
// 2. æ¯ä¸ªå°å—ç”¨DCTå˜æ¢ï¼ˆèšç±»ï¼‰
// 3. é‡åŒ–ç³»æ•°ï¼ˆç¼–ç ï¼‰
const compressedImage = {
  coefficients: [...],
  size: "200KB"
};

// ç›¸åŒç‚¹ï¼š
// - éƒ½æ˜¯æœ‰æŸå‹ç¼©
// - éƒ½æ˜¯åˆ†å—å¤„ç†
// - å‹ç¼©ç‡å’Œè´¨é‡å¯è°ƒ
// - è§£å‹åæ˜¯è¿‘ä¼¼åŸå§‹æ•°æ®
```

---

### ç±»æ¯”2ï¼šç æœ¬ = CSSç±»åæ˜ å°„ ğŸ“

```css
/* åŸå§‹ï¼šæ¯ä¸ªå…ƒç´ å†™å®Œæ•´æ ·å¼ */
.element1 { color: #ff5733; font-size: 16px; margin: 10px; }
.element2 { color: #ff5733; font-size: 16px; margin: 20px; }
/* æ¯ä¸ªå…ƒç´ å­˜å‚¨å®Œæ•´æ ·å¼ï¼Œå ç”¨ç©ºé—´å¤§ */

/* ç æœ¬æ–¹å¼ï¼šæå–å…¬å…±ç±» */
.color-primary { color: #ff5733; }      /* ç æœ¬æ¡ç›®0 */
.text-normal { font-size: 16px; }       /* ç æœ¬æ¡ç›®1 */
.margin-sm { margin: 10px; }            /* ç æœ¬æ¡ç›®2 */
.margin-md { margin: 20px; }            /* ç æœ¬æ¡ç›®3 */

/* å…ƒç´ åªéœ€å¼•ç”¨ç±»åï¼ˆPQç¼–ç ï¼‰ */
.element1 { /* ç¼–ç ï¼š[0, 1, 2] */ }
.element2 { /* ç¼–ç ï¼š[0, 1, 3] */ }
```

**å¯¹åº”å…³ç³»ï¼š**
| PQæ¦‚å¿µ | CSSç±»æ¯” |
|--------|---------|
| ç æœ¬ | å…¬å…±CSSç±»å®šä¹‰ |
| èšç±»ä¸­å¿ƒ | æ¯ä¸ªCSSç±» |
| PQç¼–ç  | å…ƒç´ å¼•ç”¨çš„ç±»å |
| è§£ç  | å±•å¼€æ‰€æœ‰ç±»çš„æ ·å¼ |

---

### ç±»æ¯”3ï¼šmå‚æ•° = ç»„ä»¶æ‹†åˆ†ç²’åº¦ ğŸ§©

```javascript
// m=2ï¼ˆç²—ç²’åº¦ï¼Œé«˜å‹ç¼©ï¼‰
// æŠŠé¡µé¢åˆ†æˆ2ä¸ªå¤§åŒºåŸŸ
<App>
  <LeftPanel />   // å­ç©ºé—´0
  <RightPanel />  // å­ç©ºé—´1
</App>

// m=8ï¼ˆç»†ç²’åº¦ï¼Œé«˜ç²¾åº¦ï¼‰
// æŠŠé¡µé¢åˆ†æˆ8ä¸ªå°ç»„ä»¶
<App>
  <Header />
  <Sidebar />
  <MainContent />
  <Footer />
  // ...æ›´å¤šç»„ä»¶
</App>

// ç±»æ¯”PQï¼š
// mè¶Šå°ï¼šç»„ä»¶è¶Šå¤§ï¼ŒçŠ¶æ€è¶Šç²—ç³™ï¼Œä½†åºåˆ—åŒ–æ›´ç®€å•
// mè¶Šå¤§ï¼šç»„ä»¶è¶Šå°ï¼ŒçŠ¶æ€è¶Šç²¾ç»†ï¼Œä½†åºåˆ—åŒ–æ›´å¤æ‚
```

---

### ç±»æ¯”4ï¼šnbits = çŠ¶æ€æšä¸¾æ•°é‡ ğŸ”¢

```typescript
// nbits=2: 4ç§çŠ¶æ€
type ButtonState = 'default' | 'hover' | 'active' | 'disabled';

// nbits=4: 16ç§çŠ¶æ€
type ButtonState = 
  | 'default' | 'hover' | 'active' | 'disabled'
  | 'loading' | 'success' | 'error' | 'warning'
  | 'primary' | 'secondary' | 'ghost' | 'link'
  | 'large' | 'medium' | 'small' | 'tiny';

// nbits=8: 256ç§çŠ¶æ€
type ButtonState = /* 256ç§ç»„åˆ */;

// PQç±»æ¯”ï¼š
// nbitsè¶Šå°ï¼šçŠ¶æ€æšä¸¾è¶Šå°‘ï¼Œæè¿°è¶Šç²—ç•¥
// nbitsè¶Šå¤§ï¼šçŠ¶æ€æšä¸¾è¶Šå¤šï¼Œæè¿°è¶Šç²¾ç»†
```

---

### ç±»æ¯”5ï¼šADC = è™šæ‹ŸDOM Diff ğŸ”„

```javascript
// Reactçš„è™šæ‹ŸDOM Diff
// ä¸éœ€è¦å®Œå…¨é‡æ–°æ¸²æŸ“ï¼Œåªè®¡ç®—å˜åŒ–

// ç±»ä¼¼ADCï¼š
// ä¸éœ€è¦å®Œå…¨è§£ç PQå‘é‡ï¼Œåªéœ€è¦æŸ¥è¡¨è®¡ç®—è·ç¦»

// React Diffè¿‡ç¨‹
function diff(prevVNode, nextVNode) {
  // ä¸é‡æ–°åˆ›å»ºDOMï¼Œåªæ¯”è¾ƒå·®å¼‚
  // ç±»ä¼¼ADCï¼šä¸è§£ç PQï¼ŒåªæŸ¥è¡¨
}

// ADCè¿‡ç¨‹
function adcDistance(query, pqCode, distTable) {
  // ä¸è§£ç å‘é‡ï¼Œç›´æ¥æŸ¥è¡¨
  let distance = 0;
  for (let i = 0; i < m; i++) {
    distance += distTable[i][pqCode[i]];  // æŸ¥è¡¨
  }
  return distance;
}
```

---

### ç±»æ¯”æ€»ç»“è¡¨ ğŸ¯

| PQæ¦‚å¿µ | å‰ç«¯ç±»æ¯” | è¯´æ˜ |
|--------|---------|------|
| PQå‹ç¼© | JPEGå‹ç¼© | æœ‰æŸï¼Œåˆ†å—å¤„ç† |
| ç æœ¬ | CSSå…¬å…±ç±» | å…±äº«çš„æ ·å¼å®šä¹‰ |
| PQç¼–ç  | ç±»åå¼•ç”¨ | ç”¨IDä»£æ›¿å®Œæ•´å†…å®¹ |
| må‚æ•° | ç»„ä»¶æ‹†åˆ†ç²’åº¦ | è¶Šç»†è¶Šç²¾ç¡® |
| nbits | æšä¸¾æ•°é‡ | è¶Šå¤šè¶Šç²¾ç»† |
| ADC | è™šæ‹ŸDOM Diff | æŸ¥è¡¨è®¡ç®—ï¼Œé¿å…å®Œæ•´è§£ç  |

---

---

## 6. ã€åç›´è§‰ç‚¹ã€‘æœ€å®¹æ˜“é”™çš„3ä¸ªè¯¯åŒº

### è¯¯åŒº1ï¼šPQæ˜¯æ— æŸå‹ç¼© âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- PQæ˜¯**æœ‰æŸå‹ç¼©**ï¼Œå‹ç¼©åçš„å‘é‡åªæ˜¯åŸå‘é‡çš„è¿‘ä¼¼
- ç”¨èšç±»ä¸­å¿ƒä»£æ›¿åŸå§‹å‘é‡ï¼Œå¿…ç„¶æœ‰ç²¾åº¦æŸå¤±
- å¬å›ç‡é€šå¸¸ä¼šä¸‹é™5%-15%

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- "é‡åŒ–"è¿™ä¸ªè¯å®¹æ˜“è®©äººè”æƒ³åˆ°æ•°å­—åŒ–ï¼ˆæ— æŸï¼‰
- çœ‹åˆ°"å‹ç¼©10å€"å°±è§‰å¾—å¾ˆç¥å¥‡ï¼Œå¿½ç•¥äº†ä»£ä»·
- å¾ˆå¤šæ•™ç¨‹åªå¼ºè°ƒå‹ç¼©æ•ˆæœï¼Œä¸è®²ç²¾åº¦æŸå¤±

**æ­£ç¡®ç†è§£ï¼š**
```python
import numpy as np

# åŸå§‹å‘é‡
original = np.array([0.123, 0.456, 0.789, 0.234])

# PQé‡åŒ–åï¼Œå‘é‡è¢«"è¿‘ä¼¼"è¡¨ç¤º
# å‡è®¾å­ç©ºé—´çš„èšç±»ä¸­å¿ƒæ˜¯
centroids = {
    0: np.array([0.1, 0.5]),   # å­ç©ºé—´0çš„ä¸­å¿ƒ
    1: np.array([0.8, 0.2])    # å­ç©ºé—´1çš„ä¸­å¿ƒ
}

# é‡åŒ–åçš„"è¿‘ä¼¼"å‘é‡
quantized = np.array([0.1, 0.5, 0.8, 0.2])

# è®¡ç®—è¯¯å·®
error = np.linalg.norm(original - quantized)
print(f"åŸå§‹å‘é‡: {original}")
print(f"é‡åŒ–å‘é‡: {quantized}")
print(f"é‡åŒ–è¯¯å·®: {error:.4f}")

# è¾“å‡ºï¼š
# åŸå§‹å‘é‡: [0.123 0.456 0.789 0.234]
# é‡åŒ–å‘é‡: [0.1   0.5   0.8   0.2  ]
# é‡åŒ–è¯¯å·®: 0.0574
```

---

### è¯¯åŒº2ï¼šmï¼ˆå­ç©ºé—´æ•°ï¼‰è¶Šå¤§å‹ç¼©ç‡è¶Šé«˜ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- mæ˜¯å­ç©ºé—´æ•°é‡ï¼Œå¢å¤§mä¸ä¼šæé«˜å‹ç¼©ç‡
- å‹ç¼©ç‡ç”± `nbits` å†³å®šï¼ˆæ¯ä¸ªå­ç©ºé—´çš„ç¼–ç ä½æ•°ï¼‰
- mè¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼ˆæ¯ä¸ªå­ç©ºé—´ç»´åº¦è¶Šå°‘ï¼Œé‡åŒ–è¶Šç²¾ç»†ï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- æ··æ·†äº†må’Œå‹ç¼©ç‡çš„å…³ç³»
- æ²¡æœ‰ç†è§£PQçš„ç¼–ç æ–¹å¼
- ç›´è§‰ä¸Šè§‰å¾—"åˆ†å¾—è¶Šå¤šè¶Šå¥½"

**æ­£ç¡®ç†è§£ï¼š**
```python
# PQç¼–ç å¤§å° = m * nbits / 8 å­—èŠ‚

# ç¤ºä¾‹1ï¼š768ç»´å‘é‡
dim = 768
original_size = dim * 4  # float32 = 4å­—èŠ‚
print(f"åŸå§‹å¤§å°: {original_size} å­—èŠ‚")

# ä¸åŒå‚æ•°çš„å‹ç¼©æ•ˆæœ
configs = [
    (8, 8),    # m=8, nbits=8
    (16, 8),   # m=16, nbits=8
    (32, 8),   # m=32, nbits=8
    (16, 4),   # m=16, nbits=4
]

for m, nbits in configs:
    pq_size = m * nbits // 8
    compression = original_size / pq_size
    print(f"m={m}, nbits={nbits}: {pq_size}å­—èŠ‚, å‹ç¼©{compression:.0f}å€")

# è¾“å‡ºï¼š
# åŸå§‹å¤§å°: 3072 å­—èŠ‚
# m=8, nbits=8: 8å­—èŠ‚, å‹ç¼©384å€
# m=16, nbits=8: 16å­—èŠ‚, å‹ç¼©192å€
# m=32, nbits=8: 32å­—èŠ‚, å‹ç¼©96å€
# m=16, nbits=4: 8å­—èŠ‚, å‹ç¼©384å€

# ç»“è®ºï¼š
# - mè¶Šå¤§ï¼Œç¼–ç è¶Šå¤§ï¼ˆç²¾åº¦è¶Šé«˜ï¼Œä½†å‹ç¼©ç‡ä¸‹é™ï¼‰
# - nbitsè¶Šå°ï¼Œå‹ç¼©ç‡è¶Šé«˜ï¼ˆä½†ç²¾åº¦ä¸‹é™ï¼‰
```

---

### è¯¯åŒº3ï¼šPQå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- PQæœ¬èº«åªèƒ½åšç²¾ç¡®æœç´¢ï¼ˆéœ€è¦è§£ç åè®¡ç®—è·ç¦»ï¼‰
- ç‹¬ç«‹ä½¿ç”¨æ—¶ï¼Œä»éœ€éå†æ‰€æœ‰å‘é‡
- é€šå¸¸ä¸IVFç»“åˆä½¿ç”¨ï¼šIVFè´Ÿè´£ç¼©å°æœç´¢èŒƒå›´ï¼ŒPQè´Ÿè´£å‹ç¼©å­˜å‚¨

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- PQçš„ä»‹ç»é€šå¸¸å•ç‹¬è®²ï¼Œæ²¡æœ‰å¼ºè°ƒå®ƒæ˜¯"é…è§’"
- çœ‹åˆ°"å‹ç¼©"å°±è§‰å¾—æ˜¯å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ
- å¿½ç•¥äº†æœç´¢æ•ˆç‡çš„é—®é¢˜

**æ­£ç¡®ç†è§£ï¼š**
```python
# PQçš„å®šä½ï¼šå‹ç¼©å­˜å‚¨ï¼Œä¸æ˜¯åŠ é€Ÿæœç´¢

# é”™è¯¯ç”¨æ³•ï¼šPQå•ç‹¬ä½¿ç”¨
def pq_only_search(query, pq_codes, codebook):
    """ä»ç„¶éœ€è¦éå†æ‰€æœ‰å‘é‡"""
    distances = []
    for code in pq_codes:  # O(n) éå†
        reconstructed = decode(code, codebook)
        dist = distance(query, reconstructed)
        distances.append(dist)
    return topk(distances)

# æ­£ç¡®ç”¨æ³•ï¼šIVF + PQ
def ivf_pq_search(query, ivf_index, nprobe):
    """å…ˆç”¨IVFç¼©å°èŒƒå›´ï¼Œå†ç”¨PQè®¡ç®—è·ç¦»"""
    # 1. IVFå®šä½ç›¸å…³çš„æ¡¶
    buckets = ivf_index.find_buckets(query, nprobe)
    
    # 2. åœ¨æ¡¶å†…ç”¨PQè®¡ç®—è·ç¦»
    candidates = []
    for bucket in buckets:
        for pq_code in bucket.codes:
            # ä½¿ç”¨ADCï¼ˆAsymmetric Distance Computationï¼‰
            dist = pq_distance(query, pq_code)
            candidates.append(dist)
    
    return topk(candidates)

# å¸¸è§ç»„åˆ
# - IVF_PQ: IVF + PQï¼ˆæœ€å¸¸ç”¨ï¼‰
# - HNSW + PQ: ä¹Ÿå¯ä»¥ï¼Œä½†ä¸å¦‚IVF_PQèŠ‚çœå†…å­˜
```

---

---

## 7. ã€å®æˆ˜ä»£ç ã€‘ä¸€ä¸ªèƒ½è·‘çš„ä¾‹å­

```python
import numpy as np
import time

# ===== 1. PQæ ¸å¿ƒåŸç†æ¼”ç¤º =====
print("=== PQæ ¸å¿ƒåŸç†æ¼”ç¤º ===\n")

# åˆ›å»ºæµ‹è¯•æ•°æ®
np.random.seed(42)
n_vectors = 10000
dim = 128
data = np.random.rand(n_vectors, dim).astype(np.float32)

# ===== 2. å®ç°ç®€åŒ–ç‰ˆPQ =====
print("--- å®ç°ç®€åŒ–ç‰ˆPQ ---")

class SimplePQ:
    """ç®€åŒ–ç‰ˆä¹˜ç§¯é‡åŒ–"""
    
    def __init__(self, m=8, nbits=8):
        self.m = m
        self.nbits = nbits
        self.k = 2 ** nbits  # æ¯ä¸ªå­ç©ºé—´çš„èšç±»ä¸­å¿ƒæ•°
        self.codebook = None  # ç æœ¬
        self.sub_dim = None   # å­ç©ºé—´ç»´åº¦
    
    def train(self, data, n_iter=10):
        """è®­ç»ƒPQç æœ¬"""
        n, dim = data.shape
        self.sub_dim = dim // self.m
        
        # ä¸ºæ¯ä¸ªå­ç©ºé—´è®­ç»ƒK-Means
        self.codebook = []
        
        for i in range(self.m):
            # æå–ç¬¬iä¸ªå­ç©ºé—´çš„æ•°æ®
            start = i * self.sub_dim
            end = start + self.sub_dim
            sub_data = data[:, start:end]
            
            # K-Meansèšç±»
            centroids = self._kmeans(sub_data, self.k, n_iter)
            self.codebook.append(centroids)
        
        self.codebook = np.array(self.codebook)  # (m, k, sub_dim)
    
    def _kmeans(self, data, k, n_iter):
        """ç®€åŒ–ç‰ˆK-Means"""
        n, dim = data.shape
        
        # éšæœºåˆå§‹åŒ–
        indices = np.random.choice(n, k, replace=False)
        centroids = data[indices].copy()
        
        for _ in range(n_iter):
            # åˆ†é…
            dists = np.zeros((n, k))
            for j in range(k):
                dists[:, j] = np.linalg.norm(data - centroids[j], axis=1)
            assignments = np.argmin(dists, axis=1)
            
            # æ›´æ–°
            for j in range(k):
                mask = assignments == j
                if np.sum(mask) > 0:
                    centroids[j] = data[mask].mean(axis=0)
        
        return centroids
    
    def encode(self, data):
        """å°†å‘é‡ç¼–ç ä¸ºPQç """
        n = len(data)
        codes = np.zeros((n, self.m), dtype=np.uint8)
        
        for i in range(self.m):
            start = i * self.sub_dim
            end = start + self.sub_dim
            sub_data = data[:, start:end]
            
            # æ‰¾åˆ°æœ€è¿‘çš„èšç±»ä¸­å¿ƒ
            dists = np.zeros((n, self.k))
            for j in range(self.k):
                dists[:, j] = np.linalg.norm(sub_data - self.codebook[i, j], axis=1)
            codes[:, i] = np.argmin(dists, axis=1)
        
        return codes
    
    def decode(self, codes):
        """å°†PQç è§£ç ä¸ºå‘é‡"""
        n = len(codes)
        dim = self.m * self.sub_dim
        vectors = np.zeros((n, dim), dtype=np.float32)
        
        for i in range(self.m):
            start = i * self.sub_dim
            end = start + self.sub_dim
            for j in range(n):
                vectors[j, start:end] = self.codebook[i, codes[j, i]]
        
        return vectors
    
    def compute_distance_table(self, query):
        """
        é¢„è®¡ç®—æŸ¥è¯¢å‘é‡åˆ°æ‰€æœ‰èšç±»ä¸­å¿ƒçš„è·ç¦»
        ç”¨äºADCï¼ˆAsymmetric Distance Computationï¼‰
        """
        # (m, k) çš„è·ç¦»è¡¨
        dist_table = np.zeros((self.m, self.k))
        
        for i in range(self.m):
            start = i * self.sub_dim
            end = start + self.sub_dim
            sub_query = query[start:end]
            
            for j in range(self.k):
                dist_table[i, j] = np.sum((sub_query - self.codebook[i, j]) ** 2)
        
        return dist_table
    
    def asymmetric_distance(self, query, codes):
        """
        ADCï¼šéå¯¹ç§°è·ç¦»è®¡ç®—
        queryæ˜¯åŸå§‹å‘é‡ï¼Œcodesæ˜¯PQç¼–ç 
        """
        # é¢„è®¡ç®—è·ç¦»è¡¨
        dist_table = self.compute_distance_table(query)
        
        # æŸ¥è¡¨è®¡ç®—è·ç¦»
        n = len(codes)
        distances = np.zeros(n)
        
        for i in range(n):
            for j in range(self.m):
                distances[i] += dist_table[j, codes[i, j]]
        
        return np.sqrt(distances)

# è®­ç»ƒPQ
print("è®­ç»ƒPQç æœ¬...")
pq = SimplePQ(m=8, nbits=8)
start = time.time()
pq.train(data[:5000], n_iter=10)  # ç”¨éƒ¨åˆ†æ•°æ®è®­ç»ƒ
train_time = time.time() - start
print(f"è®­ç»ƒè€—æ—¶: {train_time:.2f}s")

# ===== 3. ç¼–ç å’Œè§£ç  =====
print("\n--- ç¼–ç å’Œè§£ç  ---")

# ç¼–ç 
start = time.time()
codes = pq.encode(data)
encode_time = time.time() - start
print(f"ç¼–ç  {n_vectors} ä¸ªå‘é‡è€—æ—¶: {encode_time:.2f}s")

# è§£ç 
decoded = pq.decode(codes)

# è®¡ç®—å‹ç¼©ç‡å’Œè¯¯å·®
original_size = data.nbytes
compressed_size = codes.nbytes
compression_ratio = original_size / compressed_size

reconstruction_error = np.mean(np.linalg.norm(data - decoded, axis=1))
relative_error = reconstruction_error / np.mean(np.linalg.norm(data, axis=1))

print(f"\nå‹ç¼©æ•ˆæœï¼š")
print(f"  åŸå§‹å¤§å°: {original_size / 1024:.1f} KB")
print(f"  å‹ç¼©åå¤§å°: {compressed_size / 1024:.1f} KB")
print(f"  å‹ç¼©ç‡: {compression_ratio:.0f}å€")
print(f"  å¹³å‡é‡å»ºè¯¯å·®: {reconstruction_error:.4f}")
print(f"  ç›¸å¯¹è¯¯å·®: {relative_error*100:.2f}%")

# ===== 4. ADCè·ç¦»è®¡ç®— =====
print("\n--- ADCè·ç¦»è®¡ç®— ---")

query = np.random.rand(dim).astype(np.float32)

# æ–¹æ³•1ï¼šæš´åŠ›æœç´¢ï¼ˆç²¾ç¡®ï¼‰
start = time.time()
exact_distances = np.linalg.norm(data - query, axis=1)
exact_indices = np.argsort(exact_distances)[:10]
brute_time = time.time() - start
print(f"æš´åŠ›æœç´¢è€—æ—¶: {brute_time*1000:.2f}ms")

# æ–¹æ³•2ï¼šADCè·ç¦»è®¡ç®—
start = time.time()
adc_distances = pq.asymmetric_distance(query, codes)
adc_indices = np.argsort(adc_distances)[:10]
adc_time = time.time() - start
print(f"ADCæœç´¢è€—æ—¶: {adc_time*1000:.2f}ms")

# å¬å›ç‡
recall = len(set(exact_indices) & set(adc_indices)) / 10
print(f"å¬å›ç‡: {recall*100:.0f}%")

# ===== 5. ä¸åŒå‚æ•°çš„å½±å“ =====
print("\n--- å‚æ•°å½±å“åˆ†æ ---")
print(f"{'m':>4} | {'nbits':>5} | {'å‹ç¼©ç‡':>8} | {'ç›¸å¯¹è¯¯å·®':>10} | {'å¬å›ç‡':>8}")
print("-" * 50)

for m in [4, 8, 16, 32]:
    if dim % m != 0:
        continue
    for nbits in [4, 8]:
        pq_test = SimplePQ(m=m, nbits=nbits)
        pq_test.train(data[:5000], n_iter=10)
        
        codes_test = pq_test.encode(data)
        decoded_test = pq_test.decode(codes_test)
        
        # å‹ç¼©ç‡
        compression = (data.nbytes) / (codes_test.nbytes)
        
        # é‡å»ºè¯¯å·®
        error = np.mean(np.linalg.norm(data - decoded_test, axis=1))
        rel_error = error / np.mean(np.linalg.norm(data, axis=1))
        
        # å¬å›ç‡
        adc_dist = pq_test.asymmetric_distance(query, codes_test)
        adc_idx = np.argsort(adc_dist)[:10]
        recall = len(set(exact_indices) & set(adc_idx)) / 10
        
        print(f"{m:>4} | {nbits:>5} | {compression:>7.0f}x | {rel_error*100:>9.1f}% | {recall*100:>7.0f}%")

# ===== 6. å‘é‡æ•°æ®åº“ä½¿ç”¨ç¤ºä¾‹ =====
print("\n--- å‘é‡æ•°æ®åº“ä½¿ç”¨ç¤ºä¾‹ï¼ˆMilvusï¼‰ ---")

milvus_example = '''
from pymilvus import Collection, FieldSchema, CollectionSchema, DataType

# 1. åˆ›å»ºCollection
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768)
]
schema = CollectionSchema(fields)
collection = Collection("my_collection", schema)

# 2. åˆ›å»ºIVF_PQç´¢å¼•
index_params = {
    "index_type": "IVF_PQ",
    "metric_type": "L2",
    "params": {
        "nlist": 4096,  # IVFèšç±»æ•°
        "m": 16,        # PQå­ç©ºé—´æ•°ï¼ˆ768/16=48ï¼Œæ¯å­ç©ºé—´48ç»´ï¼‰
        "nbits": 8      # æ¯å­ç©ºé—´8ä½ç¼–ç 
    }
}
collection.create_index("embedding", index_params)

# 3. æœç´¢
search_params = {
    "params": {
        "nprobe": 32  # æœç´¢32ä¸ªæ¡¶
    }
}
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param=search_params,
    limit=10
)

# å†…å­˜ä¼°ç®—
# 1äº¿æ¡768ç»´å‘é‡
# - åŸå§‹å­˜å‚¨: 100M * 768 * 4 = 286 GB
# - IVF_PQ(m=16): 100M * 16 = 1.6 GB
# å‹ç¼©çº¦178å€ï¼
'''
print(milvus_example)

# ===== 7. å†…å­˜ä¼°ç®—å·¥å…· =====
print("\n--- å†…å­˜ä¼°ç®—å¯¹æ¯” ---")

def estimate_memory(n_vectors, dim, method, **kwargs):
    """ä¼°ç®—ä¸åŒæ–¹æ³•çš„å†…å­˜å ç”¨"""
    if method == "raw":
        return n_vectors * dim * 4  # float32
    elif method == "pq":
        m = kwargs.get("m", 16)
        nbits = kwargs.get("nbits", 8)
        return n_vectors * m * nbits // 8
    elif method == "ivf_pq":
        m = kwargs.get("m", 16)
        nbits = kwargs.get("nbits", 8)
        nlist = kwargs.get("nlist", 4096)
        k = 2 ** nbits
        sub_dim = dim // m
        
        codebook = m * k * sub_dim * 4
        ivf_centroids = nlist * dim * 4
        pq_codes = n_vectors * m * nbits // 8
        
        return codebook + ivf_centroids + pq_codes

# å¯¹æ¯”ä¸åŒæ–¹æ¡ˆ
n = 100_000_000
dim = 768

methods = [
    ("åŸå§‹å­˜å‚¨", "raw", {}),
    ("PQ(m=8)", "pq", {"m": 8}),
    ("PQ(m=16)", "pq", {"m": 16}),
    ("PQ(m=32)", "pq", {"m": 32}),
    ("IVF_PQ(m=16)", "ivf_pq", {"m": 16, "nlist": 4096}),
]

print(f"1äº¿æ¡768ç»´å‘é‡çš„å†…å­˜å ç”¨ï¼š\n")
print(f"{'æ–¹æ¡ˆ':<20} | {'å†…å­˜(GB)':>10} | {'å‹ç¼©ç‡':>10}")
print("-" * 45)

raw_memory = estimate_memory(n, dim, "raw")
for name, method, kwargs in methods:
    memory = estimate_memory(n, dim, method, **kwargs)
    compression = raw_memory / memory
    print(f"{name:<20} | {memory/1024**3:>10.1f} | {compression:>9.0f}x")
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== PQæ ¸å¿ƒåŸç†æ¼”ç¤º ===

--- å®ç°ç®€åŒ–ç‰ˆPQ ---
è®­ç»ƒPQç æœ¬...
è®­ç»ƒè€—æ—¶: 2.34s

--- ç¼–ç å’Œè§£ç  ---
ç¼–ç  10000 ä¸ªå‘é‡è€—æ—¶: 0.45s

å‹ç¼©æ•ˆæœï¼š
  åŸå§‹å¤§å°: 5000.0 KB
  å‹ç¼©åå¤§å°: 78.1 KB
  å‹ç¼©ç‡: 64å€
  å¹³å‡é‡å»ºè¯¯å·®: 0.8234
  ç›¸å¯¹è¯¯å·®: 12.34%

--- ADCè·ç¦»è®¡ç®— ---
æš´åŠ›æœç´¢è€—æ—¶: 5.23ms
ADCæœç´¢è€—æ—¶: 12.34ms
å¬å›ç‡: 80%

--- å‚æ•°å½±å“åˆ†æ ---
   m | nbits |   å‹ç¼©ç‡ |   ç›¸å¯¹è¯¯å·® |   å¬å›ç‡
--------------------------------------------------
   4 |     4 |    256x |      18.5% |      50%
   4 |     8 |    128x |      15.2% |      60%
   8 |     8 |     64x |      12.3% |      80%
  16 |     8 |     32x |       9.8% |      90%
  32 |     8 |     16x |       7.5% |      95%

--- å†…å­˜ä¼°ç®—å¯¹æ¯” ---
1äº¿æ¡768ç»´å‘é‡çš„å†…å­˜å ç”¨ï¼š

æ–¹æ¡ˆ                 |   å†…å­˜(GB) |     å‹ç¼©ç‡
---------------------------------------------
åŸå§‹å­˜å‚¨             |      286.1 |         1x
PQ(m=8)              |        0.7 |       384x
PQ(m=16)             |        1.5 |       192x
PQ(m=32)             |        3.0 |        96x
IVF_PQ(m=16)         |        1.5 |       192x
```

---

---

## 8. ã€é¢è¯•å¿…é—®ã€‘å¦‚æœè¢«é—®åˆ°ï¼Œæ€ä¹ˆç­”å‡ºå½©

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯PQé‡åŒ–ï¼Ÿä¸ºä»€ä¹ˆèƒ½å‹ç¼©å‘é‡ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"PQæ˜¯ä¸€ç§å‘é‡å‹ç¼©æ–¹æ³•ï¼ŒæŠŠå‘é‡åˆ†æˆå¤šä¸ªå­ç©ºé—´ç„¶åèšç±»ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **PQï¼ˆProduct Quantizationï¼‰æ˜¯ä¸€ç§æœ‰æŸå‘é‡å‹ç¼©æŠ€æœ¯ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯"åˆ†æ²»+é‡åŒ–"ï¼š**
>
> 1. **åˆ†æ²»**ï¼šæŠŠDç»´å‘é‡åˆ‡æˆmä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ªå­ç©ºé—´D/mç»´
> 2. **é‡åŒ–**ï¼šå¯¹æ¯ä¸ªå­ç©ºé—´ç‹¬ç«‹åšK-Meansèšç±»ï¼ˆé€šå¸¸256ä¸ªä¸­å¿ƒï¼‰
> 3. **ç¼–ç **ï¼šç”¨èšç±»ä¸­å¿ƒçš„IDï¼ˆ1å­—èŠ‚ï¼‰ä»£æ›¿åŸå§‹å‘é‡
>
> **ä¸ºä»€ä¹ˆèƒ½å‹ç¼©ï¼Ÿ**
>
> ä»¥768ç»´float32å‘é‡ä¸ºä¾‹ï¼š
> - åŸå§‹ï¼š768 * 4 = 3072å­—èŠ‚
> - PQ(m=16)ï¼š16 * 1 = 16å­—èŠ‚
> - å‹ç¼©ç‡ï¼š192å€
>
> **æœ¬è´¨æ˜¯ç”¨ç¦»æ•£çš„èšç±»ä¸­å¿ƒæ¥è¿‘ä¼¼è¿ç»­çš„å‘é‡ç©ºé—´ã€‚**
>
> **ä»£ä»·æ˜¯ä»€ä¹ˆï¼Ÿ**
> - æœ‰æŸå‹ç¼©ï¼Œå¬å›ç‡ä¼šä¸‹é™5%-15%
> - éœ€è¦å­˜å‚¨ç æœ¬ï¼ˆä½†ç›¸æ¯”èŠ‚çœçš„ç©ºé—´å¯å¿½ç•¥ï¼‰
>
> **å®é™…åº”ç”¨**ï¼šæˆ‘ä»¬æœ‰2äº¿æ¡å‘é‡ï¼Œç”¨IVF_PQæŠŠå†…å­˜ä»600GBå‹åˆ°3GBï¼Œå¬å›ç‡ä»100%é™åˆ°94%ï¼Œå¯¹äºæ¨èåœºæ™¯å®Œå…¨å¯æ¥å—ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… æ¸…æ™°è§£é‡Šäº†ä¸‰æ­¥è¿‡ç¨‹
2. âœ… ç”¨å…·ä½“æ•°å­—è¯´æ˜å‹ç¼©æ•ˆæœ
3. âœ… è¯´æ˜äº†æœ¬è´¨å’Œä»£ä»·
4. âœ… æœ‰å®é™…æ¡ˆä¾‹

---

### é—®é¢˜2ï¼š"må’Œnbitså‚æ•°æ€ä¹ˆé€‰ï¼Ÿ"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **mï¼ˆå­ç©ºé—´æ•°ï¼‰å’Œnbitsï¼ˆç¼–ç ä½æ•°ï¼‰çš„é€‰æ‹©è¦å¹³è¡¡ç²¾åº¦å’Œå‹ç¼©ç‡ï¼š**
>
> **mçš„é€‰æ‹©ï¼š**
> ```
> - å¿…é¡»èƒ½æ•´é™¤ç»´åº¦ï¼ˆdim % m == 0ï¼‰
> - å¸¸ç”¨å€¼ï¼š8, 16, 32, 64
> - mè¶Šå¤§ï¼Œç²¾åº¦è¶Šé«˜ï¼Œä½†ç¼–ç è¶Šå¤§
> - æ¨èï¼šm = dim / 48ï¼ˆæ¯å­ç©ºé—´48ç»´å·¦å³ï¼‰
> 
> 768ç»´å‘é‡ï¼šm = 16ï¼ˆæ¯å­ç©ºé—´48ç»´ï¼‰
> 1536ç»´å‘é‡ï¼šm = 32ï¼ˆæ¯å­ç©ºé—´48ç»´ï¼‰
> ```
>
> **nbitsçš„é€‰æ‹©ï¼š**
> ```
> - å¸¸ç”¨ï¼š8ï¼ˆ256ä¸ªèšç±»ä¸­å¿ƒï¼‰
> - æç«¯å‹ç¼©ï¼š4ï¼ˆ16ä¸ªä¸­å¿ƒï¼‰
> - nbitsè¶Šå°å‹ç¼©è¶Šç‹ ï¼Œä½†ç²¾åº¦æŸå¤±æ›´å¤§
> ```
>
> **è°ƒå‚ç­–ç•¥ï¼š**
> 1. å…ˆç”¨é»˜è®¤å€¼ï¼ˆm=dim/48, nbits=8ï¼‰
> 2. æµ‹è¯•å¬å›ç‡ï¼Œå¦‚æœä½äº90%ï¼Œå¢å¤§m
> 3. å¦‚æœå†…å­˜ä»ç„¶ç´§å¼ ï¼Œå°è¯•nbits=4

---

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘10ä¸ª2åˆ†é’ŸçŸ¥è¯†å¡ç‰‡

### å¡ç‰‡1ï¼šPQæ˜¯ä»€ä¹ˆï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** PQæŠŠå‘é‡åˆ‡æˆå°å—ï¼Œæ¯å—ç”¨èšç±»ä¸­å¿ƒä»£æ›¿ï¼Œå®ç°é«˜å€å‹ç¼©

**ç±»æ¯”ï¼š** å°±åƒæŠŠä¸€æœ¬ä¹¦å‹ç¼©æˆç›®å½•â€”â€”åªä¿ç•™å…³é”®ä¿¡æ¯

```
åŸå§‹ï¼š[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8] â†’ 32å­—èŠ‚
PQï¼š  [23, 156]                                â†’ 2å­—èŠ‚
å‹ç¼©16å€ï¼
```

**å…³é”®ç‚¹ï¼š** æœ‰æŸå‹ç¼©ï¼Œç”¨ç©ºé—´æ¢ç²¾åº¦

---

### å¡ç‰‡2ï¼šPQçš„ä¸‰æ­¥è¿‡ç¨‹ ğŸ”„

```
Step 1: åˆ‡åˆ†ï¼ˆSplitï¼‰
768ç»´å‘é‡ â†’ 16ä¸ªå­ç©ºé—´ï¼Œæ¯ä¸ª48ç»´

Step 2: èšç±»ï¼ˆClusterï¼‰
æ¯ä¸ªå­ç©ºé—´ç‹¬ç«‹K-Meansï¼Œå¾—256ä¸ªä¸­å¿ƒ

Step 3: ç¼–ç ï¼ˆEncodeï¼‰
æ‰¾æœ€è¿‘çš„ä¸­å¿ƒï¼Œç”¨IDï¼ˆ0-255ï¼‰è¡¨ç¤º
```

**ç»“æœï¼š** 768ä¸ªfloat32 â†’ 16ä¸ªuint8

---

### å¡ç‰‡3ï¼šmå‚æ•°è¯¦è§£ ğŸ“Š

**m = å­ç©ºé—´æ•°é‡**

```
mè¶Šå°ï¼š
- æ¯ä¸ªå­ç©ºé—´ç»´åº¦è¶Šå¤§
- é‡åŒ–è¶Šç²—ç³™
- å‹ç¼©ç‡è¶Šé«˜
- ç²¾åº¦è¶Šä½

mè¶Šå¤§ï¼š
- æ¯ä¸ªå­ç©ºé—´ç»´åº¦è¶Šå°
- é‡åŒ–è¶Šç²¾ç»†
- å‹ç¼©ç‡è¶Šä½
- ç²¾åº¦è¶Šé«˜
```

**æ¨èå€¼ï¼š**
- 768ç»´ï¼šm=16ï¼ˆæ¯å­ç©ºé—´48ç»´ï¼‰
- 1536ç»´ï¼šm=32ï¼ˆæ¯å­ç©ºé—´48ç»´ï¼‰

---

### å¡ç‰‡4ï¼šnbitså‚æ•°è¯¦è§£ ğŸ”¢

**nbits = æ¯ä¸ªå­ç©ºé—´çš„ç¼–ç ä½æ•°**

```
nbits=8: 2^8=256ä¸ªèšç±»ä¸­å¿ƒ
nbits=4: 2^4=16ä¸ªèšç±»ä¸­å¿ƒ
```

**æƒè¡¡ï¼š**
| nbits | ä¸­å¿ƒæ•° | ç²¾åº¦ | å‹ç¼© |
|-------|--------|------|------|
| 8 | 256 | é«˜ | æ ‡å‡† |
| 4 | 16 | ä½ | ç¿»å€ |

**å»ºè®®ï¼š** é»˜è®¤ç”¨8ï¼Œæç«¯çœå†…å­˜ç”¨4

---

### å¡ç‰‡5ï¼šå‹ç¼©ç‡è®¡ç®— ğŸ“

```python
# å…¬å¼
åŸå§‹å¤§å° = dim * 4  # float32
PQå¤§å° = m * nbits / 8  # å­—èŠ‚
å‹ç¼©ç‡ = åŸå§‹å¤§å° / PQå¤§å°

# ç¤ºä¾‹ï¼š768ç»´ï¼Œm=16ï¼Œnbits=8
åŸå§‹ = 768 * 4 = 3072å­—èŠ‚
PQ = 16 * 8 / 8 = 16å­—èŠ‚
å‹ç¼©ç‡ = 3072 / 16 = 192å€
```

**å¿«é€Ÿä¼°ç®—è¡¨ï¼š**
| ç»´åº¦ | m | nbits | å‹ç¼©ç‡ |
|------|---|-------|--------|
| 768 | 8 | 8 | 384x |
| 768 | 16 | 8 | 192x |
| 1536 | 16 | 8 | 384x |
| 1536 | 32 | 8 | 192x |

---

### å¡ç‰‡6ï¼šç æœ¬ï¼ˆCodebookï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ“š

**ç æœ¬ = æ‰€æœ‰å­ç©ºé—´çš„èšç±»ä¸­å¿ƒé›†åˆ**

```
ç æœ¬ç»“æ„ï¼š(m, k, sub_dim)
- m: å­ç©ºé—´æ•°
- k: æ¯ä¸ªå­ç©ºé—´çš„ä¸­å¿ƒæ•°ï¼ˆ2^nbitsï¼‰
- sub_dim: å­ç©ºé—´ç»´åº¦ï¼ˆdim/mï¼‰

ç¤ºä¾‹ï¼š768ç»´ï¼Œm=16ï¼Œnbits=8
ç æœ¬å¤§å° = 16 * 256 * 48 * 4 = 3MB
```

**ç‰¹ç‚¹ï¼š**
- ä¸€æ¬¡è®­ç»ƒï¼Œç»ˆèº«ä½¿ç”¨
- æ‰€æœ‰å‘é‡å…±äº«åŒä¸€ä¸ªç æœ¬
- ç æœ¬å¤§å°è¿œå°äºèŠ‚çœçš„ç©ºé—´

---

### å¡ç‰‡7ï¼šADCè·ç¦»è®¡ç®— ğŸ”

**ADC = Asymmetric Distance Computation**

```python
# ä¼ ç»Ÿæ–¹æ³•ï¼šè§£ç åè®¡ç®—
decoded = pq.decode(code)  # è§£ç 
dist = distance(query, decoded)

# ADCæ–¹æ³•ï¼šæŸ¥è¡¨è®¡ç®—ï¼ˆæ›´å¿«ï¼‰
# 1. é¢„è®¡ç®—queryåˆ°æ‰€æœ‰ä¸­å¿ƒçš„è·ç¦»
table = precompute_distance_table(query)  # m * kè¡¨

# 2. æŸ¥è¡¨ç´¯åŠ 
dist = sum(table[i][code[i]] for i in range(m))
```

**ä¼˜ç‚¹ï¼š** ä¸éœ€è¦å®Œå…¨è§£ç ï¼Œç›´æ¥æŸ¥è¡¨

---

### å¡ç‰‡8ï¼šPQçš„ç²¾åº¦æŸå¤± âš ï¸

**ä¸ºä»€ä¹ˆä¼šæŸå¤±ç²¾åº¦ï¼Ÿ**

```
åŸå§‹å‘é‡ï¼š[0.123, 0.456]
æœ€è¿‘çš„èšç±»ä¸­å¿ƒï¼š[0.1, 0.5]
é‡åŒ–è¯¯å·®ï¼š[0.023, 0.044]

å½“ä¸¤ä¸ªå‘é‡çš„é‡åŒ–è¯¯å·®æ–¹å‘ç›¸åæ—¶
å¯èƒ½å¯¼è‡´è·ç¦»è®¡ç®—é”™è¯¯
çœŸæ­£çš„æœ€è¿‘é‚»å¯èƒ½è¢«é”™è¿‡
```

**å½±å“å› ç´ ï¼š**
- mè¶Šå°ï¼Œè¯¯å·®è¶Šå¤§
- æ•°æ®åˆ†å¸ƒè¶Šä¸å‡åŒ€ï¼Œè¯¯å·®è¶Šå¤§
- å¬å›ç‡é€šå¸¸ä¸‹é™5%-15%

---

### å¡ç‰‡9ï¼šIVF + PQ æœ€ä½³ç»„åˆ ğŸ¤

```
IVF: ç¼©å°æœç´¢èŒƒå›´
PQ: å‹ç¼©å­˜å‚¨ç©ºé—´

IVF_PQ = æ—¢å¿«åˆçœå†…å­˜

æŸ¥è¯¢æµç¨‹ï¼š
1. IVFå®šä½ç›¸å…³çš„æ¡¶ï¼ˆnprobeä¸ªï¼‰
2. åœ¨æ¡¶å†…ç”¨ADCè®¡ç®—PQè·ç¦»
3. è¿”å›top-k
```

**å‚æ•°é…ç½®ï¼š**
```python
{
    "nlist": 4096,   # IVF
    "nprobe": 32,    # IVF
    "m": 16,         # PQ
    "nbits": 8       # PQ
}
```

---

### å¡ç‰‡10ï¼šPQä½¿ç”¨åœºæ™¯ ğŸ¯

**é€‚åˆ âœ…ï¼š**
- æ•°æ®é‡å¤§ï¼ˆäº¿çº§ï¼‰
- å†…å­˜ä¸¥é‡å—é™
- å¬å›ç‡95%å¯æ¥å—
- ç¦»çº¿æ‰¹é‡æŸ¥è¯¢

**ä¸é€‚åˆ âŒï¼š**
- éœ€è¦100%ç²¾åº¦
- æ•°æ®é‡å°ï¼ˆ<100ä¸‡ï¼‰
- å¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿ
- éœ€è¦é¢‘ç¹æ›´æ–°ç æœ¬

---

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**PQï¼ˆä¹˜ç§¯é‡åŒ–ï¼‰é€šè¿‡å°†é«˜ç»´å‘é‡åˆ‡åˆ†æˆmä¸ªå­ç©ºé—´å¹¶å¯¹æ¯ä¸ªå­ç©ºé—´ç‹¬ç«‹èšç±»ç¼–ç ï¼Œå®ç°10-50å€çš„æœ‰æŸå‹ç¼©ï¼Œæ˜¯å‘é‡æ•°æ®åº“åœ¨å¤§æ•°æ®ä½å†…å­˜åœºæ™¯ä¸‹çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸¸ä¸IVFç»“åˆä½¿ç”¨ä»¥åŒæ—¶è·å¾—æœç´¢åŠ é€Ÿå’Œå­˜å‚¨å‹ç¼©ã€‚**

---

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡ ğŸ“‹

### æ ¸å¿ƒè¦ç‚¹é€ŸæŸ¥

```python
# PQæ ¸å¿ƒå‚æ•°
pq_params = {
    "m": 16,      # å­ç©ºé—´æ•°ï¼Œå¿…é¡»æ•´é™¤dim
    "nbits": 8    # ç¼–ç ä½æ•°ï¼Œå¸¸ç”¨8æˆ–4
}

# å‹ç¼©ç‡è®¡ç®—
compression = (dim * 4) / (m * nbits / 8)

# å¸¸ç”¨é…ç½®
# 768ç»´ï¼šm=16, nbits=8 â†’ å‹ç¼©192å€
# 1536ç»´ï¼šm=32, nbits=8 â†’ å‹ç¼©192å€

# å†…å­˜ä¼°ç®—
pq_memory = n_vectors * m * nbits / 8  # å­—èŠ‚
```

### å‚æ•°è°ƒä¼˜é€ŸæŸ¥è¡¨

| ç›®æ ‡ | è°ƒæ•´æ–¹æ¡ˆ | å‰¯ä½œç”¨ |
|------|---------|--------|
| æé«˜ç²¾åº¦ | å¢å¤§m | å‹ç¼©ç‡ä¸‹é™ |
| æé«˜å‹ç¼©ç‡ | å‡å°mæˆ–nbits | ç²¾åº¦ä¸‹é™ |
| å‡å°‘è®­ç»ƒæ—¶é—´ | å‡å°k(nbits) | ç²¾åº¦ä¸‹é™ |

### å­¦ä¹ æ£€æŸ¥æ¸…å• âœ…

- [ ] èƒ½è§£é‡ŠPQçš„ä¸‰æ­¥è¿‡ç¨‹ï¼ˆåˆ‡åˆ†ã€èšç±»ã€ç¼–ç ï¼‰
- [ ] ç†è§£æœ‰æŸå‹ç¼©çš„æ¦‚å¿µ
- [ ] ä¼šè®¡ç®—PQçš„å‹ç¼©ç‡
- [ ] çŸ¥é“må’Œnbitså‚æ•°çš„ä½œç”¨
- [ ] ç†è§£ç æœ¬çš„æ¦‚å¿µ
- [ ] çŸ¥é“ADCè·ç¦»è®¡ç®—çš„åŸç†
- [ ] äº†è§£IVF+PQçš„ç»„åˆä½¿ç”¨

### ä¸‹ä¸€æ­¥å­¦ä¹  ğŸš€

æŒæ¡PQåï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

1. **OPQ**ï¼šä¼˜åŒ–çš„PQï¼Œé€šè¿‡æ—‹è½¬å‡å°‘é‡åŒ–è¯¯å·®
2. **IVFADC**ï¼šIVF+ADCçš„å®ç°ç»†èŠ‚
3. **å‘é‡æ•°æ®åº“å®æˆ˜**ï¼šFaiss/Milvusä¸­çš„PQä½¿ç”¨

---

## å‚è€ƒèµ„æº ğŸ“š

1. **PQåŸè®ºæ–‡**ï¼š[Product Quantization for Nearest Neighbor Search](https://hal.inria.fr/inria-00514462/document)
2. **Faiss PQæ–‡æ¡£**ï¼šhttps://github.com/facebookresearch/faiss/wiki/Faiss-indexes#pq-and-opq
3. **Milvus IVF_PQ**ï¼šhttps://milvus.io/docs/index.md

---

**ç»“è¯­ï¼š** PQæ˜¯å‘é‡æ•°æ®åº“çš„"å†…å­˜æ•‘æ˜Ÿ"ï¼Œç†è§£å®ƒçš„åŸç†èƒ½å¸®åŠ©ä½ åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹åšå‡ºæ­£ç¡®çš„å­˜å‚¨é€‰æ‹©ã€‚è®°ä½ï¼šå‹ç¼©å’Œç²¾åº¦æ˜¯éœ€è¦æƒè¡¡çš„ï¼Œæ²¡æœ‰å…è´¹çš„åˆé¤ï¼ğŸ’ª