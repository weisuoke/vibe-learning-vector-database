# å‘é‡åŒ–è¿ç®—

> å­¦ä¹ ç›®æ ‡ï¼šç†è§£å‘é‡åŒ–è¿ç®—çš„åŸç†ï¼ŒæŒæ¡NumPyé«˜æ•ˆè®¡ç®—æ–¹æ³•ï¼Œä¸ºå‘é‡æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æ‰“ä¸‹åŸºç¡€

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**å‘é‡åŒ–è¿ç®—æ˜¯å°†å¾ªç¯æ¨åˆ°Cè¯­è¨€å±‚é¢æ‰§è¡Œçš„æŠ€æœ¯ï¼Œé€šè¿‡SIMDæŒ‡ä»¤å®ç°æ‰¹é‡è®¡ç®—ï¼Œåœ¨å‘é‡æ•°æ®åº“ä¸­å¯æå‡100-1000å€æ€§èƒ½ã€‚**

---

## 2. ã€åç›´è§‰ç‚¹ã€‘æœ€å®¹æ˜“é”™çš„3ä¸ªè¯¯åŒº

### è¯¯åŒº1ï¼šå‘é‡åŒ–åªæ˜¯è¯­æ³•ç³–ï¼Œæœ¬è´¨è¿˜æ˜¯å¾ªç¯ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å‘é‡åŒ–ä¸æ˜¯ç®€å•çš„è¯­æ³•ç®€åŒ–ï¼Œè€Œæ˜¯**æ‰§è¡Œæœºåˆ¶çš„æ ¹æœ¬æ”¹å˜**
- Pythonå¾ªç¯ï¼šæ¯æ¬¡è¿­ä»£éƒ½ç»è¿‡Pythonè§£é‡Šå™¨ï¼ˆæ…¢ï¼‰
- å‘é‡åŒ–ï¼šå¾ªç¯åœ¨Cè¯­è¨€å±‚é¢æ‰§è¡Œï¼Œä½¿ç”¨SIMDæŒ‡ä»¤ï¼ˆå¿«100å€ï¼‰

```python
import numpy as np
import time

arr = np.arange(1000000, dtype=np.float32)

# Pythonå¾ªç¯
start = time.time()
result_loop = np.zeros_like(arr)
for i in range(len(arr)):
    result_loop[i] = arr[i] ** 2  # æ¯æ¬¡éƒ½ç»è¿‡Pythonè§£é‡Šå™¨
time_loop = time.time() - start

# å‘é‡åŒ–
start = time.time()
result_vec = arr ** 2  # å•æ¬¡Pythonè°ƒç”¨ â†’ Cå±‚é¢å¾ªç¯ â†’ SIMDæŒ‡ä»¤
time_vec = time.time() - start

print(f"å¾ªç¯æ—¶é—´: {time_loop:.4f}ç§’")
print(f"å‘é‡åŒ–æ—¶é—´: {time_vec:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.1f}å€")
```

**è¾“å‡ºï¼š**
```
å¾ªç¯æ—¶é—´: 0.8234ç§’
å‘é‡åŒ–æ—¶é—´: 0.0021ç§’
åŠ é€Ÿæ¯”: 392.1å€
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- ä»£ç çœ‹èµ·æ¥åªæ˜¯è¯­æ³•ä¸Šçš„ç®€åŒ–ï¼š`arr ** 2` vs `for x in arr`
- å°æ•°æ®é‡æ—¶æ€§èƒ½å·®å¼‚ä¸æ˜æ˜¾
- ä¸äº†è§£åº•å±‚çš„SIMDæŒ‡ä»¤ä¼˜åŒ–

**æ­£ç¡®ç†è§£ï¼š**

```
Pythonå¾ªç¯ï¼š
arr[0] ** 2 â†’ Pythonè§£é‡Šå™¨ â†’ ç±»å‹æ£€æŸ¥ â†’ è°ƒç”¨__pow__ â†’ è®¡ç®— â†’ å­˜å‚¨
arr[1] ** 2 â†’ Pythonè§£é‡Šå™¨ â†’ ç±»å‹æ£€æŸ¥ â†’ è°ƒç”¨__pow__ â†’ è®¡ç®— â†’ å­˜å‚¨
... (é‡å¤100ä¸‡æ¬¡ï¼Œæ¯æ¬¡éƒ½æœ‰è§£é‡Šå™¨å¼€é”€)

å‘é‡åŒ–ï¼š
arr ** 2 â†’ Cå‡½æ•°è°ƒç”¨ â†’ {
  for i=0; i<1000000; i+=4:  // Cå¾ªç¯ï¼Œæ— è§£é‡Šå™¨å¼€é”€
    simd_power(arr[i:i+4])   // SIMDæŒ‡ä»¤ï¼Œä¸€æ¬¡è®¡ç®—4ä¸ªæ•°
}
```

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„å½±å“ï¼š**
```python
# âŒ å¾ªç¯è®¡ç®—100ä¸‡ä¸ªembeddingçš„ç›¸ä¼¼åº¦ï¼ˆæ…¢ï¼Œå‡ ç§’ï¼‰
similarities = []
for i in range(len(embeddings)):
    sim = 0
    for j in range(768):
        sim += query[j] * embeddings[i][j]
    similarities.append(sim)

# âœ… å‘é‡åŒ–ï¼ˆå¿«ï¼Œ0.01ç§’ï¼‰
similarities = embeddings @ query  # çŸ©é˜µä¹˜æ³•ï¼Œå®Œå…¨å‘é‡åŒ–
# å¿«300-500å€ï¼
```

---

### è¯¯åŒº2ï¼šæ‰€æœ‰æ“ä½œéƒ½èƒ½å‘é‡åŒ– âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- åªæœ‰**æ•°å€¼è®¡ç®—**å’Œ**è§„åˆ™æ“ä½œ**å¯ä»¥å‘é‡åŒ–
- æ¶‰åŠ**å¤æ‚é€»è¾‘**ã€**æ¡ä»¶åˆ†æ”¯**ã€**å‡½æ•°è°ƒç”¨**çš„æ“ä½œéš¾ä»¥å‘é‡åŒ–
- æŸäº›æƒ…å†µä¸‹ï¼Œå‘é‡åŒ–åè€Œæ›´æ…¢ï¼ˆå°æ•°æ®+å¤æ‚æ“ä½œï¼‰

```python
import numpy as np

# âœ… å¯ä»¥å‘é‡åŒ–ï¼ˆæ•°å€¼è®¡ç®—ï¼‰
arr = np.arange(1000)
result = arr ** 2 + 3 * arr - 5  # å®Œç¾å‘é‡åŒ–

# âš ï¸ éš¾ä»¥å‘é‡åŒ–ï¼ˆå¤æ‚é€»è¾‘ï¼‰
def complex_logic(x):
    if x < 100:
        return x ** 2
    elif x < 500:
        return x * 3
    else:
        return x // 2

# å¿…é¡»ç”¨å¾ªç¯æˆ–np.vectorizeï¼ˆä½†np.vectorizeæœ¬è´¨è¿˜æ˜¯Pythonå¾ªç¯ï¼‰
result = np.array([complex_logic(x) for x in arr])
# æˆ–
result = np.vectorize(complex_logic)(arr)  # æ²¡æœ‰åŠ é€Ÿï¼Œåªæ˜¯è¯­æ³•åŒ…è£…
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- NumPyæä¾›äº†`np.vectorize()`ï¼Œåå­—è¯¯å¯¼æ€§å¼º
- ä»¥ä¸ºæ‰€æœ‰å‡½æ•°éƒ½èƒ½è‡ªåŠ¨åŠ é€Ÿ
- ä¸äº†è§£SIMDæŒ‡ä»¤çš„å±€é™æ€§ï¼ˆåªé€‚ç”¨äºç®€å•é‡å¤æ“ä½œï¼‰

**æ­£ç¡®ç†è§£ï¼š**

| æ“ä½œç±»å‹ | èƒ½å¦å‘é‡åŒ– | åŠ é€Ÿæ•ˆæœ | ç¤ºä¾‹ |
|---------|----------|---------|------|
| ç®—æœ¯è¿ç®— | âœ… å®Œç¾ | 100-1000å€ | `+`, `-`, `*`, `/`, `**` |
| æ•°å­¦å‡½æ•° | âœ… å®Œç¾ | 50-500å€ | `np.sin()`, `np.exp()`, `np.log()` |
| æ¯”è¾ƒè¿ç®— | âœ… å®Œç¾ | 100-500å€ | `>`, `<`, `==` |
| é€»è¾‘è¿ç®— | âœ… å®Œç¾ | 100-500å€ | `&`, `|`, `~` |
| çŸ©é˜µè¿ç®— | âœ… å®Œç¾ | 100-1000å€ | `@`, `np.dot()` |
| ç®€å•æ¡ä»¶ | âš ï¸ éƒ¨åˆ† | 10-50å€ | `np.where()`, `np.select()` |
| å¤æ‚é€»è¾‘ | âŒ å›°éš¾ | æ— åŠ é€Ÿ | å¤šå±‚if-else, é€’å½’ |
| å­—ç¬¦ä¸²æ“ä½œ | âŒ ä¸é€‚ç”¨ | æ— åŠ é€Ÿ | æ–‡æœ¬å¤„ç† |

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**
```python
# âœ… å‘é‡åŒ–ï¼šè®¡ç®—ç›¸ä¼¼åº¦ï¼ˆæ•°å€¼è¿ç®—ï¼‰
similarities = embeddings @ query  # å®Œç¾å‘é‡åŒ–

# âœ… å‘é‡åŒ–ï¼šå½’ä¸€åŒ–ï¼ˆæ•°å­¦å‡½æ•°ï¼‰
norms = np.linalg.norm(embeddings, axis=1)
normalized = embeddings / norms[:, None]  # å‘é‡åŒ–

# âš ï¸ éš¾ä»¥å‘é‡åŒ–ï¼šå¤æ‚è¿‡æ»¤é€»è¾‘
# ä¾‹ï¼šæ ¹æ®æ–‡æ¡£ç±»å‹ã€æ—¶é—´ã€æ ‡ç­¾ç­‰å¤šç»´åº¦æ¡ä»¶ç­›é€‰
# æ­¤æ—¶éœ€è¦ç»„åˆå‘é‡åŒ–å’Œå¿…è¦çš„å¾ªç¯
```

---

### è¯¯åŒº3ï¼šå‘é‡åŒ–æ€»æ˜¯æœ€å¿«çš„ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å‘é‡åŒ–æœ‰**å¯åŠ¨å¼€é”€**ï¼ˆå‡½æ•°è°ƒç”¨ã€å†…å­˜åˆ†é…ï¼‰
- å°æ•°æ®é‡æ—¶ï¼Œå¼€é”€å¯èƒ½å¤§äºæ”¶ç›Š
- æŸäº›åœºæ™¯ä¸‹ï¼Œç®€å•å¾ªç¯åè€Œæ›´å¿«

```python
import numpy as np
import time

# å°æ•°æ®é‡ï¼š10ä¸ªå…ƒç´ 
small_arr = np.arange(10, dtype=np.float32)

# æµ‹è¯•1ï¼šå¾ªç¯
start = time.time()
for _ in range(100000):
    result = [x ** 2 for x in small_arr]
time_loop = time.time() - start

# æµ‹è¯•2ï¼šå‘é‡åŒ–
start = time.time()
for _ in range(100000):
    result = small_arr ** 2
time_vec = time.time() - start

print(f"å°æ•°æ®é‡(10ä¸ª):")
print(f"å¾ªç¯: {time_loop:.4f}ç§’")
print(f"å‘é‡åŒ–: {time_vec:.4f}ç§’")

# å¤§æ•°æ®é‡ï¼š100ä¸‡ä¸ªå…ƒç´ 
large_arr = np.arange(1000000, dtype=np.float32)

start = time.time()
result = [x ** 2 for x in large_arr]
time_loop_large = time.time() - start

start = time.time()
result = large_arr ** 2
time_vec_large = time.time() - start

print(f"\nå¤§æ•°æ®é‡(100ä¸‡):")
print(f"å¾ªç¯: {time_loop_large:.4f}ç§’")
print(f"å‘é‡åŒ–: {time_vec_large:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop_large/time_vec_large:.1f}å€")
```

**è¾“å‡ºï¼š**
```
å°æ•°æ®é‡(10ä¸ª):
å¾ªç¯: 0.0523ç§’
å‘é‡åŒ–: 0.0187ç§’
åŠ é€Ÿæ¯”: 2.8å€  (ä¸æ˜æ˜¾)

å¤§æ•°æ®é‡(100ä¸‡):
å¾ªç¯: 0.8234ç§’
å‘é‡åŒ–: 0.0021ç§’
åŠ é€Ÿæ¯”: 392.1å€  (æ˜¾è‘—)
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- NumPyæ•™ç¨‹æ€»æ˜¯å¼ºè°ƒ"å‘é‡åŒ–æ›´å¿«"
- å¿½ç•¥äº†æ•°æ®è§„æ¨¡çš„å½±å“
- ä¸äº†è§£å‡½æ•°è°ƒç”¨çš„å›ºå®šå¼€é”€

**æ­£ç¡®ç†è§£ï¼š**

**å‘é‡åŒ–çš„break-even pointï¼ˆç›ˆäºå¹³è¡¡ç‚¹ï¼‰ï¼š**
- æ•°æ®é‡ < 10ï¼šå¾ªç¯å¯èƒ½æ›´å¿«ï¼ˆå¼€é”€å°ï¼‰
- æ•°æ®é‡ 10-100ï¼šå·®ä¸å¤š
- æ•°æ®é‡ > 100ï¼šå‘é‡åŒ–æ˜æ˜¾æ›´å¿«
- æ•°æ®é‡ > 10000ï¼šå‘é‡åŒ–å¿«100å€ä»¥ä¸Š

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**
```python
# å‘é‡æ•°æ®åº“é€šå¸¸å¤„ç†å¤§è§„æ¨¡æ•°æ®ï¼ˆç™¾ä¸‡çº§ï¼‰
# â†’ å‘é‡åŒ–å‡ ä¹æ€»æ˜¯æœ€ä¼˜é€‰æ‹©

# ä¾‹å¤–æƒ…å†µï¼š
# 1. å•ä¸ªæŸ¥è¯¢vså•ä¸ªæ–‡æ¡£ï¼ˆ2ä¸ªå‘é‡çš„ç‚¹ç§¯ï¼‰
#    â†’ å‘é‡åŒ–ä¼˜åŠ¿ä¸æ˜æ˜¾ï¼Œä½†ä»æ¨èï¼ˆä»£ç ç®€æ´ï¼‰

# 2. æå¤æ‚çš„è‡ªå®šä¹‰ç›¸ä¼¼åº¦å‡½æ•°
#    â†’ å¯èƒ½éœ€è¦æ··åˆå‘é‡åŒ–å’Œå¾ªç¯

# 3. å®æ—¶å•ä¸ªembeddingç”Ÿæˆ
#    â†’ æ¨¡å‹æ¨ç†æ—¶é—´è¿œå¤§äºå‘é‡åŒ–æ—¶é—´ï¼Œå‘é‡åŒ–å½±å“å¯å¿½ç•¥
```

---

## 3. ã€æœ€å°å¯ç”¨ã€‘æŒæ¡20%è§£å†³80%é—®é¢˜

### 3.1 å…ƒç´ çº§ç®—æœ¯è¿ç®—ï¼ˆElementwise Operationsï¼‰

**ä¸€å¥è¯ï¼š** å¯¹æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒæ“ä½œ

```python
import numpy as np

arr = np.array([1, 2, 3, 4, 5])

# åŸºæœ¬è¿ç®—ï¼ˆä¸æ ‡é‡ï¼‰
print(arr + 10)   # [11 12 13 14 15]
print(arr - 2)    # [-1  0  1  2  3]
print(arr * 3)    # [ 3  6  9 12 15]
print(arr / 2)    # [0.5 1.  1.5 2.  2.5]
print(arr ** 2)   # [ 1  4  9 16 25]
print(arr // 2)   # [0 1 1 2 2]
print(arr % 2)    # [1 0 1 0 1]

# æ•°ç»„ä¸æ•°ç»„ï¼ˆç›¸åŒå½¢çŠ¶ï¼‰
arr1 = np.array([1, 2, 3])
arr2 = np.array([4, 5, 6])
print(arr1 + arr2)  # [5 7 9]
print(arr1 * arr2)  # [ 4 10 18]
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“ä¸­çš„åˆ†æ•°å½’ä¸€åŒ–
```python
# å°†ç›¸ä¼¼åº¦åˆ†æ•°å½’ä¸€åŒ–åˆ°[0,1]
scores = np.array([0.95, 0.87, 0.76, 0.92, 0.81])
normalized_scores = (scores - scores.min()) / (scores.max() - scores.min())
# [1.0, 0.632, 0.0, 0.842, 0.263]
```

---

### 3.2 æ•°å­¦å‡½æ•°ï¼ˆUniversal Functions - ufuncï¼‰

```python
import numpy as np

arr = np.array([1, 4, 9, 16, 25])

# å¹³æ–¹æ ¹
print(np.sqrt(arr))  # [1. 2. 3. 4. 5.]

# æŒ‡æ•°å’Œå¯¹æ•°
arr2 = np.array([1, 2, 3])
print(np.exp(arr2))   # [ 2.718  7.389 20.086]
print(np.log(arr2))   # [0.    0.693 1.099]

# ä¸‰è§’å‡½æ•°
angles = np.array([0, np.pi/2, np.pi])
print(np.sin(angles))  # [0.000 1.000 0.000]
print(np.cos(angles))  # [ 1.000  0.000 -1.000]

# å–æ•´
arr3 = np.array([1.2, 2.7, 3.5])
print(np.round(arr3))  # [1. 3. 4.]
print(np.floor(arr3))  # [1. 2. 3.]
print(np.ceil(arr3))   # [2. 3. 4.]
```

**åº”ç”¨ï¼š** softmaxå‡½æ•°ï¼ˆå¸¸ç”¨äºç›¸ä¼¼åº¦å½’ä¸€åŒ–ï¼‰
```python
def softmax(scores):
    exp_scores = np.exp(scores - scores.max())  # å‡å»æœ€å¤§å€¼é˜²æ­¢æº¢å‡º
    return exp_scores / exp_scores.sum()

scores = np.array([2.0, 1.0, 0.5])
probs = softmax(scores)
print(probs)  # [0.659 0.242 0.099] - æ¦‚ç‡å’Œä¸º1
```

---

### 3.3 å‘é‡ç‚¹ç§¯ï¼ˆDot Productï¼‰

**ä¸€å¥è¯ï¼š** ä¸¤ä¸ªå‘é‡å¯¹åº”å…ƒç´ ç›¸ä¹˜å†æ±‚å’Œï¼Œæ˜¯è®¡ç®—ç›¸ä¼¼åº¦çš„åŸºç¡€

```python
import numpy as np

# æ–¹æ³•1ï¼šnp.dot()
a = np.array([1, 2, 3])
b = np.array([4, 5, 6])
dot_product = np.dot(a, b)
print(dot_product)  # 32 = 1*4 + 2*5 + 3*6

# æ–¹æ³•2ï¼š@ è¿ç®—ç¬¦ï¼ˆæ¨èï¼‰
dot_product = a @ b
print(dot_product)  # 32

# æ–¹æ³•3ï¼šæ‰‹åŠ¨è®¡ç®—ï¼ˆå¯¹æ¯”æ€§èƒ½ï¼‰
dot_manual = sum(a[i] * b[i] for i in range(len(a)))
print(dot_manual)  # 32ï¼ˆæ…¢å¾—å¤šï¼‰
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“æ ¸å¿ƒæ“ä½œ - æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—
```python
# æŸ¥è¯¢å‘é‡ vs 100ä¸‡ä¸ªæ–‡æ¡£å‘é‡
query = np.random.rand(768)  # 768ç»´
embeddings = np.random.rand(1000000, 768)  # 100ä¸‡ä¸ª768ç»´å‘é‡

# ä¸€è¡Œä»£ç è®¡ç®—æ‰€æœ‰ç›¸ä¼¼åº¦ï¼ˆç‚¹ç§¯ï¼‰
similarities = embeddings @ query  # (1000000,) - 100ä¸‡ä¸ªåˆ†æ•°
# è¶…å¿«ï¼0.05ç§’
```

---

### 3.4 å‘é‡èŒƒæ•°ï¼ˆNormï¼‰

**ä¸€å¥è¯ï¼š** å‘é‡çš„"é•¿åº¦"ï¼Œç”¨äºå½’ä¸€åŒ–

```python
import numpy as np

v = np.array([3, 4])

# L2èŒƒæ•°ï¼ˆæ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰
l2_norm = np.linalg.norm(v)
print(l2_norm)  # 5.0 = sqrt(3^2 + 4^2)

# L1èŒƒæ•°ï¼ˆæ›¼å“ˆé¡¿è·ç¦»ï¼‰
l1_norm = np.linalg.norm(v, ord=1)
print(l1_norm)  # 7.0 = |3| + |4|

# å½’ä¸€åŒ–ï¼ˆå•ä½å‘é‡ï¼‰
unit_v = v / np.linalg.norm(v)
print(unit_v)  # [0.6 0.8]
print(np.linalg.norm(unit_v))  # 1.0
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“ä¸­çš„embeddingå½’ä¸€åŒ–
```python
# å½’ä¸€åŒ–æ‰€æœ‰embeddingï¼ˆä½¿å…¶é•¿åº¦ä¸º1ï¼‰
embeddings = np.random.rand(10000, 768)
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (10000, 1)
normalized_embeddings = embeddings / norms  # (10000, 768)

# éªŒè¯
print(np.linalg.norm(normalized_embeddings[0]))  # 1.0
```

---

### 3.5 æ¯”è¾ƒè¿ç®—ï¼ˆç”Ÿæˆå¸ƒå°”æ•°ç»„ï¼‰

```python
import numpy as np

arr = np.array([1, 5, 3, 8, 2])

# æ¯”è¾ƒè¿ç®—ï¼ˆè¿”å›å¸ƒå°”æ•°ç»„ï¼‰
print(arr > 3)   # [False  True False  True False]
print(arr == 5)  # [False  True False False False]
print(arr != 2)  # [ True  True  True  True False]

# å¤åˆæ¡ä»¶
print((arr > 2) & (arr < 8))  # [False  True  True False False]
print((arr < 2) | (arr > 7))  # [False False False  True False]

# ç»Ÿè®¡æ»¡è¶³æ¡ä»¶çš„ä¸ªæ•°
print(np.sum(arr > 3))  # 2
print(np.count_nonzero(arr > 3))  # 2
```

**åº”ç”¨ï¼š** ç»Ÿè®¡é«˜ç›¸ä¼¼åº¦ç»“æœæ•°é‡
```python
scores = np.array([0.95, 0.23, 0.87, 0.45, 0.91])
high_count = np.sum(scores > 0.8)  # 3
percentage = np.mean(scores > 0.8) * 100  # 60%
```

---

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… æ‰§è¡Œå‘é‡æ•°æ®åº“çš„æ ¸å¿ƒè¿ç®—ï¼ˆç‚¹ç§¯ã€å½’ä¸€åŒ–ï¼‰
- âœ… æ‰¹é‡è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
- âœ… å¯¹ç»“æœè¿›è¡Œè¿‡æ»¤å’Œç»Ÿè®¡
- âœ… å®ç°ç®€å•çš„ç›¸ä¼¼åº¦åº¦é‡å‡½æ•°
- âœ… ä¸ºåç»­å­¦ä¹ ï¼ˆå¹¿æ’­ã€é«˜çº§ç´¢å¼•ï¼‰æ‰“åŸºç¡€

---

## 4. ã€å®æˆ˜ä»£ç ã€‘ä¸€ä¸ªèƒ½è·‘çš„ä¾‹å­

```python
import numpy as np
import time

print("=" * 60)
print(" å‘é‡åŒ–è¿ç®—å®Œæ•´ç¤ºä¾‹ï¼šå‘é‡æ•°æ®åº“æ€§èƒ½å¯¹æ¯”")
print("=" * 60)

# ===== 1. æ€§èƒ½å¯¹æ¯”ï¼šå¾ªç¯ vs å‘é‡åŒ– =====
print("\n=== 1. æ€§èƒ½å¯¹æ¯” ===\n")

# åˆ›å»ºæµ‹è¯•æ•°æ®
size = 100000
arr = np.random.rand(size).astype(np.float32)

# æ–¹æ³•1ï¼šPythonå¾ªç¯
start = time.time()
result_loop = np.zeros(size, dtype=np.float32)
for i in range(size):
    result_loop[i] = arr[i] ** 2 + 2 * arr[i] + 1
time_loop = time.time() - start

# æ–¹æ³•2ï¼šNumPyå‘é‡åŒ–
start = time.time()
result_vec = arr ** 2 + 2 * arr + 1
time_vec = time.time() - start

print(f"å¤„ç†{size}ä¸ªå…ƒç´ :")
print(f"Pythonå¾ªç¯: {time_loop:.4f}ç§’")
print(f"NumPyå‘é‡åŒ–: {time_vec:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.1f}å€")
print(f"ç»“æœç›¸åŒ: {np.allclose(result_loop, result_vec)}")

# ===== 2. å…ƒç´ çº§è¿ç®— =====
print("\n=== 2. å…ƒç´ çº§è¿ç®— ===\n")

prices = np.array([100, 150, 200, 250, 300], dtype=np.float32)
print(f"åŸä»·: {prices}")

# æ‰“8æŠ˜
discounted = prices * 0.8
print(f"æ‰“8æŠ˜: {discounted}")

# æ»¡200å‡50
adjusted = np.where(prices >= 200, prices - 50, prices)
print(f"æ»¡200å‡50: {adjusted}")

# è®¡ç®—æ€»ä»·
quantity = np.array([2, 1, 3, 1, 2])
total = np.sum(prices * quantity)
print(f"æ•°é‡: {quantity}")
print(f"æ€»ä»·: {total:.2f}")

# ===== 3. æ•°å­¦å‡½æ•° =====
print("\n=== 3. æ•°å­¦å‡½æ•° ===\n")

values = np.array([1, 4, 9, 16, 25], dtype=np.float32)
print(f"åŸå§‹å€¼: {values}")
print(f"å¹³æ–¹æ ¹: {np.sqrt(values)}")
print(f"å¯¹æ•°: {np.log(values)}")
print(f"æŒ‡æ•°: {np.exp(values[:3])}")  # åªå–å‰3ä¸ªï¼Œé¿å…æº¢å‡º

# ===== 4. å‘é‡ç‚¹ç§¯ï¼šæ ¸å¿ƒè¿ç®— =====
print("\n=== 4. å‘é‡ç‚¹ç§¯ ===\n")

# ä¸¤ä¸ªå°å‘é‡
vec1 = np.array([1, 2, 3], dtype=np.float32)
vec2 = np.array([4, 5, 6], dtype=np.float32)

# ç‚¹ç§¯è®¡ç®—
dot_product = vec1 @ vec2
print(f"å‘é‡1: {vec1}")
print(f"å‘é‡2: {vec2}")
print(f"ç‚¹ç§¯: {dot_product}")
print(f"æ‰‹åŠ¨éªŒè¯: {1*4 + 2*5 + 3*6} = {dot_product}")

# ===== 5. å‘é‡æ•°æ®åº“åº”ç”¨ï¼šRAGæ£€ç´¢ =====
print("\n=== 5. RAGæ£€ç´¢ç¤ºä¾‹ ===\n")

# æ¨¡æ‹Ÿï¼š5ä¸ªæ–‡æ¡£ï¼Œæ¯ä¸ª4ç»´embedding
documents = [
    "Pythonç¼–ç¨‹å…¥é—¨",
    "NumPyæ•°å€¼è®¡ç®—",
    "å‘é‡æ•°æ®åº“åŸç†",
    "ç¾é£Ÿæ¨èæŒ‡å—",
    "æ—…æ¸¸æ”»ç•¥å¤§å…¨"
]

doc_embeddings = np.array([
    [0.9, 0.1, 0.8, 0.2],  # ç¼–ç¨‹ç›¸å…³
    [0.85, 0.15, 0.9, 0.1],  # ç¼–ç¨‹ç›¸å…³
    [0.8, 0.2, 0.85, 0.15],  # æŠ€æœ¯ç›¸å…³
    [0.1, 0.9, 0.2, 0.8],  # ç”Ÿæ´»ç›¸å…³
    [0.15, 0.85, 0.1, 0.9]   # ç”Ÿæ´»ç›¸å…³
], dtype=np.float32)

# ç”¨æˆ·æŸ¥è¯¢
query = "å­¦ä¹ ç¼–ç¨‹å’Œç®—æ³•"
query_embedding = np.array([0.88, 0.12, 0.82, 0.18], dtype=np.float32)

print(f"æŸ¥è¯¢: '{query}'")
print(f"æŸ¥è¯¢embedding: {query_embedding}\n")

# æ–¹æ³•1ï¼šå¾ªç¯è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆæ…¢ï¼‰
start = time.time()
similarities_loop = []
for doc_emb in doc_embeddings:
    sim = 0
    for i in range(len(query_embedding)):
        sim += query_embedding[i] * doc_emb[i]
    similarities_loop.append(sim)
time_loop = time.time() - start

# æ–¹æ³•2ï¼šå‘é‡åŒ–è®¡ç®—ï¼ˆå¿«ï¼‰
start = time.time()
similarities_vec = doc_embeddings @ query_embedding
time_vec = time.time() - start

print(f"ç›¸ä¼¼åº¦è®¡ç®—æ—¶é—´:")
print(f"å¾ªç¯æ–¹å¼: {time_loop*1000:.4f}æ¯«ç§’")
print(f"å‘é‡åŒ–: {time_vec*1000:.4f}æ¯«ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.1f}å€\n")

# æ’åºå¹¶è·å–Top-3
top_k = 3
top_indices = np.argsort(similarities_vec)[::-1][:top_k]

print(f"Top-{top_k}æœ€ç›¸å…³æ–‡æ¡£:")
for i, idx in enumerate(top_indices):
    print(f"{i+1}. [{similarities_vec[idx]:.4f}] {documents[idx]}")

# ===== 6. å‘é‡å½’ä¸€åŒ– =====
print("\n=== 6. å‘é‡å½’ä¸€åŒ– ===\n")

# æœªå½’ä¸€åŒ–çš„embedding
raw_embeddings = np.array([
    [3, 4],
    [5, 12],
    [8, 15]
], dtype=np.float32)

print(f"åŸå§‹embedding:\n{raw_embeddings}")
print(f"åŸå§‹é•¿åº¦: {np.linalg.norm(raw_embeddings, axis=1)}")

# å½’ä¸€åŒ–ï¼ˆæ–¹æ³•1ï¼šé€ä¸ªï¼‰
norms = np.linalg.norm(raw_embeddings, axis=1, keepdims=True)
normalized_embeddings = raw_embeddings / norms

print(f"\nå½’ä¸€åŒ–å:\n{normalized_embeddings}")
print(f"å½’ä¸€åŒ–é•¿åº¦: {np.linalg.norm(normalized_embeddings, axis=1)}")
print("ï¼ˆå…¨éƒ¨ä¸º1.0ï¼‰")

# ===== 7. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆçŸ©é˜µä¹˜æ³•ï¼‰=====
print("\n=== 7. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®— ===\n")

# æ¨¡æ‹Ÿï¼š100ä¸ªæ–‡æ¡£ï¼ŒæŸ¥è¯¢å…¶ä¸­5ä¸ª
num_docs = 100
num_queries = 5
embed_dim = 16

# ç”Ÿæˆéšæœºembedding
all_embeddings = np.random.rand(num_docs, embed_dim).astype(np.float32)
query_embeddings = np.random.rand(num_queries, embed_dim).astype(np.float32)

print(f"æ–‡æ¡£æ•°: {num_docs}, æŸ¥è¯¢æ•°: {num_queries}, ç»´åº¦: {embed_dim}")

# å¾ªç¯æ–¹å¼ï¼ˆæ…¢ï¼‰
start = time.time()
similarities_loop = np.zeros((num_queries, num_docs), dtype=np.float32)
for i in range(num_queries):
    for j in range(num_docs):
        similarities_loop[i, j] = np.dot(query_embeddings[i], all_embeddings[j])
time_loop = time.time() - start

# çŸ©é˜µä¹˜æ³•ï¼ˆå¿«ï¼‰
start = time.time()
similarities_matrix = query_embeddings @ all_embeddings.T  # (5, 100)
time_matrix = time.time() - start

print(f"\nè®¡ç®—æ—¶é—´:")
print(f"åŒé‡å¾ªç¯: {time_loop*1000:.4f}æ¯«ç§’")
print(f"çŸ©é˜µä¹˜æ³•: {time_matrix*1000:.4f}æ¯«ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_matrix:.1f}å€")
print(f"ç»“æœç›¸åŒ: {np.allclose(similarities_loop, similarities_matrix)}")

# ===== 8. é˜ˆå€¼è¿‡æ»¤ï¼ˆå¸ƒå°”ç´¢å¼•ï¼‰=====
print("\n=== 8. é˜ˆå€¼è¿‡æ»¤ ===\n")

scores = np.array([0.95, 0.23, 0.87, 0.45, 0.91, 0.12, 0.78], dtype=np.float32)
texts = ["æ–‡æ¡£A", "æ–‡æ¡£B", "æ–‡æ¡£C", "æ–‡æ¡£D", "æ–‡æ¡£E", "æ–‡æ¡£F", "æ–‡æ¡£G"]

print(f"æ‰€æœ‰åˆ†æ•°: {scores}")
print(f"æ‰€æœ‰æ–‡æ¡£: {texts}\n")

# é˜ˆå€¼è¿‡æ»¤
threshold = 0.8
high_conf_mask = scores > threshold
high_conf_scores = scores[high_conf_mask]
high_conf_texts = np.array(texts)[high_conf_mask]

print(f"é˜ˆå€¼: {threshold}")
print(f"é«˜ç½®ä¿¡åº¦æ•°é‡: {np.sum(high_conf_mask)}")
print(f"é«˜ç½®ä¿¡åº¦åˆ†æ•°: {high_conf_scores}")
print(f"é«˜ç½®ä¿¡åº¦æ–‡æ¡£: {list(high_conf_texts)}")

# ç»Ÿè®¡ä¿¡æ¯
print(f"\nç»Ÿè®¡:")
print(f"å¹³å‡åˆ†æ•°: {np.mean(scores):.3f}")
print(f"æœ€é«˜åˆ†æ•°: {np.max(scores):.3f}")
print(f"æœ€ä½åˆ†æ•°: {np.min(scores):.3f}")
print(f">0.8çš„å æ¯”: {np.mean(scores > 0.8)*100:.1f}%")

# ===== 9. å®é™…åœºæ™¯ï¼šæ¨èç³»ç»Ÿ =====
print("\n=== 9. æ¨èç³»ç»Ÿç¤ºä¾‹ ===\n")

# ç”¨æˆ·å†å²è¡Œä¸ºï¼ˆembeddingï¼‰
user_history = np.array([
    [0.8, 0.2, 0.7, 0.3],  # çœ‹è¿‡ç§‘æŠ€äº§å“1
    [0.75, 0.25, 0.65, 0.35],  # çœ‹è¿‡ç§‘æŠ€äº§å“2
    [0.85, 0.15, 0.75, 0.25],  # çœ‹è¿‡ç§‘æŠ€äº§å“3
], dtype=np.float32)

# è®¡ç®—ç”¨æˆ·å…´è¶£ç”»åƒï¼ˆå¹³å‡å‘é‡ï¼‰
user_profile = user_history.mean(axis=0)
print(f"ç”¨æˆ·å…´è¶£ç”»åƒ: {user_profile}")

# å€™é€‰å•†å“
items = ["ç§‘æŠ€A", "ç¾å¦†B", "æ•°ç C", "æœè£…D", "ç§‘æŠ€E"]
item_embeddings = np.array([
    [0.78, 0.22, 0.68, 0.32],  # ç§‘æŠ€
    [0.2, 0.8, 0.3, 0.7],  # ç¾å¦†
    [0.82, 0.18, 0.72, 0.28],  # æ•°ç 
    [0.3, 0.7, 0.4, 0.6],  # æœè£…
    [0.8, 0.2, 0.7, 0.3],  # ç§‘æŠ€
], dtype=np.float32)

# è®¡ç®—åŒ¹é…åº¦ï¼ˆå‘é‡åŒ–ï¼‰
match_scores = item_embeddings @ user_profile

# æ’åºæ¨è
top_k = 3
top_indices = np.argsort(match_scores)[::-1][:top_k]

print(f"\nTop-{top_k}æ¨èå•†å“:")
for i, idx in enumerate(top_indices):
    print(f"{i+1}. [{match_scores[idx]:.4f}] {items[idx]}")

# ===== 10. æ€§èƒ½åŸºå‡†æµ‹è¯• =====
print("\n=== 10. å¤§è§„æ¨¡æ€§èƒ½æµ‹è¯• ===\n")

# æ¨¡æ‹ŸçœŸå®å‘é‡æ•°æ®åº“ï¼š100ä¸‡æ–‡æ¡£ï¼Œ768ç»´
print("æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼š100ä¸‡æ–‡æ¡£ Ã— 768ç»´ embedding")
num_docs = 1000000
embed_dim = 768

# ç”Ÿæˆæ•°æ®
print("ç”Ÿæˆæµ‹è¯•æ•°æ®...")
embeddings = np.random.rand(num_docs, embed_dim).astype(np.float32)
query = np.random.rand(embed_dim).astype(np.float32)
print(f"EmbeddingçŸ©é˜µå¤§å°: {embeddings.nbytes / (1024**3):.2f} GB\n")

# æµ‹è¯•1ï¼šç‚¹ç§¯ç›¸ä¼¼åº¦
print("æµ‹è¯•1: è®¡ç®—100ä¸‡ä¸ªç‚¹ç§¯ç›¸ä¼¼åº¦")
start = time.time()
similarities = embeddings @ query
time_dot = time.time() - start
print(f"  è€—æ—¶: {time_dot:.4f}ç§’")
print(f"  ååé‡: {num_docs/time_dot:.0f} docs/ç§’\n")

# æµ‹è¯•2ï¼šå½’ä¸€åŒ–
print("æµ‹è¯•2: å½’ä¸€åŒ–100ä¸‡ä¸ªå‘é‡")
start = time.time()
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
normalized = embeddings / norms
time_norm = time.time() - start
print(f"  è€—æ—¶: {time_norm:.4f}ç§’\n")

# æµ‹è¯•3ï¼šTop-Kæ’åº
k = 100
print(f"æµ‹è¯•3: æ‰¾å‡ºTop-{k}ç»“æœ")
start = time.time()
top_k_indices = np.argpartition(similarities, -k)[-k:]
top_k_sorted = top_k_indices[np.argsort(similarities[top_k_indices])[::-1]]
time_topk = time.time() - start
print(f"  è€—æ—¶: {time_topk:.4f}ç§’\n")

# æ€»ç»“
print("æ€»ç»“:")
print(f"  å•æ¬¡æŸ¥è¯¢æ€»æ—¶é—´: {time_dot + time_topk:.4f}ç§’")
print(f"  æ¯ç§’å¯å¤„ç†æŸ¥è¯¢æ•°: {1/(time_dot + time_topk):.1f} QPS")

print("\n" + "=" * 60)
print(" æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
print("=" * 60)
```

---

## 5. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯å‘é‡åŒ–è¿ç®—ï¼Ÿä¸ºä»€ä¹ˆå®ƒæ¯”å¾ªç¯å¿«ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"å‘é‡åŒ–å°±æ˜¯ç”¨NumPyæ•°ç»„ä»£æ›¿å¾ªç¯ï¼Œå› ä¸ºNumPyæ˜¯ç”¨Cå†™çš„æ‰€ä»¥å¿«ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **å‘é‡åŒ–è¿ç®—æ˜¯å°†æ•°æ®çº§å¹¶è¡Œæ¨åˆ°ä½å±‚è¯­è¨€æ‰§è¡Œçš„æŠ€æœ¯ï¼Œæœ‰ä¸‰å±‚åŠ é€Ÿæœºåˆ¶ï¼š**
>
> 1. **æ¶ˆé™¤Pythonè§£é‡Šå™¨å¼€é”€**ï¼š
>    - Pythonå¾ªç¯ï¼šæ¯æ¬¡è¿­ä»£éƒ½è¦è§£é‡Šå™¨å¤„ç†ï¼ˆç±»å‹æ£€æŸ¥ã€å‡½æ•°è°ƒç”¨ç­‰ï¼‰
>    - å‘é‡åŒ–ï¼šå•æ¬¡Pythonè°ƒç”¨ï¼Œå¾ªç¯åœ¨Cè¯­è¨€å±‚é¢æ‰§è¡Œ
>    - ä¸¾ä¾‹ï¼š100ä¸‡æ¬¡å¾ªç¯ï¼ŒPythonæ–¹å¼æœ‰100ä¸‡æ¬¡è§£é‡Šå¼€é”€ï¼Œå‘é‡åŒ–åªæœ‰1æ¬¡
>
> 2. **SIMDæŒ‡ä»¤çº§å¹¶è¡Œ**ï¼š
>    - ç°ä»£CPUæ”¯æŒSIMDï¼ˆSingle Instruction Multiple Dataï¼‰
>    - ä¸€æ¡æŒ‡ä»¤å¯åŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®ï¼ˆå¦‚4ä¸ªfloat32ï¼‰
>    - NumPyè‡ªåŠ¨åˆ©ç”¨SIMDï¼ŒPythonå¾ªç¯æ— æ³•åˆ©ç”¨
>    - ä¸¾ä¾‹ï¼šè®¡ç®—100ä¸‡ä¸ªå¹³æ–¹ï¼ŒSIMDå¯4ä¸ªä¸€ç»„ï¼Œåªéœ€25ä¸‡æ¡æŒ‡ä»¤
>
> 3. **ç¼“å­˜å±€éƒ¨æ€§ä¼˜åŒ–**ï¼š
>    - NumPyæ•°ç»„è¿ç»­å­˜å‚¨ï¼Œè®¿é—®cache-friendly
>    - å¾ªç¯ä¸­çš„Pythonå¯¹è±¡åˆ†æ•£å­˜å‚¨ï¼Œé¢‘ç¹cache miss
>
> **å®æµ‹æ•°æ®**ï¼š
> - ç®€å•è¿ç®—ï¼ˆåŠ æ³•ã€ä¹˜æ³•ï¼‰ï¼š50-100å€åŠ é€Ÿ
> - å¤æ‚è¿ç®—ï¼ˆä¸‰è§’å‡½æ•°ã€æŒ‡æ•°ï¼‰ï¼š100-500å€åŠ é€Ÿ
> - çŸ©é˜µè¿ç®—ï¼ˆåˆ©ç”¨BLASåº“ï¼‰ï¼š1000å€ä»¥ä¸ŠåŠ é€Ÿ
>
> **åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨**ï¼š
> è®¡ç®—100ä¸‡ä¸ªembeddingä¸æŸ¥è¯¢å‘é‡çš„ç›¸ä¼¼åº¦ï¼š
> - Pythonå¾ªç¯ï¼š3-5ç§’
> - NumPyå‘é‡åŒ–ï¼š0.01-0.05ç§’
> - è¿™ä½¿å¾—å®æ—¶æ£€ç´¢æˆä¸ºå¯èƒ½

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†ä¸‰ä¸ªå±‚é¢è§£é‡Šï¼ˆè§£é‡Šå™¨ã€SIMDã€ç¼“å­˜ï¼‰
2. âœ… ç»™å‡ºå…·ä½“çš„æ•°å­—å’Œä¾‹å­
3. âœ… æåˆ°äº†åº•å±‚åŸç†ï¼ˆSIMDã€ç¼“å­˜ï¼‰
4. âœ… è¿æ¥åˆ°å‘é‡æ•°æ®åº“å®é™…åº”ç”¨
5. âœ… å±•ç¤ºäº†å¯¹æ€§èƒ½ä¼˜åŒ–çš„æ·±å…¥ç†è§£

---

### é—®é¢˜2ï¼š"æ‰€æœ‰æ“ä½œéƒ½èƒ½å‘é‡åŒ–å—ï¼Ÿæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ä¸æ˜¯æ‰€æœ‰æ“ä½œéƒ½èƒ½æœ‰æ•ˆå‘é‡åŒ–ï¼Œæœ‰ä¸‰ç±»é™åˆ¶ï¼š**
>
> 1. **æ•°æ®ä¾èµ–é™åˆ¶**ï¼š
>    - å½“å‰è¿­ä»£ä¾èµ–å‰ä¸€æ¬¡ç»“æœæ—¶éš¾ä»¥å‘é‡åŒ–
>    - ä¾‹ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ— `f(n) = f(n-1) + f(n-2)`
>    - æ­¤æ—¶å¿…é¡»é¡ºåºè®¡ç®—ï¼Œæ— æ³•å¹¶è¡Œ
>
> 2. **å¤æ‚é€»è¾‘é™åˆ¶**ï¼š
>    - å¤šå±‚if-elseã€å¤æ‚æ¡ä»¶åˆ†æ”¯
>    - å¯ä»¥ç”¨`np.where()`ã€`np.select()`éƒ¨åˆ†å‘é‡åŒ–
>    - ä½†æ•ˆæœä¸å¦‚ç®€å•æ•°å€¼è¿ç®—æ˜æ˜¾
>
> 3. **æ•°æ®è§„æ¨¡é™åˆ¶**ï¼š
>    - å‘é‡åŒ–æœ‰å›ºå®šå¼€é”€ï¼ˆå‡½æ•°è°ƒç”¨ã€å†…å­˜åˆ†é…ï¼‰
>    - æ•°æ®é‡å°æ—¶ï¼ˆ<100å…ƒç´ ï¼‰ï¼Œå¼€é”€å¯èƒ½å¤§äºæ”¶ç›Š
>    - Break-even pointé€šå¸¸åœ¨100-1000å…ƒç´ ä¹‹é—´
>
> **æœ€ä½³å®è·µï¼ˆå‘é‡æ•°æ®åº“åœºæ™¯ï¼‰ï¼š**
> - âœ… ç‚¹ç§¯ã€å½’ä¸€åŒ–ã€çŸ©é˜µä¹˜æ³•ï¼šå®Œç¾å‘é‡åŒ–
> - âš ï¸ å¤æ‚è¿‡æ»¤é€»è¾‘ï¼šç»„åˆå‘é‡åŒ–å’Œå¿…è¦å¾ªç¯
> - âŒ å•ä¸ªembeddingç”Ÿæˆï¼šç“¶é¢ˆåœ¨æ¨¡å‹æ¨ç†ï¼Œå‘é‡åŒ–å½±å“å°
>
> **æƒè¡¡ç­–ç•¥ï¼š**
> - å¤§è§„æ¨¡æ•°å€¼è®¡ç®— â†’ ä¼˜å…ˆå‘é‡åŒ–
> - å¤æ‚ä¸šåŠ¡é€»è¾‘ â†’ å¯è¯»æ€§ä¼˜å…ˆ
> - æ€§èƒ½å…³é”®è·¯å¾„ â†’ profilingåå†³å®š

---

## 6. ã€åŒ–éª¨ç»µæŒã€‘10ä¸ª2åˆ†é’ŸçŸ¥è¯†å¡ç‰‡

### å¡ç‰‡1ï¼šå‘é‡åŒ–çš„æœ¬è´¨ ğŸ¯

**ä¸€å¥è¯ï¼š** å‘é‡åŒ–=å°†å¾ªç¯ä»Pythonå±‚æ¨åˆ°Cå±‚+åˆ©ç”¨SIMDå¹¶è¡ŒæŒ‡ä»¤

**ä¸¾ä¾‹ï¼š**
```python
# Pythonå±‚å¾ªç¯ï¼ˆæ…¢ï¼‰
for i in range(1000000):
    result[i] = arr[i] ** 2
# 100ä¸‡æ¬¡Pythonè§£é‡Šå™¨è°ƒç”¨

# Cå±‚å¾ªç¯ï¼ˆå¿«ï¼‰
result = arr ** 2
# 1æ¬¡Pythonè°ƒç”¨ â†’ Cçš„forå¾ªç¯ â†’ SIMDå¹¶è¡Œè®¡ç®—
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“ä¸­ï¼Œ100ä¸‡embeddingç›¸ä¼¼åº¦è®¡ç®—ä»3ç§’é™åˆ°0.03ç§’

---

### å¡ç‰‡2ï¼šå…ƒç´ çº§è¿ç®— â•

**ä¸€å¥è¯ï¼š** å¯¹æ•°ç»„æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒæ“ä½œï¼Œæ˜¯æœ€ç®€å•çš„å‘é‡åŒ–

```python
arr = np.array([1, 2, 3, 4, 5])

# æ ‡é‡è¿ç®—
arr + 10  # æ¯ä¸ªå…ƒç´ +10
arr * 2   # æ¯ä¸ªå…ƒç´ Ã—2
arr ** 2  # æ¯ä¸ªå…ƒç´ å¹³æ–¹

# æ•°ç»„è¿ç®—ï¼ˆåŒå½¢çŠ¶ï¼‰
arr1 + arr2  # å¯¹åº”å…ƒç´ ç›¸åŠ 
arr1 * arr2  # å¯¹åº”å…ƒç´ ç›¸ä¹˜
```

**åº”ç”¨ï¼š** åˆ†æ•°å½’ä¸€åŒ–ã€æƒé‡è°ƒæ•´ã€ç‰¹å¾ç¼©æ”¾

---

### å¡ç‰‡3ï¼šé€šç”¨å‡½æ•°ï¼ˆufuncï¼‰ğŸ“

**ä¸€å¥è¯ï¼š** NumPyçš„å‘é‡åŒ–æ•°å­¦å‡½æ•°ï¼Œè‡ªåŠ¨åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ 

```python
arr = np.array([1, 4, 9, 16, 25])

np.sqrt(arr)  # å¹³æ–¹æ ¹ [1, 2, 3, 4, 5]
np.log(arr)   # å¯¹æ•°
np.exp(arr)   # æŒ‡æ•°ï¼ˆå°å¿ƒæº¢å‡ºï¼ï¼‰
np.sin(arr)   # ä¸‰è§’å‡½æ•°
```

**å¸¸ç”¨ufuncï¼š**
- æ•°å­¦ï¼š`sqrt`, `exp`, `log`, `log10`, `log2`
- ä¸‰è§’ï¼š`sin`, `cos`, `tan`, `arcsin`, `arccos`
- å–æ•´ï¼š`round`, `floor`, `ceil`, `trunc`
- ç¬¦å·ï¼š`abs`, `sign`

**åº”ç”¨ï¼š** softmaxã€sigmoidã€ReLUç­‰æ¿€æ´»å‡½æ•°

---

### å¡ç‰‡4ï¼šå‘é‡ç‚¹ç§¯ - ç›¸ä¼¼åº¦æ ¸å¿ƒ ğŸ¯

**ä¸€å¥è¯ï¼š** ä¸¤å‘é‡å¯¹åº”å…ƒç´ ç›¸ä¹˜å†æ±‚å’Œï¼Œè¡¡é‡ç›¸ä¼¼åº¦çš„åŸºç¡€

```python
a = np.array([1, 2, 3])
b = np.array([4, 5, 6])

# ä¸‰ç§å†™æ³•
np.dot(a, b)   # 32
a @ b          # 32ï¼ˆæ¨èï¼‰
(a * b).sum()  # 32ï¼ˆæ‰‹åŠ¨ï¼‰
```

**æ•°å­¦å…¬å¼ï¼š**
```
a Â· b = aâ‚bâ‚ + aâ‚‚bâ‚‚ + aâ‚ƒbâ‚ƒ + ... + aâ‚™bâ‚™
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“æœ€æ ¸å¿ƒè¿ç®—
```python
# æŸ¥è¯¢ vs 100ä¸‡æ–‡æ¡£
query @ embeddings.T  # ä¸€è¡Œä»£ç ï¼Œ0.05ç§’
```

---

### å¡ç‰‡5ï¼šçŸ©é˜µä¹˜æ³• - æ‰¹é‡ç‚¹ç§¯ ğŸ”¢

**ä¸€å¥è¯ï¼š** ä¸€æ¬¡æ€§è®¡ç®—å¤šä¸ªå‘é‡ä¹‹é—´çš„ç‚¹ç§¯

```python
# 5ä¸ªæŸ¥è¯¢ Ã— 100ä¸ªæ–‡æ¡£
queries = np.random.rand(5, 768)      # (5, 768)
embeddings = np.random.rand(100, 768)  # (100, 768)

# æ‰¹é‡è®¡ç®—æ‰€æœ‰ç›¸ä¼¼åº¦
similarities = queries @ embeddings.T  # (5, 100)
# 500ä¸ªç‚¹ç§¯ï¼Œä¸€æ¬¡å®Œæˆï¼
```

**å½¢çŠ¶è§„åˆ™ï¼š**
```
(m, n) @ (n, p) = (m, p)
å†…ä¾§ç»´åº¦å¿…é¡»åŒ¹é…(n)
```

**åº”ç”¨ï¼š** æ‰¹é‡æŸ¥è¯¢å‘é‡æ•°æ®åº“

---

### å¡ç‰‡6ï¼šå‘é‡èŒƒæ•° - é•¿åº¦åº¦é‡ ğŸ“

**ä¸€å¥è¯ï¼š** å‘é‡çš„"é•¿åº¦"ï¼Œç”¨äºå½’ä¸€åŒ–å’Œè·ç¦»è®¡ç®—

```python
v = np.array([3, 4])

# L2èŒƒæ•°ï¼ˆæ¬§å‡ é‡Œå¾—ï¼‰
np.linalg.norm(v)  # 5.0 = âˆš(3Â²+4Â²)

# L1èŒƒæ•°ï¼ˆæ›¼å“ˆé¡¿ï¼‰
np.linalg.norm(v, ord=1)  # 7.0 = |3|+|4|

# å½’ä¸€åŒ–
v / np.linalg.norm(v)  # [0.6, 0.8]
```

**åº”ç”¨ï¼š** embeddingå½’ä¸€åŒ–ï¼ˆä½¿ä½™å¼¦ç›¸ä¼¼åº¦=ç‚¹ç§¯ï¼‰
```python
# å½’ä¸€åŒ–åï¼Œä½™å¼¦ç›¸ä¼¼åº¦ç›´æ¥ç”¨ç‚¹ç§¯è®¡ç®—
norm_query @ norm_embeddings.T  # å°±æ˜¯ä½™å¼¦ç›¸ä¼¼åº¦
```

---

### å¡ç‰‡7ï¼šæ¯”è¾ƒè¿ç®— - ç”Ÿæˆæ©ç  ğŸ”

**ä¸€å¥è¯ï¼š** ç”Ÿæˆå¸ƒå°”æ•°ç»„ï¼Œç”¨äºæ¡ä»¶è¿‡æ»¤

```python
scores = np.array([0.95, 0.23, 0.87, 0.45, 0.91])

# ç”Ÿæˆå¸ƒå°”æ©ç 
mask = scores > 0.8  # [True, False, True, False, True]

# ç”¨æ©ç è¿‡æ»¤
high_scores = scores[mask]  # [0.95, 0.87, 0.91]

# ç»Ÿè®¡
np.sum(mask)   # 3 - æœ‰3ä¸ª>0.8
np.mean(mask)  # 0.6 - 60%>0.8
```

**å¤åˆæ¡ä»¶ï¼š**
```python
(scores > 0.5) & (scores < 0.9)  # ANDï¼ˆæ³¨æ„ç”¨&ä¸æ˜¯andï¼‰
(scores < 0.3) | (scores > 0.9)  # OR
~(scores > 0.5)                  # NOT
```

**åº”ç”¨ï¼š** é˜ˆå€¼è¿‡æ»¤ã€è´¨é‡æ§åˆ¶

---

### å¡ç‰‡8ï¼šå¹¿æ’­é¢„å‘Š - å½¢çŠ¶è‡ªåŠ¨å¯¹é½ ğŸ“¡

**ä¸€å¥è¯ï¼š** ä¸åŒå½¢çŠ¶çš„æ•°ç»„è¿ç®—æ—¶ï¼ŒNumPyè‡ªåŠ¨æ‰©å±•ç»´åº¦

```python
arr = np.array([[1, 2, 3],
                [4, 5, 6]])  # (2, 3)

# æ•°ç»„ + æ ‡é‡ï¼ˆè‡ªåŠ¨å¹¿æ’­ï¼‰
arr + 10  # 10è‡ªåŠ¨æ‰©å±•æˆ(2,3)çš„æ•°ç»„

# æ•°ç»„ + ä¸€ç»´æ•°ç»„
row = np.array([10, 20, 30])  # (3,)
arr + row  # rowè‡ªåŠ¨å¹¿æ’­æˆ(2,3)
# [[11 22 33]
#  [14 25 36]]
```

**ä¸‹èŠ‚è¯¾è¯¦ç»†è®²ï¼**

---

### å¡ç‰‡9ï¼šæ€§èƒ½æµ‹è¯•æŠ€å·§ â±ï¸

**ä¸€å¥è¯ï¼š** ç”¨`%timeit`ï¼ˆJupyterï¼‰æˆ–`time.time()`æµ‹é‡æ€§èƒ½

```python
import time

# æ–¹æ³•1ï¼štime.time()
start = time.time()
result = arr ** 2
elapsed = time.time() - start
print(f"è€—æ—¶: {elapsed:.4f}ç§’")

# æ–¹æ³•2ï¼šåœ¨Jupyterä¸­
%timeit arr ** 2
# 100 loops, best of 3: 2.1 ms per loop
```

**æ³¨æ„äº‹é¡¹ï¼š**
- æµ‹è¯•å‰å…ˆwarm-upï¼ˆè¿è¡Œ1æ¬¡é¿å…å†·å¯åŠ¨ï¼‰
- å¤šæ¬¡æµ‹è¯•å–å¹³å‡
- æ•°æ®é‡è¦è¶³å¤Ÿå¤§ï¼ˆ>1000ï¼‰æ‰èƒ½çœ‹å‡ºå·®å¼‚

**åº”ç”¨ï¼š** ä¼˜åŒ–å‘é‡æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

---

### å¡ç‰‡10ï¼šä½•æ—¶ä¸ç”¨å‘é‡åŒ– âš ï¸

**ä¸€å¥è¯ï¼š** ä¸‰ç§æƒ…å†µä¸‹å¾ªç¯å¯èƒ½æ›´å¥½

**æƒ…å†µ1ï¼šæ•°æ®é‡æå°**
```python
# <10ä¸ªå…ƒç´ æ—¶ï¼Œå¾ªç¯å¯èƒ½æ›´å¿«
small = [1, 2, 3, 4, 5]
[x**2 for x in small]  # å¯èƒ½æ¯”np.array([...])**2å¿«
```

**æƒ…å†µ2ï¼šå¤æ‚ä¸šåŠ¡é€»è¾‘**
```python
# å¤šå±‚if-elseã€å¤æ‚è§„åˆ™
for doc in documents:
    if doc.type == "A" and doc.score > 0.8:
        if doc.date > threshold:
            # å¤æ‚å¤„ç†...
# å¼ºè¡Œå‘é‡åŒ–åè€Œéš¾è¯»
```

**æƒ…å†µ3ï¼šå¯è¯»æ€§ä¼˜å…ˆ**
```python
# å‘é‡åŒ–ä»£ç å¤ªæ™¦æ¶©æ—¶ï¼Œç”¨å¾ªç¯
# ä¾‹ï¼šå¤æ‚çš„çŠ¶æ€æœºã€é€’å½’é€»è¾‘
```

**åŸåˆ™ï¼š** å…ˆæ­£ç¡®ï¼Œå†ä¼˜åŒ–ï¼›profilingåå†³å®š

---

## 7. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šSIMDå¹¶è¡Œ ğŸš€

**Single Instruction Multiple Data - ä¸€æ¡æŒ‡ä»¤å¤„ç†å¤šä¸ªæ•°æ®**

#### ä¼ ç»Ÿä¸²è¡Œ vs SIMDå¹¶è¡Œ

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸€æ¬¡ä¸€ä¸ªï¼‰ï¼š
æŒ‡ä»¤1: è®¡ç®— arr[0] ** 2 â†’ result[0]
æŒ‡ä»¤2: è®¡ç®— arr[1] ** 2 â†’ result[1]
æŒ‡ä»¤3: è®¡ç®— arr[2] ** 2 â†’ result[2]
æŒ‡ä»¤4: è®¡ç®— arr[3] ** 2 â†’ result[3]
æ€»å…±: 4æ¡æŒ‡ä»¤

SIMDæ–¹å¼ï¼ˆä¸€æ¬¡å››ä¸ªï¼‰ï¼š
æŒ‡ä»¤1: åŒæ—¶è®¡ç®— [arr[0], arr[1], arr[2], arr[3]] ** 2
       â†’ [result[0], result[1], result[2], result[3]]
æ€»å…±: 1æ¡æŒ‡ä»¤ï¼ˆå¿«4å€ï¼‰
```

#### ä»£ç å¯¹æ¯”

```python
import numpy as np

# å‡†å¤‡æ•°æ®ï¼ˆ4ä¸ªfloat32ï¼‰
arr = np.array([1.0, 2.0, 3.0, 4.0], dtype=np.float32)

# NumPyä¼šè‡ªåŠ¨ä½¿ç”¨SIMDï¼ˆå¦‚æœCPUæ”¯æŒï¼‰
result = arr ** 2
# CPUå®é™…æ‰§è¡Œï¼šä¸€æ¡SIMDæŒ‡ä»¤åŒæ—¶è®¡ç®—4ä¸ªå¹³æ–¹
# ç»“æœï¼š[1.0, 4.0, 9.0, 16.0]
```

#### SIMDçš„ç¡¬ä»¶æ”¯æŒ

**å¸¸è§SIMDæŒ‡ä»¤é›†ï¼š**
- **SSE** (Streaming SIMD Extensions): 128ä½ï¼Œå¤„ç†4ä¸ªfloat32æˆ–2ä¸ªfloat64
- **AVX** (Advanced Vector Extensions): 256ä½ï¼Œå¤„ç†8ä¸ªfloat32æˆ–4ä¸ªfloat64
- **AVX-512**: 512ä½ï¼Œå¤„ç†16ä¸ªfloat32æˆ–8ä¸ªfloat64

```python
# æ£€æŸ¥CPUæ˜¯å¦æ”¯æŒAVX
import numpy as np
print(np.show_config())
# ä¼šæ˜¾ç¤ºNumPyç¼–è¯‘æ—¶æ˜¯å¦å¯ç”¨AVX
```

#### å®é™…æ€§èƒ½æå‡

```python
import numpy as np
import time

# æµ‹è¯•ï¼š100ä¸‡ä¸ªfloat32æ±‚å¹³æ–¹
size = 1000000
arr = np.random.rand(size).astype(np.float32)

# çº¯Pythonå¾ªç¯ï¼ˆæ— SIMDï¼‰
start = time.time()
result = [x ** 2 for x in arr]
time_python = time.time() - start

# NumPyå‘é‡åŒ–ï¼ˆå¯ç”¨SIMDï¼‰
start = time.time()
result = arr ** 2
time_numpy = time.time() - start

print(f"Pythonå¾ªç¯: {time_python:.4f}ç§’")
print(f"NumPy+SIMD: {time_numpy:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_python/time_numpy:.1f}å€")
```

**å…¸å‹è¾“å‡ºï¼š**
```
Pythonå¾ªç¯: 0.3245ç§’
NumPy+SIMD: 0.0018ç§’
åŠ é€Ÿæ¯”: 180.3å€
```

#### å‘é‡æ•°æ®åº“ä¸­çš„SIMDåº”ç”¨

```python
# è®¡ç®—100ä¸‡ä¸ªembeddingä¸æŸ¥è¯¢çš„ç‚¹ç§¯
query = np.random.rand(768).astype(np.float32)
embeddings = np.random.rand(1000000, 768).astype(np.float32)

# çŸ©é˜µä¹˜æ³•ä¼šè‡ªåŠ¨åˆ©ç”¨SIMD
similarities = embeddings @ query
# CPUä¼šç”¨SIMDæŒ‡ä»¤å¹¶è¡Œè®¡ç®—æ¯ä¸ªç‚¹ç§¯
# æ˜¾è‘—åŠ é€Ÿï¼ˆ100-300å€ï¼‰
```

**ä¸ºä»€ä¹ˆSIMDå¯¹å‘é‡æ•°æ®åº“é‡è¦ï¼Ÿ**
1. Embeddingç»´åº¦é«˜ï¼ˆ768-1536ç»´ï¼‰â†’ SIMDå¹¶è¡Œåº¦é«˜
2. ç‚¹ç§¯è®¡ç®—æ˜¯ç“¶é¢ˆ â†’ SIMDæ˜¾è‘—åŠ é€Ÿ
3. ç°ä»£CPUæ™®éæ”¯æŒAVX â†’ å…è´¹çš„æ€§èƒ½æå‡

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šå†…å­˜å¸ƒå±€ä¼˜åŒ– ğŸ§±

**è¿ç»­å†…å­˜ + ç¼“å­˜å±€éƒ¨æ€§ = é«˜æ€§èƒ½**

#### å†…å­˜å±‚æ¬¡ç»“æ„

```
L1 Cache    ~1ns     32-64KB
L2 Cache    ~3ns     256KB-1MB
L3 Cache    ~12ns    8-32MB
RAM         ~100ns   8-64GB
SSD         ~100Î¼s   256GB-4TB
HDD         ~10ms    1-8TB

é€Ÿåº¦å·®å¼‚ï¼šL1æ˜¯RAMçš„100å€ï¼Œæ˜¯HDDçš„10,000,000å€ï¼
```

#### ç¼“å­˜å‹å¥½ vs ç¼“å­˜ä¸å‹å¥½

```python
import numpy as np

# Cache-friendlyï¼ˆè¿ç»­è®¿é—®ï¼‰
arr = np.arange(1000000)
result = arr ** 2  # é¡ºåºè®¿é—®ï¼Œcacheå‘½ä¸­ç‡é«˜

# Cache-unfriendlyï¼ˆéšæœºè®¿é—®ï¼‰
indices = np.random.permutation(1000000)
result = arr[indices] ** 2  # éšæœºè®¿é—®ï¼Œcache misså¤š
```

#### è¡Œä¼˜å…ˆ vs åˆ—ä¼˜å…ˆ

**NumPyé»˜è®¤è¡Œä¼˜å…ˆï¼ˆC-orderï¼‰ï¼š**
```python
arr = np.array([[1, 2, 3],
                [4, 5, 6]], order='C')

# å†…å­˜å¸ƒå±€ï¼š[1, 2, 3, 4, 5, 6]
# æŒ‰è¡Œè¿ç»­å­˜å‚¨

# è®¿é—®ä¸€è¡Œï¼šcache-friendly
row = arr[0, :]  # [1, 2, 3] - è¿ç»­å†…å­˜

# è®¿é—®ä¸€åˆ—ï¼šcache-unfriendly
col = arr[:, 0]  # [1, 4] - è·³è·ƒè®¿é—®
```

**åˆ—ä¼˜å…ˆï¼ˆF-orderï¼ŒFortranï¼‰ï¼š**
```python
arr = np.array([[1, 2, 3],
                [4, 5, 6]], order='F')

# å†…å­˜å¸ƒå±€ï¼š[1, 4, 2, 5, 3, 6]
# æŒ‰åˆ—è¿ç»­å­˜å‚¨

# è®¿é—®ä¸€åˆ—ï¼šcache-friendly
col = arr[:, 0]  # [1, 4] - è¿ç»­å†…å­˜
```

#### å‘é‡æ•°æ®åº“ä¸­çš„å†…å­˜ä¼˜åŒ–

```python
# å…¸å‹embeddingçŸ©é˜µï¼ˆè¡Œä¼˜å…ˆï¼‰
embeddings = np.zeros((1000000, 768), dtype=np.float32, order='C')
# å†…å­˜å¸ƒå±€ï¼šæ¯ä¸ªembeddingçš„768ä¸ªç»´åº¦è¿ç»­å­˜å‚¨

# è®¡ç®—ç‚¹ç§¯ï¼ˆcache-friendlyï¼‰
query = np.random.rand(768).astype(np.float32)
similarities = embeddings @ query
# æ¯æ¬¡è¯»å–ä¸€ä¸ªembeddingï¼ˆè¿ç»­çš„768ä¸ªfloat32ï¼‰
# Cacheå‘½ä¸­ç‡é«˜ï¼Œæ€§èƒ½å¥½ï¼

# å¦‚æœç”¨åˆ—ä¼˜å…ˆä¼šæ€æ ·ï¼Ÿ
embeddings_F = embeddings.T.copy(order='F')  # (768, 1000000), åˆ—ä¼˜å…ˆ
# å†…å­˜å¸ƒå±€ï¼šç¬¬1ç»´çš„100ä¸‡ä¸ªå€¼è¿ç»­ï¼Œç¬¬2ç»´çš„100ä¸‡ä¸ªå€¼è¿ç»­...
# è®¡ç®—ç‚¹ç§¯æ—¶éœ€è¦è·³è·ƒè®¿é—® â†’ cache misså¤š â†’ æ…¢ï¼
```

#### å®æµ‹å¯¹æ¯”

```python
import time

num_docs = 100000
embed_dim = 768

# è¡Œä¼˜å…ˆï¼ˆæ¨èï¼‰
emb_C = np.random.rand(num_docs, embed_dim).astype(np.float32)  # C-order
query = np.random.rand(embed_dim).astype(np.float32)

start = time.time()
sim_C = emb_C @ query
time_C = time.time() - start

# åˆ—ä¼˜å…ˆï¼ˆä¸æ¨èï¼‰
emb_F = emb_C.T.copy(order='F')  # (768, 100000), F-order

start = time.time()
sim_F = emb_F.T @ query
time_F = time.time() - start

print(f"è¡Œä¼˜å…ˆ: {time_C:.4f}ç§’")
print(f"åˆ—ä¼˜å…ˆ: {time_F:.4f}ç§’")
print(f"è¡Œä¼˜å…ˆå¿«{time_F/time_C:.1f}å€")
```

**å…¸å‹è¾“å‡ºï¼š**
```
è¡Œä¼˜å…ˆ: 0.0123ç§’
åˆ—ä¼˜å…ˆ: 0.0367ç§’
è¡Œä¼˜å…ˆå¿«3.0å€
```

**å…³é”®ç‚¹ï¼š**
- å‘é‡æ•°æ®åº“embeddingçŸ©é˜µå¿…é¡»è¡Œä¼˜å…ˆ
- æ¯ä¸ªembeddingæ˜¯ä¸€è¡Œï¼Œç»´åº¦è¿ç»­å­˜å‚¨
- è®¡ç®—ç‚¹ç§¯æ—¶é¡ºåºè¯»å–ï¼Œcacheå‹å¥½

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šè¿ç®—å¤æ‚åº¦ ğŸ“Š

**ä»O(n)åˆ°O(1)çš„æ€§èƒ½é©å‘½**

#### å¤æ‚åº¦å¯¹æ¯”

| æ“ä½œ | Pythonå¾ªç¯ | NumPyå‘é‡åŒ– | å¤æ‚åº¦é™ä½ |
|------|-----------|------------|----------|
| å…ƒç´ è¿ç®— | O(n)å¾ªç¯ | O(1)SIMD | ~100å€ |
| ç‚¹ç§¯ | O(n)å¾ªç¯ | O(1)BLAS | ~500å€ |
| çŸ©é˜µä¹˜æ³• | O(nÂ²m)å¾ªç¯ | O(nmk)BLAS | ~1000å€ |

**æ³¨ï¼šBLAS = Basic Linear Algebra Subprogramsï¼Œé«˜åº¦ä¼˜åŒ–çš„çº¿æ€§ä»£æ•°åº“**

#### ç¤ºä¾‹1ï¼šå…ƒç´ è¿ç®—

```python
import numpy as np
import time

n = 10000000  # 1000ä¸‡

arr = np.random.rand(n).astype(np.float32)

# Pythonå¾ªç¯ï¼šO(n)
start = time.time()
result = np.zeros(n, dtype=np.float32)
for i in range(n):
    result[i] = arr[i] ** 2
time_loop = time.time() - start

# NumPyå‘é‡åŒ–ï¼šO(1)ï¼ˆå®é™…ä¸Šæ˜¯O(n/4)å› ä¸ºSIMDï¼‰
start = time.time()
result = arr ** 2
time_vec = time.time() - start

print(f"å¾ªç¯: {time_loop:.4f}ç§’")
print(f"å‘é‡åŒ–: {time_vec:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.1f}å€")
```

#### ç¤ºä¾‹2ï¼šçŸ©é˜µä¹˜æ³•

```python
# å°çŸ©é˜µ
A = np.random.rand(100, 100).astype(np.float32)
B = np.random.rand(100, 100).astype(np.float32)

# Pythonä¸‰é‡å¾ªç¯ï¼šO(nÂ³) = O(100Â³) = 1,000,000æ¬¡è¿ç®—
start = time.time()
C = np.zeros((100, 100), dtype=np.float32)
for i in range(100):
    for j in range(100):
        for k in range(100):
            C[i, j] += A[i, k] * B[k, j]
time_loop = time.time() - start

# NumPyçŸ©é˜µä¹˜æ³•ï¼šO(nÂ³)ä½†åˆ©ç”¨BLAS+SIMD
start = time.time()
C = A @ B
time_numpy = time.time() - start

print(f"ä¸‰é‡å¾ªç¯: {time_loop:.4f}ç§’")
print(f"NumPyçŸ©é˜µä¹˜æ³•: {time_numpy:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_numpy:.1f}å€")
```

**å…¸å‹è¾“å‡ºï¼š**
```
ä¸‰é‡å¾ªç¯: 12.3456ç§’
NumPyçŸ©é˜µä¹˜æ³•: 0.0089ç§’
åŠ é€Ÿæ¯”: 1387.4å€
```

#### å‘é‡æ•°æ®åº“ä¸­çš„å¤æ‚åº¦ä¼˜åŒ–

**åœºæ™¯ï¼š100ä¸‡æ–‡æ¡£ï¼Œ768ç»´embeddingï¼Œå•æ¬¡æŸ¥è¯¢**

```python
num_docs = 1000000
embed_dim = 768

embeddings = np.random.rand(num_docs, embed_dim).astype(np.float32)
query = np.random.rand(embed_dim).astype(np.float32)

# æ–¹æ³•1ï¼šåŒé‡å¾ªç¯ - O(num_docs Ã— embed_dim)
start = time.time()
similarities = np.zeros(num_docs, dtype=np.float32)
for i in range(num_docs):
    for j in range(embed_dim):
        similarities[i] += embeddings[i, j] * query[j]
time_loop = time.time() - start

# æ–¹æ³•2ï¼šNumPyçŸ©é˜µä¹˜æ³• - O(num_docs Ã— embed_dim) ä½†BLASä¼˜åŒ–
start = time.time()
similarities = embeddings @ query
time_blas = time.time() - start

print(f"åŒé‡å¾ªç¯: {time_loop:.4f}ç§’")
print(f"BLASçŸ©é˜µä¹˜æ³•: {time_blas:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_blas:.1f}å€")
```

**å…¸å‹è¾“å‡ºï¼š**
```
åŒé‡å¾ªç¯: 8.2345ç§’
BLASçŸ©é˜µä¹˜æ³•: 0.0234ç§’
åŠ é€Ÿæ¯”: 351.9å€
```

**å¤æ‚åº¦åˆ†æï¼š**
```
æ“ä½œ: 100ä¸‡ Ã— 768ç»´ç‚¹ç§¯ = 7.68äº¿æ¬¡ä¹˜æ³•+åŠ æ³•

Pythonå¾ªç¯:
- æ¯æ¬¡è¿ç®—ï¼šPythonè§£é‡Šå™¨å¼€é”€ + è¿ç®—
- æ€»æ—¶é—´ â‰ˆ 768M Ã— (100nsè§£é‡Š + 1nsè¿ç®—) â‰ˆ 77ç§’

NumPy+BLAS:
- å•æ¬¡è°ƒç”¨ï¼šCå±‚å¾ªç¯ + SIMD
- æ€»æ—¶é—´ â‰ˆ 768M Ã— (0nsè§£é‡Š + 0.25ns SIMDè¿ç®—) â‰ˆ 0.2ç§’
- å®é™…æ›´å¿«å› ä¸ºBLASåº“çš„cacheä¼˜åŒ–
```

**å…³é”®å¯ç¤ºï¼š**
- å‘é‡æ•°æ®åº“å¿…é¡»ç”¨å‘é‡åŒ–è¿ç®—
- å•æ¬¡æŸ¥è¯¢100ä¸‡æ–‡æ¡£ï¼Œä»8ç§’é™åˆ°0.02ç§’
- ä½¿å¾—å®æ—¶æœç´¢æˆä¸ºå¯èƒ½ï¼ˆ< 100msï¼‰

---

## 8. ã€1ä¸ªç±»æ¯”ã€‘ç”¨å‰ç«¯å¼€å‘ç†è§£å‘é‡åŒ–

### ç±»æ¯”1ï¼šå‘é‡åŒ– = æ‰¹é‡DOMæ“ä½œ ğŸ¨

#### é€ä¸ªæ“ä½œ vs æ‰¹é‡æ“ä½œ

```javascript
// âŒ æ…¢ï¼šé€ä¸ªæ“ä½œDOMï¼ˆç±»ä¼¼Pythonå¾ªç¯ï¼‰
for (let i = 0; i < 1000; i++) {
  const div = document.createElement('div');
  div.textContent = `Item ${i}`;
  div.style.color = 'red';
  document.body.appendChild(div);  // æ¯æ¬¡è§¦å‘é‡æ’é‡ç»˜ï¼
}
// è§¦å‘1000æ¬¡å¸ƒå±€è®¡ç®—ï¼Œéå¸¸æ…¢

// âœ… å¿«ï¼šæ‰¹é‡æ“ä½œï¼ˆç±»ä¼¼NumPyå‘é‡åŒ–ï¼‰
const fragment = document.createDocumentFragment();
for (let i = 0; i < 1000; i++) {
  const div = document.createElement('div');
  div.textContent = `Item ${i}`;
  div.style.color = 'red';
  fragment.appendChild(div);  // åªåœ¨å†…å­˜ä¸­æ“ä½œ
}
document.body.appendChild(fragment);  // ä¸€æ¬¡æ€§æ¸²æŸ“ï¼
// åªè§¦å‘1æ¬¡å¸ƒå±€è®¡ç®—ï¼Œå¿«100å€
```

**ç›¸ä¼¼ç‚¹ï¼š**
- é€ä¸ªæ“ä½œ = Pythonå¾ªç¯ï¼ˆæ¯æ¬¡éƒ½æœ‰å¼€é”€ï¼‰
- æ‰¹é‡æ“ä½œ = NumPyå‘é‡åŒ–ï¼ˆä¸€æ¬¡æ€§å®Œæˆï¼‰
- å‡å°‘ä¸­é—´æ­¥éª¤çš„å¼€é”€

```python
# NumPyç­‰ä»·
arr = np.arange(1000)
# âŒ æ…¢ï¼šå¾ªç¯
result = [x * 2 for x in arr]

# âœ… å¿«ï¼šå‘é‡åŒ–
result = arr * 2
```

---

### ç±»æ¯”2ï¼šSIMD = GPUå¹¶è¡Œæ¸²æŸ“ ğŸ–¼ï¸

```javascript
// CPUå•çº¿ç¨‹æ¸²æŸ“ï¼ˆç±»ä¼¼ä¼ ç»Ÿå¾ªç¯ï¼‰
for (let pixel of allPixels) {
  pixel.color = computeColor(pixel);  // é€ä¸ªè®¡ç®—
}

// GPUå¹¶è¡Œæ¸²æŸ“ï¼ˆç±»ä¼¼SIMDï¼‰
// åŒæ—¶è®¡ç®—æ‰€æœ‰åƒç´ çš„é¢œè‰²
allPixels.forEach(pixel => pixel.color = computeColor(pixel));
// å®é™…ä¸ŠGPUæœ‰æˆç™¾ä¸Šåƒä¸ªæ ¸å¿ƒåŒæ—¶å·¥ä½œ
```

**SIMDç±»æ¯”ï¼š**
```
CPU SIMDå°±åƒå°å‹GPUï¼š
- ä¼ ç»ŸCPUï¼š1ä¸ªæ ¸å¿ƒï¼Œ1æ¬¡ç®—1ä¸ªæ•°
- SIMD CPUï¼š1ä¸ªæ ¸å¿ƒï¼Œ1æ¬¡ç®—4-16ä¸ªæ•°
- GPUï¼šæˆåƒä¸Šä¸‡ä¸ªæ ¸å¿ƒï¼Œå…¨å¹¶è¡Œ

NumPyçš„SIMDï¼š
arr = np.array([1, 2, 3, 4, 5, 6, 7, 8])
result = arr ** 2
# CPUå¯èƒ½è¿™æ ·æ‰§è¡Œï¼ˆAVX2ï¼Œ256ä½ï¼‰ï¼š
# ç¬¬1ç»„ï¼š[1,2,3,4,5,6,7,8] â†’ [1,4,9,16,25,36,49,64]  åŒæ—¶ç®—8ä¸ªï¼
```

---

### ç±»æ¯”3ï¼šç¼“å­˜å±€éƒ¨æ€§ = CDNå°±è¿‘è®¿é—® ğŸŒ

```javascript
// âŒ æ…¢ï¼šæ¯æ¬¡ä»è¿œç¨‹æœåŠ¡å™¨åŠ è½½ï¼ˆç±»ä¼¼cache missï¼‰
for (let i = 0; i < 1000; i++) {
  fetch(`https://api.example.com/data/${i}`)
    .then(data => process(data));
}
// 1000æ¬¡ç½‘ç»œè¯·æ±‚ï¼Œéå¸¸æ…¢

// âœ… å¿«ï¼šä¸€æ¬¡æ€§åŠ è½½åˆ°æœ¬åœ°ï¼ˆç±»ä¼¼cache hitï¼‰
fetch('https://api.example.com/data/all')
  .then(allData => {
    for (let i = 0; i < 1000; i++) {
      process(allData[i]);  // æœ¬åœ°è®¿é—®ï¼Œæå¿«
    }
  });
// 1æ¬¡ç½‘ç»œè¯·æ±‚ + 1000æ¬¡æœ¬åœ°è®¿é—®ï¼Œå¿«100å€
```

**NumPyç­‰ä»·ï¼š**
```python
# Cache-friendlyï¼ˆè¿ç»­è®¿é—®ï¼‰
arr = np.arange(1000000)
result = arr ** 2  # é¡ºåºè¯»å–ï¼Œæ•°æ®åœ¨cacheä¸­

# Cache-unfriendlyï¼ˆéšæœºè®¿é—®ï¼‰
indices = np.random.permutation(1000000)
result = arr[indices] ** 2  # è·³è·ƒè¯»å–ï¼Œé¢‘ç¹cache miss
```

---

### ç±»æ¯”4ï¼šçŸ©é˜µä¹˜æ³• = SQL JOINä¼˜åŒ– ğŸ—„ï¸

```sql
-- âŒ æ…¢ï¼šåµŒå¥—å¾ªç¯JOINï¼ˆç±»ä¼¼åŒé‡å¾ªç¯ï¼‰
SELECT *
FROM users u, orders o
WHERE u.id = o.user_id;
-- æ•°æ®åº“ä¼šé€ä¸ªæ¯”è¾ƒï¼ˆO(nÃ—m)ï¼‰

-- âœ… å¿«ï¼šHash JOINï¼ˆç±»ä¼¼BLASä¼˜åŒ–ï¼‰
-- æ•°æ®åº“å†…éƒ¨ï¼š
-- 1. å¯¹userså»ºç«‹hashç´¢å¼•
-- 2. æ‰«æordersï¼Œç”¨hashå¿«é€ŸæŸ¥æ‰¾
-- æ—¶é—´å¤æ‚åº¦é™åˆ°O(n+m)
```

**NumPyçŸ©é˜µä¹˜æ³•ï¼š**
```python
# è¡¨é¢ä¸Šæ˜¯O(nÂ²m)ï¼Œå®é™…BLASç”¨äº†ï¼š
# - åˆ†å—è®¡ç®—ï¼ˆcacheä¼˜åŒ–ï¼‰
# - SIMDå¹¶è¡Œ
# - å¤šçº¿ç¨‹ï¼ˆOpenMPï¼‰
# å®é™…æ€§èƒ½æ¥è¿‘ç†è®ºæé™
```

---

### ç±»æ¯”5ï¼šå‘é‡åŒ– = Reactæ‰¹é‡æ›´æ–° âš›ï¸

```javascript
// âŒ æ…¢ï¼šé€ä¸ªsetStateï¼ˆè§¦å‘å¤šæ¬¡renderï¼‰
for (let i = 0; i < 100; i++) {
  this.setState({ count: this.state.count + 1 });
  // æ¯æ¬¡éƒ½è§¦å‘renderï¼Œéå¸¸æ…¢
}

// âœ… å¿«ï¼šæ‰¹é‡æ›´æ–°ï¼ˆReactè‡ªåŠ¨åˆå¹¶ï¼‰
this.setState(prevState => ({
  count: prevState.count + 100
}));
// åªè§¦å‘1æ¬¡renderï¼Œå¿«100å€
```

**NumPyç­‰ä»·ï¼š**
```python
# âŒ æ…¢ï¼šé€ä¸ªæ›´æ–°
for i in range(100):
    arr[i] += 1  # æ¯æ¬¡Pythonè§£é‡Šå™¨è°ƒç”¨

# âœ… å¿«ï¼šæ‰¹é‡æ›´æ–°
arr += 1  # ä¸€æ¬¡Cè°ƒç”¨ï¼Œæ‰¹é‡å®Œæˆ
```

---

### ç±»æ¯”æ€»ç»“è¡¨ ğŸ¯

| NumPyæ¦‚å¿µ | å‰ç«¯ç±»æ¯” | å…³é”®ç›¸ä¼¼ç‚¹ |
|----------|---------|-----------|
| å‘é‡åŒ– | æ‰¹é‡DOMæ“ä½œ | å‡å°‘ä¸­é—´å¼€é”€ |
| SIMD | GPUå¹¶è¡Œæ¸²æŸ“ | å¤šæ•°æ®åŒæ—¶å¤„ç† |
| ç¼“å­˜å±€éƒ¨æ€§ | CDNå°±è¿‘è®¿é—® | å‡å°‘è¿œç¨‹è®¿é—® |
| çŸ©é˜µä¹˜æ³•ä¼˜åŒ– | SQL JOINä¼˜åŒ– | æ™ºèƒ½ç®—æ³•åŠ é€Ÿ |
| æ‰¹é‡è®¡ç®— | Reactæ‰¹é‡æ›´æ–° | åˆå¹¶å¤šæ¬¡æ“ä½œ |
| è¿ç»­å†…å­˜ | æ•°ç»„vsé“¾è¡¨ | é¡ºåºè®¿é—®å¿« |

---

## 9. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### å‘é‡åŒ–è¿ç®—çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„é—®é¢˜

**æ ¸å¿ƒçŸ›ç›¾ï¼šå¦‚ä½•è®©Pythonï¼ˆæ…¢ï¼‰æ‰§è¡Œæ•°å€¼è®¡ç®—ï¼ˆéœ€è¦å¿«ï¼‰ï¼Ÿ**

```
Pythonçš„ç‰¹ç‚¹ï¼š
âœ… çµæ´»ã€æ˜“ç”¨ã€è¡¨è¾¾åŠ›å¼º
âŒ è§£é‡Šæ‰§è¡Œã€åŠ¨æ€ç±»å‹ã€æ…¢

æ•°å€¼è®¡ç®—çš„éœ€æ±‚ï¼š
âœ… éœ€è¦æè‡´æ€§èƒ½ï¼ˆç™¾ä¸‡ã€åƒä¸‡çº§æ•°æ®ï¼‰
âœ… æ“ä½œé‡å¤ï¼ˆç›¸åŒè¿ç®—åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ï¼‰
âŒ ä¸éœ€è¦çµæ´»æ€§ï¼ˆç±»å‹å›ºå®šã€æ“ä½œç®€å•ï¼‰
```

**æ ¹æœ¬çŸ›ç›¾ï¼š** Pythonçš„çµæ´»æ€§ vs æ•°å€¼è®¡ç®—çš„æ€§èƒ½éœ€æ±‚

---

#### 2. ç¬¬ä¸€æ€§åŸç†çš„è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒæ´å¯Ÿï¼š**
- æ•°å€¼è®¡ç®—æ˜¯**æ•°æ®å¹¶è¡Œ**çš„ï¼ˆæ¯ä¸ªå…ƒç´ ç‹¬ç«‹å¤„ç†ï¼‰
- å¯ä»¥**ä¸€æ¬¡æ€§æè¿°ï¼Œæ‰¹é‡æ‰§è¡Œ**
- æ‰§è¡Œå±‚æ¨åˆ°Cè¯­è¨€ï¼Œç»•è¿‡Pythonè§£é‡Šå™¨

**ä¸‰å±‚è§£å†³æ–¹æ¡ˆï¼š**

##### å±‚1ï¼šæ¶ˆé™¤Pythonè§£é‡Šå™¨å¼€é”€

```
ä¼ ç»Ÿæ–¹å¼ï¼š
Python: for i in range(1000000):
Python:     result[i] = arr[i] ** 2
        â†‘ æ¯æ¬¡å¾ªç¯éƒ½è¦Pythonè§£é‡Šå™¨å¤„ç†

å‘é‡åŒ–æ–¹å¼ï¼š
Python: result = arr ** 2
        â†“ ä¸€æ¬¡Pythonè°ƒç”¨
Cè¯­è¨€: for (i=0; i<1000000; i++)
           result[i] = pow(arr[i], 2)
        â†‘ Cè¯­è¨€å¾ªç¯ï¼Œæ— è§£é‡Šå¼€é”€
```

**æ€§èƒ½æå‡ï¼š** 10-50å€

---

##### å±‚2ï¼šåˆ©ç”¨SIMDæŒ‡ä»¤

```
Cè¯­è¨€å¾ªç¯ï¼š
for (i=0; i<1000000; i++)
    result[i] = pow(arr[i], 2)
â†‘ è¿˜æ˜¯ä¸€ä¸ªä¸€ä¸ªç®—

SIMDä¼˜åŒ–ï¼š
for (i=0; i<1000000; i+=4)  // æ¯æ¬¡å¤„ç†4ä¸ª
    simd_pow4(&arr[i], &result[i])
    // ä¸€æ¡æŒ‡ä»¤åŒæ—¶ç®—4ä¸ª
â†‘ ç¡¬ä»¶çº§å¹¶è¡Œ
```

**æ€§èƒ½æå‡ï¼š** 2-8å€ï¼ˆå–å†³äºSIMDå®½åº¦ï¼‰

---

##### å±‚3ï¼šä¼˜åŒ–å†…å­˜è®¿é—®

```
éšæœºè®¿é—®ï¼ˆæ…¢ï¼‰ï¼š
for (i=0; i<1000000; i++)
    result[i] = arr[random_indices[i]] ** 2
    // æ¯æ¬¡è®¿é—®å¯èƒ½cache miss

é¡ºåºè®¿é—®ï¼ˆå¿«ï¼‰ï¼š
for (i=0; i<1000000; i++)
    result[i] = arr[i] ** 2
    // é¡ºåºè®¿é—®ï¼Œcacheå‘½ä¸­ç‡é«˜
```

**æ€§èƒ½æå‡ï¼š** 2-10å€

---

#### 3. æ€»æ€§èƒ½æå‡

```
å±‚1: æ¶ˆé™¤è§£é‡Šå™¨    10-50å€
å±‚2: SIMDå¹¶è¡Œ      2-8å€
å±‚3: ç¼“å­˜ä¼˜åŒ–      2-10å€

æ€»æå‡ = 10Ã—2Ã—2 åˆ° 50Ã—8Ã—10
       = 40å€ åˆ° 4000å€ï¼

å®é™…æµ‹è¯•ï¼š100-500å€å¸¸è§
```

---

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼å‘é‡æ•°æ®åº“

**æ¨ç†é“¾ï¼š**

```
1. å‘é‡æ•°æ®åº“éœ€è¦å­˜å‚¨ç™¾ä¸‡çº§embedding
   â†“ å†…å­˜éœ€æ±‚ï¼šè¿ç»­å­˜å‚¨ï¼ŒèŠ‚çœç©ºé—´

2. éœ€è¦å¿«é€Ÿè®¡ç®—ç›¸ä¼¼åº¦ï¼ˆç‚¹ç§¯ï¼‰
   â†“ æ€§èƒ½éœ€æ±‚ï¼šå¿…é¡»ç”¨å‘é‡åŒ–

3. æŸ¥è¯¢å‘é‡ vs ç™¾ä¸‡æ–‡æ¡£å‘é‡
   â†“ è®¡ç®—é‡ï¼šç™¾ä¸‡æ¬¡ç‚¹ç§¯

4. Pythonå¾ªç¯ï¼š3-5ç§’ï¼ˆä¸å¯æ¥å—ï¼‰
   NumPyå‘é‡åŒ–ï¼š0.01-0.05ç§’ï¼ˆå¯æ¥å—ï¼‰
   â†“ å†³ç­–ï¼šå¿…é¡»ç”¨NumPy

5. å®æ—¶æœç´¢è¦æ±‚<100ms
   â†“ ä¼˜åŒ–ï¼šå‘é‡åŒ– + ç´¢å¼• + è¿‘ä¼¼ç®—æ³•

6. å‘é‡åŒ–è¿ç®—æ˜¯åŸºç¡€ï¼Œä½¿å®æ—¶æ£€ç´¢æˆä¸ºå¯èƒ½ï¼
```

---

#### 5. å®é™…æ¡ˆä¾‹ï¼šä»é›¶åˆ°äº§å“çº§

**é˜¶æ®µ1ï¼šPythonåŸå‹ï¼ˆæ…¢ï¼‰**
```python
def search_naive(query, embeddings):
    similarities = []
    for emb in embeddings:
        sim = sum(q * e for q, e in zip(query, emb))
        similarities.append(sim)
    return sorted(enumerate(similarities), key=lambda x: x[1], reverse=True)

# 100ä¸‡æ–‡æ¡£ï¼š30-50ç§’
```

**é˜¶æ®µ2ï¼šNumPyå‘é‡åŒ–ï¼ˆå¿«ï¼‰**
```python
def search_vectorized(query, embeddings):
    similarities = embeddings @ query
    top_indices = np.argsort(similarities)[::-1]
    return top_indices

# 100ä¸‡æ–‡æ¡£ï¼š0.05ç§’ï¼ˆ600å€åŠ é€Ÿï¼‰
```

**é˜¶æ®µ3ï¼šç”Ÿäº§ä¼˜åŒ–ï¼ˆæ›´å¿«ï¼‰**
```python
# + é¢„è®¡ç®—å½’ä¸€åŒ–
# + ä½¿ç”¨float32èŠ‚çœå†…å­˜
# + è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰ç®—æ³•
# + GPUåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

# 100ä¸‡æ–‡æ¡£ï¼š<0.01ç§’ï¼ˆ3000å€ä»¥ä¸ŠåŠ é€Ÿï¼‰
```

---

#### 6. ä¸€å¥è¯æ€»ç»“

**å‘é‡åŒ–è¿ç®—é€šè¿‡å°†å¾ªç¯ä»Pythonè§£é‡Šå™¨æ¨åˆ°Cè¯­è¨€å±‚é¢ï¼Œå¹¶åˆ©ç”¨SIMDæŒ‡ä»¤å’Œç¼“å­˜ä¼˜åŒ–ï¼Œå®ç°äº†100-1000å€çš„æ€§èƒ½æå‡ï¼Œæ˜¯å‘é‡æ•°æ®åº“ç­‰å¤§è§„æ¨¡æ•°å€¼è®¡ç®—åº”ç”¨çš„æ€§èƒ½åŸºçŸ³ã€‚**

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**å‘é‡åŒ–è¿ç®—æ˜¯å°†æ•°æ®å¹¶è¡Œè®¡ç®—ä»Pythonå±‚æ¨åˆ°Cå±‚å¹¶åˆ©ç”¨SIMDæŒ‡ä»¤æ‰§è¡Œçš„æŠ€æœ¯ï¼Œé€šè¿‡æ¶ˆé™¤è§£é‡Šå™¨å¼€é”€ã€ç¡¬ä»¶çº§å¹¶è¡Œå’Œç¼“å­˜ä¼˜åŒ–ï¼Œå®ç°100-1000å€æ€§èƒ½æå‡ï¼Œæ˜¯å‘é‡æ•°æ®åº“é«˜æ•ˆè®¡ç®—ç›¸ä¼¼åº¦çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä½¿ç™¾ä¸‡çº§embeddingæ£€ç´¢ä»ç§’çº§é™åˆ°æ¯«ç§’çº§ã€‚**

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡ ğŸ“‹

### æ ¸å¿ƒè¿ç®—é€ŸæŸ¥

```python
import numpy as np

# ===== å…ƒç´ çº§è¿ç®— =====
arr + 10          # æ¯ä¸ªå…ƒç´ +10
arr * 2           # æ¯ä¸ªå…ƒç´ Ã—2
arr ** 2          # æ¯ä¸ªå…ƒç´ å¹³æ–¹
arr1 + arr2       # å¯¹åº”å…ƒç´ ç›¸åŠ 

# ===== æ•°å­¦å‡½æ•° =====
np.sqrt(arr)      # å¹³æ–¹æ ¹
np.exp(arr)       # æŒ‡æ•°
np.log(arr)       # å¯¹æ•°
np.sin(arr)       # ä¸‰è§’å‡½æ•°

# ===== ç‚¹ç§¯ =====
a @ b             # å‘é‡ç‚¹ç§¯ï¼ˆæ¨èï¼‰
np.dot(a, b)      # å‘é‡ç‚¹ç§¯
A @ B             # çŸ©é˜µä¹˜æ³•

# ===== èŒƒæ•° =====
np.linalg.norm(v)         # L2èŒƒæ•°
np.linalg.norm(v, ord=1)  # L1èŒƒæ•°
v / np.linalg.norm(v)     # å½’ä¸€åŒ–

# ===== æ¯”è¾ƒè¿ç®— =====
arr > 5           # ç”Ÿæˆå¸ƒå°”æ•°ç»„
arr[arr > 5]      # å¸ƒå°”ç´¢å¼•
np.sum(arr > 5)   # ç»Ÿè®¡æ•°é‡
np.mean(arr > 5)  # ç»Ÿè®¡æ¯”ä¾‹

# ===== èšåˆå‡½æ•° =====
np.sum(arr)       # æ±‚å’Œ
np.mean(arr)      # å¹³å‡å€¼
np.min(arr)       # æœ€å°å€¼
np.max(arr)       # æœ€å¤§å€¼
np.std(arr)       # æ ‡å‡†å·®
```

---

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§ âš¡

| åœºæ™¯ | æ…¢ | å¿« | åŠ é€Ÿæ¯” |
|------|---|---|--------|
| å…ƒç´ è¿ç®— | `for x in arr` | `arr + 1` | 100x |
| ç‚¹ç§¯ | `sum(a[i]*b[i])` | `a @ b` | 500x |
| çŸ©é˜µä¹˜æ³• | ä¸‰é‡å¾ªç¯ | `A @ B` | 1000x |
| æ¡ä»¶è¿‡æ»¤ | `[x for x if x>5]` | `arr[arr>5]` | 50x |
| å‡½æ•°åº”ç”¨ | `[f(x) for x]` | `np.vectorize(f)` | 10x |

---

### å‘é‡æ•°æ®åº“å¸¸ç”¨æ¨¡å¼ ğŸ—„ï¸

```python
# 1. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—
query = np.random.rand(768)
embeddings = np.random.rand(1000000, 768)
similarities = embeddings @ query  # 0.05ç§’

# 2. å½’ä¸€åŒ–
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
normalized = embeddings / norms

# 3. Top-Kæ£€ç´¢
top_k_indices = np.argsort(similarities)[::-1][:k]
top_k_scores = similarities[top_k_indices]

# 4. é˜ˆå€¼è¿‡æ»¤
high_conf = embeddings[similarities > threshold]

# 5. ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆå½’ä¸€åŒ–åï¼‰
cos_sim = normalized_query @ normalized_embeddings.T
```

---

## å­¦ä¹ æ£€æŸ¥æ¸…å• âœ…

- [ ] ç†è§£å‘é‡åŒ–çš„ä¸‰å±‚åŠ é€Ÿæœºåˆ¶ï¼ˆè§£é‡Šå™¨ã€SIMDã€ç¼“å­˜ï¼‰
- [ ] æŒæ¡å…ƒç´ çº§è¿ç®—ï¼ˆ+, -, *, /, **ï¼‰
- [ ] æŒæ¡æ•°å­¦å‡½æ•°ï¼ˆsqrt, exp, log, sinï¼‰
- [ ] ç†Ÿç»ƒä½¿ç”¨ç‚¹ç§¯å’ŒçŸ©é˜µä¹˜æ³•ï¼ˆ@è¿ç®—ç¬¦ï¼‰
- [ ] æŒæ¡å‘é‡èŒƒæ•°å’Œå½’ä¸€åŒ–
- [ ] èƒ½ç”¨æ¯”è¾ƒè¿ç®—ç”Ÿæˆå¸ƒå°”æ•°ç»„å¹¶è¿‡æ»¤
- [ ] ç†è§£SIMDå¹¶è¡Œçš„åŸç†
- [ ] ç†è§£å†…å­˜å¸ƒå±€å¯¹æ€§èƒ½çš„å½±å“
- [ ] çŸ¥é“ä½•æ—¶å‘é‡åŒ–ï¼Œä½•æ—¶ç”¨å¾ªç¯
- [ ] èƒ½ç”¨å‘é‡åŒ–å®ç°å‘é‡æ•°æ®åº“æ ¸å¿ƒåŠŸèƒ½

---

## ä¸‹ä¸€æ­¥å­¦ä¹  ğŸš€

1. **å¹¿æ’­æœºåˆ¶**ï¼ˆä¸‹ä¸€è¯¾ï¼‰ï¼šä¸åŒå½¢çŠ¶æ•°ç»„çš„è¿ç®—
2. **é«˜çº§ç´¢å¼•**ï¼šæ•´æ•°æ•°ç»„ç´¢å¼•ã€æ©ç ç´¢å¼•
3. **çº¿æ€§ä»£æ•°**ï¼šçŸ©é˜µåˆ†è§£ã€ç‰¹å¾å€¼

**å­¦ä¹ è·¯å¾„ï¼š**
```
NumPyæ•°ç»„åˆ›å»ºä¸ç´¢å¼•
    â†“
å‘é‡åŒ–è¿ç®—ï¼ˆå½“å‰ï¼‰âœ…
    â†“
å¹¿æ’­æœºåˆ¶åŸºç¡€ï¼ˆä¸‹ä¸€è¯¾ï¼‰
    â†“
ç‚¹ç§¯è¿ç®—
    â†“
ä½™å¼¦ç›¸ä¼¼åº¦
    â†“
å‘é‡æ•°æ®åº“å®æˆ˜
```

---

## å‚è€ƒèµ„æº ğŸ“š

1. **NumPyå®˜æ–¹æ–‡æ¡£**ï¼šhttps://numpy.org/doc/stable/
2. **SIMDæ•™ç¨‹**ï¼šhttps://www.intel.com/content/www/us/en/docs/intrinsics-guide/
3. **æ€§èƒ½åˆ†æ**ï¼šline_profiler, memory_profiler
4. **å‘é‡æ•°æ®åº“**ï¼šFaiss, Annoy, HNSWç®—æ³•

---

**ç»“è¯­ï¼š** å‘é‡åŒ–è¿ç®—è®©Pythonä»"æ…¢"å˜æˆ"å¿«"ï¼Œæ˜¯å‘é‡æ•°æ®åº“æ€§èƒ½çš„å…³é”®ï¼æŒæ¡äº†å‘é‡åŒ–ï¼Œä½ å°±èƒ½å†™å‡ºæ¥è¿‘Cè¯­è¨€æ€§èƒ½çš„Pythonä»£ç ã€‚ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¹¿æ’­æœºåˆ¶ï¼Œè¿›ä¸€æ­¥æå‡NumPyçš„å¨åŠ›ï¼ğŸ’ª
