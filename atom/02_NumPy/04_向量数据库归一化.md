# å‘é‡æ•°æ®åº“å½’ä¸€åŒ–

> å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡å‘é‡å½’ä¸€åŒ–çš„åŸç†å’Œå®ç°ï¼Œç†è§£å…¶åœ¨å‘é‡æ•°æ®åº“ä¸­çš„æ ¸å¿ƒä½œç”¨ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°æ‰¹é‡å¤„ç†embedding

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**å½’ä¸€åŒ–æ˜¯å°†å‘é‡é•¿åº¦ç»Ÿä¸€ä¸º1çš„é¢„å¤„ç†æ“ä½œï¼Œä½¿ç‚¹ç§¯ç­‰äºä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ˜¯å‘é‡æ•°æ®åº“é«˜æ•ˆæ£€ç´¢çš„åŸºç¡€ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### å½’ä¸€åŒ–çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**å½’ä¸€åŒ– = å°†å‘é‡å˜æˆå•ä½å‘é‡**

```
vÌ‚ = v / ||v||

å…¶ä¸­ï¼š
- v æ˜¯åŸå§‹å‘é‡
- ||v|| æ˜¯å‘é‡çš„L2èŒƒæ•°ï¼ˆé•¿åº¦ï¼‰
- vÌ‚ æ˜¯å½’ä¸€åŒ–åçš„å•ä½å‘é‡ï¼Œ||vÌ‚|| = 1
```

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

---

#### 2. ä¸ºä»€ä¹ˆéœ€è¦å½’ä¸€åŒ–ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å…¬å¹³åœ°æ¯”è¾ƒä¸åŒæ¥æºã€ä¸åŒå°ºåº¦çš„å‘é‡ï¼Ÿ**

**æ€è€ƒé“¾ï¼š**
```
1. å‘é‡æ•°æ®åº“å­˜å‚¨æ¥è‡ªä¸åŒæ¨¡å‹çš„embedding
   â†“ é—®é¢˜ï¼šä¸åŒæ¨¡å‹è¾“å‡ºçš„å‘é‡èŒƒæ•°å·®å¼‚å¾ˆå¤§
   
2. BERTè¾“å‡ºèŒƒæ•° ~20ï¼ŒOpenAIè¾“å‡ºèŒƒæ•° ~1
   â†“ é—®é¢˜ï¼šç›´æ¥ç”¨ç‚¹ç§¯æ¯”è¾ƒä¸å…¬å¹³
   
3. éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†
   â†“ è§£å†³ï¼šæŠŠæ‰€æœ‰å‘é‡é•¿åº¦ç»Ÿä¸€ä¸º1
   
4. å½’ä¸€åŒ–åï¼Œåªæ¯”è¾ƒæ–¹å‘ï¼Œå¿½ç•¥é•¿åº¦
   â†“ ç»“æœï¼šç‚¹ç§¯ = ä½™å¼¦ç›¸ä¼¼åº¦
   
5. è¿™å°±æ˜¯å½’ä¸€åŒ–çš„æœ¬è´¨ï¼
```

---

#### 3. å½’ä¸€åŒ–çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šç»Ÿä¸€å°ºåº¦ï¼ˆStandardizationï¼‰

**ä¸åŒæ¨¡å‹çš„embeddingèŒƒæ•°å·®å¼‚å·¨å¤§**

```python
import numpy as np

# æ¨¡æ‹Ÿä¸åŒæ¨¡å‹çš„è¾“å‡º
bert_embedding = np.random.randn(768) * 5      # èŒƒæ•° ~20
openai_embedding = np.random.randn(1536) * 0.3  # èŒƒæ•° ~1
custom_embedding = np.random.randn(256) * 10    # èŒƒæ•° ~50

print(f"BERTèŒƒæ•°: {np.linalg.norm(bert_embedding):.2f}")
print(f"OpenAIèŒƒæ•°: {np.linalg.norm(openai_embedding):.2f}")
print(f"è‡ªå®šä¹‰èŒƒæ•°: {np.linalg.norm(custom_embedding):.2f}")

# å½’ä¸€åŒ–å
bert_norm = bert_embedding / np.linalg.norm(bert_embedding)
openai_norm = openai_embedding / np.linalg.norm(openai_embedding)
custom_norm = custom_embedding / np.linalg.norm(custom_embedding)

print(f"\nå½’ä¸€åŒ–å:")
print(f"BERTèŒƒæ•°: {np.linalg.norm(bert_norm):.2f}")      # 1.00
print(f"OpenAIèŒƒæ•°: {np.linalg.norm(openai_norm):.2f}")  # 1.00
print(f"è‡ªå®šä¹‰èŒƒæ•°: {np.linalg.norm(custom_norm):.2f}")   # 1.00
```

##### ä»·å€¼2ï¼šç®€åŒ–è®¡ç®—ï¼ˆEfficiencyï¼‰

**å½’ä¸€åŒ–åï¼šç‚¹ç§¯ = ä½™å¼¦ç›¸ä¼¼åº¦**

```
ä½™å¼¦ç›¸ä¼¼åº¦å…¬å¼ï¼š
cos(Î¸) = (vâ‚ Â· vâ‚‚) / (||vâ‚|| Ã— ||vâ‚‚||)

å¦‚æœ ||vâ‚|| = ||vâ‚‚|| = 1ï¼ˆå½’ä¸€åŒ–åï¼‰ï¼š
cos(Î¸) = (vâ‚ Â· vâ‚‚) / (1 Ã— 1) = vâ‚ Â· vâ‚‚

å³ï¼šä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯ï¼
```

**æ€§èƒ½æå‡ï¼š**
```python
# æœªå½’ä¸€åŒ–ï¼šéœ€è¦3æ¬¡è¿ç®—
similarity = np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))

# å½’ä¸€åŒ–åï¼šåªéœ€1æ¬¡è¿ç®—
similarity = np.dot(v1_norm, v2_norm)

# èŠ‚çœäº†2æ¬¡èŒƒæ•°è®¡ç®— + 2æ¬¡ä¹˜æ³• + 1æ¬¡é™¤æ³•
```

##### ä»·å€¼3ï¼šæ•°å€¼ç¨³å®šï¼ˆStabilityï¼‰

**é¿å…æ•°å€¼æº¢å‡ºå’Œä¸‹æº¢**

```python
# å¤§èŒƒæ•°å‘é‡å¯èƒ½å¯¼è‡´æº¢å‡º
large_vec = np.array([1e100, 1e100])
# np.dot(large_vec, large_vec)  # å¯èƒ½æº¢å‡ºï¼

# å°èŒƒæ•°å‘é‡å¯èƒ½å¯¼è‡´ä¸‹æº¢
small_vec = np.array([1e-200, 1e-200])
# np.dot(small_vec, small_vec)  # å¯èƒ½ä¸‹æº¢ï¼

# å½’ä¸€åŒ–åï¼šæ‰€æœ‰å€¼éƒ½åœ¨åˆç†èŒƒå›´å†…
large_norm = large_vec / np.linalg.norm(large_vec)
small_norm = small_vec / np.linalg.norm(small_vec)

# ç‚¹ç§¯ç»“æœå§‹ç»ˆåœ¨ [-1, 1] èŒƒå›´å†…
print(np.dot(large_norm, large_norm))  # 1.0
print(np.dot(small_norm, small_norm))  # 1.0
```

---

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼å‘é‡æ•°æ®åº“åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. å‘é‡æ•°æ®åº“éœ€è¦æ¯”è¾ƒembeddingçš„ç›¸ä¼¼åº¦
   â†“
2. ç›¸ä¼¼åº¦çš„æœ¬è´¨æ˜¯"æ–¹å‘çš„æ¥è¿‘ç¨‹åº¦"
   â†“
3. ä½™å¼¦ç›¸ä¼¼åº¦æ­£å¥½åº¦é‡æ–¹å‘
   â†“
4. ä½™å¼¦å…¬å¼æ¶‰åŠèŒƒæ•°è®¡ç®—ï¼Œå¼€é”€å¤§
   â†“
5. å¦‚æœé¢„å…ˆå½’ä¸€åŒ–ï¼Œä½™å¼¦ = ç‚¹ç§¯
   â†“
6. ç‚¹ç§¯è®¡ç®—ç®€å•ï¼Œç¡¬ä»¶åŠ é€Ÿå¥½
   â†“
7. å­˜å‚¨æ—¶å½’ä¸€åŒ–ï¼ŒæŸ¥è¯¢æ—¶ç›´æ¥ç‚¹ç§¯
   â†“
8. æ€§èƒ½æå‡2-3å€ï¼
```

**å®é™…åº”ç”¨ï¼š**

```python
# å‘é‡æ•°æ®åº“çš„å…¸å‹å·¥ä½œæµ

# 1. å…¥åº“æ—¶å½’ä¸€åŒ–
def insert_embedding(db, text, model):
    embedding = model.encode(text)
    embedding_norm = embedding / np.linalg.norm(embedding)
    db.insert(embedding_norm)

# 2. æŸ¥è¯¢æ—¶å½’ä¸€åŒ–
def search(db, query, model, top_k=5):
    query_emb = model.encode(query)
    query_norm = query_emb / np.linalg.norm(query_emb)
    
    # ç›´æ¥ç”¨ç‚¹ç§¯ï¼Œä¸ç”¨ä½™å¼¦å…¬å¼
    results = db.search_by_dot_product(query_norm, top_k)
    return results
```

---

#### 5. å½’ä¸€åŒ–ä¸æ¬§æ°è·ç¦»çš„å…³ç³»

**å¯¹äºå½’ä¸€åŒ–å‘é‡ï¼Œæ¬§æ°è·ç¦»å’Œä½™å¼¦ç›¸ä¼¼åº¦æœ‰ç›´æ¥å…³ç³»ï¼š**

```
æ¬§æ°è·ç¦»Â² = ||vâ‚ - vâ‚‚||Â²
          = (vâ‚ - vâ‚‚) Â· (vâ‚ - vâ‚‚)
          = vâ‚Â·vâ‚ - 2vâ‚Â·vâ‚‚ + vâ‚‚Â·vâ‚‚
          = 1 - 2vâ‚Â·vâ‚‚ + 1  ï¼ˆå› ä¸º||vâ‚|| = ||vâ‚‚|| = 1ï¼‰
          = 2 - 2vâ‚Â·vâ‚‚
          = 2(1 - cos(Î¸))

æ‰€ä»¥ï¼šæ¬§æ°è·ç¦» = âˆš(2(1 - cos(Î¸)))
```

**æ„ä¹‰ï¼š** å¯¹å½’ä¸€åŒ–å‘é‡ï¼ŒL2è·ç¦»å’Œä½™å¼¦ç›¸ä¼¼åº¦æ˜¯ç­‰ä»·çš„ï¼

---

#### 6. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**å½’ä¸€åŒ–é€šè¿‡ç»Ÿä¸€å‘é‡é•¿åº¦ä¸º1ï¼Œå°†ä½™å¼¦ç›¸ä¼¼åº¦ç®€åŒ–ä¸ºç‚¹ç§¯è¿ç®—ï¼Œæ˜¯å‘é‡æ•°æ®åº“å®ç°é«˜æ•ˆæ£€ç´¢çš„æ ¸å¿ƒé¢„å¤„ç†æ­¥éª¤ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šL2å½’ä¸€åŒ–ï¼ˆå•ä½å‘é‡åŒ–ï¼‰ğŸ“

**ä¸€å¥è¯å®šä¹‰ï¼š** å°†ä»»æ„å‘é‡ç¼©æ”¾åˆ°é•¿åº¦ä¸º1ï¼Œä¿æŒæ–¹å‘ä¸å˜

**æ•°å­¦å…¬å¼ï¼š**
```
vÌ‚ = v / ||v||â‚‚

å…¶ä¸­ ||v||â‚‚ = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚™Â²)
```

**ä»£ç å®ç°ï¼š**
```python
import numpy as np

def l2_normalize(vector):
    """L2å½’ä¸€åŒ–ï¼šå°†å‘é‡é•¿åº¦å˜ä¸º1"""
    norm = np.linalg.norm(vector)
    if norm == 0:
        return vector  # é›¶å‘é‡ä¸èƒ½å½’ä¸€åŒ–
    return vector / norm

# ç¤ºä¾‹
v = np.array([3, 4])
v_norm = l2_normalize(v)

print(f"åŸå‘é‡: {v}")
print(f"åŸèŒƒæ•°: {np.linalg.norm(v)}")       # 5.0
print(f"å½’ä¸€åŒ–å‘é‡: {v_norm}")               # [0.6, 0.8]
print(f"å½’ä¸€åŒ–åèŒƒæ•°: {np.linalg.norm(v_norm)}")  # 1.0
```

**å¯è§†åŒ–ç†è§£ï¼š**
```
åŸå‘é‡ v = [3, 4]ï¼Œé•¿åº¦ = 5

      y
      |
    4 |     â€¢(3,4)   é•¿åº¦=5
      |    /
    3 |   /
      |  /
    2 | /
      |/
    1 â€¢---â€¢(0.6,0.8)  é•¿åº¦=1
      |  /
    0 +----â†’ x

å½’ä¸€åŒ–ï¼šä¿æŒæ–¹å‘ï¼Œé•¿åº¦å˜ä¸º1
```

**åœ¨å‘é‡æ•°æ®åº“ä¸­çš„åº”ç”¨ï¼š**

```python
# Milvusä¸­çš„å½’ä¸€åŒ–
from pymilvus import Collection

# æ’å…¥å‰å½’ä¸€åŒ–
embeddings = model.encode(texts)  # (N, dim)
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
embeddings_normalized = embeddings / norms

# æ’å…¥å½’ä¸€åŒ–åçš„å‘é‡
collection.insert([ids, embeddings_normalized.tolist()])

# ä½¿ç”¨IPï¼ˆå†…ç§¯ï¼‰åº¦é‡ï¼Œç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦
collection.create_index(
    field_name="embedding",
    index_params={"metric_type": "IP", ...}
)
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šæ‰¹é‡å½’ä¸€åŒ–ï¼ˆé«˜æ•ˆå¤„ç†ï¼‰ğŸš€

**ä¸€å¥è¯å®šä¹‰ï¼š** åˆ©ç”¨NumPyå¹¿æ’­æœºåˆ¶ï¼Œä¸€æ¬¡æ€§å½’ä¸€åŒ–å¤§é‡å‘é‡

**ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡å½’ä¸€åŒ–ï¼Ÿ**

å‘é‡æ•°æ®åº“é€šå¸¸å¤„ç†ç™¾ä¸‡çº§embeddingï¼Œé€ä¸ªå½’ä¸€åŒ–å¤ªæ…¢ï¼

**ä½æ•ˆæ–¹å¼ï¼ˆå¾ªç¯ï¼‰ï¼š**
```python
# âŒ æ…¢ï¼šé€ä¸ªå½’ä¸€åŒ–
normalized = []
for vec in embeddings:
    norm = np.linalg.norm(vec)
    normalized.append(vec / norm)
normalized = np.array(normalized)
```

**é«˜æ•ˆæ–¹å¼ï¼ˆå‘é‡åŒ–ï¼‰ï¼š**
```python
# âœ… å¿«ï¼šæ‰¹é‡å½’ä¸€åŒ–
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (N, 1)
normalized = embeddings / norms  # å¹¿æ’­é™¤æ³•
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
```python
import numpy as np
import time

# 100ä¸‡ä¸ª768ç»´å‘é‡
embeddings = np.random.rand(1000000, 768).astype(np.float32)

# æ–¹æ³•1ï¼šå¾ªç¯ï¼ˆé‡‡æ ·1ä¸‡ä¸ªä¼°ç®—ï¼‰
sample = embeddings[:10000]
start = time.time()
normalized_loop = np.array([v / np.linalg.norm(v) for v in sample])
time_loop = (time.time() - start) * 100  # ä¼°ç®—100ä¸‡ä¸ª

# æ–¹æ³•2ï¼šå‘é‡åŒ–
start = time.time()
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
normalized_vec = embeddings / norms
time_vec = time.time() - start

print(f"å¾ªç¯ï¼ˆä¼°ç®—ï¼‰: {time_loop:.2f}ç§’")
print(f"å‘é‡åŒ–: {time_vec:.2f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.0f}å€")
```

**å…¸å‹è¾“å‡ºï¼š**
```
å¾ªç¯ï¼ˆä¼°ç®—ï¼‰: 45.00ç§’
å‘é‡åŒ–: 0.15ç§’
åŠ é€Ÿæ¯”: 300å€
```

**å…³é”®ä»£ç è§£æï¼š**
```python
embeddings.shape  # (N, dim)

# axis=1ï¼šæ²¿ç»´åº¦æ–¹å‘è®¡ç®—èŒƒæ•°
norms = np.linalg.norm(embeddings, axis=1)  # (N,)

# keepdims=Trueï¼šä¿æŒç»´åº¦ï¼Œä¾¿äºå¹¿æ’­
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (N, 1)

# å¹¿æ’­é™¤æ³•
normalized = embeddings / norms
# (N, dim) / (N, 1) â†’ (N, dim)
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šå½’ä¸€åŒ–ä¸ç›¸ä¼¼åº¦çš„å…³ç³» ğŸ”—

**æ ¸å¿ƒå…³ç³»ï¼šå½’ä¸€åŒ–å‘é‡çš„ç‚¹ç§¯ = ä½™å¼¦ç›¸ä¼¼åº¦**

**æ•°å­¦æ¨å¯¼ï¼š**
```
ä½™å¼¦ç›¸ä¼¼åº¦ï¼š
cos(Î¸) = (vâ‚ Â· vâ‚‚) / (||vâ‚|| Ã— ||vâ‚‚||)

å¦‚æœ vâ‚, vâ‚‚ å·²å½’ä¸€åŒ–ï¼ˆ||vâ‚|| = ||vâ‚‚|| = 1ï¼‰ï¼š
cos(Î¸) = (vâ‚ Â· vâ‚‚) / (1 Ã— 1) = vâ‚ Â· vâ‚‚
```

**ä»£ç éªŒè¯ï¼š**
```python
import numpy as np

v1 = np.array([3, 4])
v2 = np.array([4, 3])

# æ–¹æ³•1ï¼šä½™å¼¦å…¬å¼ï¼ˆæœªå½’ä¸€åŒ–ï¼‰
cosine_formula = np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))

# æ–¹æ³•2ï¼šå½’ä¸€åŒ–åç‚¹ç§¯
v1_norm = v1 / np.linalg.norm(v1)
v2_norm = v2 / np.linalg.norm(v2)
cosine_dot = np.dot(v1_norm, v2_norm)

print(f"ä½™å¼¦å…¬å¼: {cosine_formula:.6f}")
print(f"å½’ä¸€åŒ–ç‚¹ç§¯: {cosine_dot:.6f}")
print(f"ç»“æœç›¸åŒ: {np.isclose(cosine_formula, cosine_dot)}")  # True
```

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ**

| æ“ä½œ | è®¡ç®—é‡ | è¯´æ˜ |
|------|-------|------|
| ä½™å¼¦å…¬å¼ | 3N + 2æ¬¡å¼€æ–¹ + 1æ¬¡é™¤æ³• | æ¯æ¬¡æŸ¥è¯¢éƒ½è¦ç®—èŒƒæ•° |
| å½’ä¸€åŒ–ç‚¹ç§¯ | Næ¬¡ä¹˜æ³• + Næ¬¡åŠ æ³• | ç®€å•å¿«é€Ÿ |

**åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼š**
```python
# ä¸å½’ä¸€åŒ–ï¼šæ¯æ¬¡æŸ¥è¯¢éœ€è¦è®¡ç®—èŒƒæ•°
def search_cosine(query, docs):
    query_norm = np.linalg.norm(query)
    doc_norms = np.linalg.norm(docs, axis=1)
    dots = docs @ query
    similarities = dots / (doc_norms * query_norm)
    return similarities

# å½’ä¸€åŒ–ï¼šç›´æ¥ç‚¹ç§¯
def search_ip(query_normalized, docs_normalized):
    similarities = docs_normalized @ query_normalized
    return similarities

# åè€…å¿«2-3å€ï¼
```

**ä¸‰ç§åº¦é‡çš„å…³ç³»ï¼ˆå½’ä¸€åŒ–å‘é‡ï¼‰ï¼š**

| åº¦é‡ç±»å‹ | å…¬å¼ | å€¼åŸŸ | è¯´æ˜ |
|---------|------|-----|------|
| ç‚¹ç§¯(IP) | vâ‚ Â· vâ‚‚ | [-1, 1] | è¶Šå¤§è¶Šç›¸ä¼¼ |
| ä½™å¼¦(Cosine) | vâ‚ Â· vâ‚‚ | [-1, 1] | ä¸IPç›¸åŒ |
| æ¬§æ°è·ç¦»(L2) | âˆš(2-2cos) | [0, 2] | è¶Šå°è¶Šç›¸ä¼¼ |

---

## 4. ã€æœ€å°å¯ç”¨ã€‘æŒæ¡20%è§£å†³80%é—®é¢˜

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½åœ¨å‘é‡æ•°æ®åº“ä¸­æ­£ç¡®ä½¿ç”¨å½’ä¸€åŒ–ï¼š

### 4.1 å•ä¸ªå‘é‡å½’ä¸€åŒ–

```python
import numpy as np

# åŸå§‹å‘é‡
embedding = np.array([3, 4, 0])

# å½’ä¸€åŒ–
embedding_normalized = embedding / np.linalg.norm(embedding)

print(f"åŸå‘é‡: {embedding}")
print(f"å½’ä¸€åŒ–: {embedding_normalized}")
print(f"éªŒè¯é•¿åº¦: {np.linalg.norm(embedding_normalized)}")  # 1.0
```

### 4.2 æ‰¹é‡å‘é‡å½’ä¸€åŒ–

```python
# æ‰¹é‡embedding (N, dim)
embeddings = np.random.rand(1000, 768)

# è®¡ç®—æ¯è¡Œçš„èŒƒæ•°ï¼Œä¿æŒç»´åº¦
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (N, 1)

# å¹¿æ’­é™¤æ³•
embeddings_normalized = embeddings / norms  # (N, dim)

# éªŒè¯ï¼šæ‰€æœ‰å‘é‡é•¿åº¦éƒ½æ˜¯1
all_norms = np.linalg.norm(embeddings_normalized, axis=1)
print(f"æ‰€æœ‰èŒƒæ•°: {all_norms[:5]}")  # [1.0, 1.0, 1.0, 1.0, 1.0]
```

### 4.3 å¤„ç†é›¶å‘é‡

```python
def safe_normalize(vectors, eps=1e-8):
    """å®‰å…¨å½’ä¸€åŒ–ï¼Œå¤„ç†é›¶å‘é‡"""
    norms = np.linalg.norm(vectors, axis=1, keepdims=True)
    # é¿å…é™¤ä»¥0
    norms = np.maximum(norms, eps)
    return vectors / norms

# åŒ…å«é›¶å‘é‡çš„æ•°æ®
data = np.array([[3, 4], [0, 0], [1, 0]])
normalized = safe_normalize(data)
print(normalized)
```

### 4.4 å½’ä¸€åŒ–åçš„ç›¸ä¼¼åº¦è®¡ç®—

```python
# ä¸¤ä¸ªå½’ä¸€åŒ–å‘é‡
v1_norm = np.array([0.6, 0.8])
v2_norm = np.array([1.0, 0.0])

# ç›¸ä¼¼åº¦ = ç‚¹ç§¯ï¼ˆå› ä¸ºå·²å½’ä¸€åŒ–ï¼‰
similarity = np.dot(v1_norm, v2_norm)
print(f"ç›¸ä¼¼åº¦: {similarity}")  # 0.6
```

### 4.5 æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—

```python
# æŸ¥è¯¢å‘é‡ï¼ˆå·²å½’ä¸€åŒ–ï¼‰
query = np.array([0.6, 0.8])

# æ–‡æ¡£å‘é‡ï¼ˆå·²å½’ä¸€åŒ–ï¼‰
docs = np.array([
    [1.0, 0.0],
    [0.707, 0.707],
    [0.0, 1.0]
])

# æ‰¹é‡è®¡ç®—ç›¸ä¼¼åº¦
similarities = docs @ query  # çŸ©é˜µä¹˜æ³•
print(f"ç›¸ä¼¼åº¦: {similarities}")  # [0.6, 0.99, 0.8]

# æ‰¾æœ€ç›¸ä¼¼çš„
most_similar_idx = np.argmax(similarities)
print(f"æœ€ç›¸ä¼¼æ–‡æ¡£: {most_similar_idx}")  # 1
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… æ­£ç¡®å½’ä¸€åŒ–å•ä¸ªå’Œæ‰¹é‡embedding
- âœ… å¤„ç†é›¶å‘é‡çš„è¾¹ç•Œæƒ…å†µ
- âœ… ç”¨ç‚¹ç§¯è®¡ç®—ç›¸ä¼¼åº¦
- âœ… æ‰¹é‡æŸ¥è¯¢æœ€ç›¸ä¼¼æ–‡æ¡£
- âœ… ä¸ºå‘é‡æ•°æ®åº“ä½¿ç”¨æ‰“åŸºç¡€

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘ç”¨å‰ç«¯å¼€å‘ç†è§£å½’ä¸€åŒ–

### ç±»æ¯”1ï¼šå½’ä¸€åŒ– = CSS Normalize ğŸ¨

**CSS Normalizeçš„ä½œç”¨ï¼š** ç»Ÿä¸€ä¸åŒæµè§ˆå™¨çš„é»˜è®¤æ ·å¼

```css
/* ä¸åŒæµè§ˆå™¨é»˜è®¤marginä¸åŒ */
body {
  margin: 8px;   /* Chrome */
  margin: 10px;  /* Firefox */
  margin: 0;     /* æŸäº›æ—§æµè§ˆå™¨ */
}

/* CSS Normalizeç»Ÿä¸€å¤„ç† */
body {
  margin: 0;  /* ç»Ÿä¸€ä¸º0ï¼Œæ¶ˆé™¤å·®å¼‚ */
}
```

```python
# å‘é‡å½’ä¸€åŒ–ï¼šç»Ÿä¸€ä¸åŒæ¨¡å‹çš„è¾“å‡º
bert_emb = model_bert.encode(text)      # èŒƒæ•° ~20
openai_emb = model_openai.encode(text)  # èŒƒæ•° ~1

# å½’ä¸€åŒ–åç»Ÿä¸€
bert_norm = bert_emb / np.linalg.norm(bert_emb)      # èŒƒæ•° = 1
openai_norm = openai_emb / np.linalg.norm(openai_emb)  # èŒƒæ•° = 1

# ç°åœ¨å¯ä»¥å…¬å¹³æ¯”è¾ƒäº†ï¼
```

**ç›¸ä¼¼ç‚¹ï¼š**
- CSS Normalizeï¼šç»Ÿä¸€æµè§ˆå™¨å·®å¼‚
- å‘é‡å½’ä¸€åŒ–ï¼šç»Ÿä¸€æ¨¡å‹è¾“å‡ºå·®å¼‚

---

### ç±»æ¯”2ï¼šå½’ä¸€åŒ– = å“åº”å¼è®¾è®¡çš„ç™¾åˆ†æ¯” ğŸ“±

**å›ºå®šåƒç´ ï¼ˆæœªå½’ä¸€åŒ–ï¼‰ï¼š**
```css
.box {
  width: 1200px;  /* å›ºå®šå°ºå¯¸ */
}
```

**å“åº”å¼ç™¾åˆ†æ¯”ï¼ˆå½’ä¸€åŒ–ï¼‰ï¼š**
```css
.box {
  width: 100%;  /* ç›¸å¯¹å°ºå¯¸ï¼Œç»Ÿä¸€ä¸º"æ»¡å®½" */
}
```

```python
# å‘é‡ç±»æ¯”
absolute_vec = np.array([1200, 800])  # å›ºå®šå€¼
relative_vec = absolute_vec / np.linalg.norm(absolute_vec)  # å½’ä¸€åŒ–

print(f"åŸå‘é‡: {absolute_vec}")
print(f"å½’ä¸€åŒ–: {relative_vec}")  # æ¯”ä¾‹ä¸å˜ï¼Œé•¿åº¦ç»Ÿä¸€
```

**ç›¸ä¼¼ç‚¹ï¼š**
- å“åº”å¼è®¾è®¡ï¼šæ¶ˆé™¤è®¾å¤‡å·®å¼‚ï¼Œç»Ÿä¸€æ¯”ä¾‹
- å‘é‡å½’ä¸€åŒ–ï¼šæ¶ˆé™¤å°ºåº¦å·®å¼‚ï¼Œä¿ç•™æ–¹å‘

---

### ç±»æ¯”3ï¼šå½’ä¸€åŒ– = é¢œè‰²å€¼æ ‡å‡†åŒ– ğŸŒˆ

**RGBå€¼æœ‰å¤šç§è¡¨ç¤ºï¼š**
```javascript
// ä¸åŒè¡¨ç¤ºï¼Œç›¸åŒé¢œè‰²
const color1 = [255, 128, 0];     // 0-255èŒƒå›´
const color2 = [1.0, 0.5, 0.0];   // 0-1èŒƒå›´ï¼ˆå½’ä¸€åŒ–ï¼‰
const color3 = "#FF8000";          // åå…­è¿›åˆ¶

// ç»Ÿä¸€ä¸º0-1èŒƒå›´
const normalized = color1.map(c => c / 255);
// [1.0, 0.5, 0.0]
```

```python
# å‘é‡å½’ä¸€åŒ–ç±»ä¼¼
v = np.array([255, 128, 0])
v_norm = v / np.linalg.norm(v)  # [0.89, 0.45, 0.0]
# é•¿åº¦ç»Ÿä¸€ä¸º1ï¼Œæ–¹å‘ï¼ˆæ¯”ä¾‹ï¼‰ä¸å˜
```

---

### ç±»æ¯”4ï¼šå½’ä¸€åŒ– = z-indexå±‚çº§æ ‡å‡†åŒ– ğŸ“š

```javascript
// ä¸åŒç»„ä»¶çš„z-indexæ··ä¹±
const modal = { zIndex: 9999 };
const dropdown = { zIndex: 100 };
const tooltip = { zIndex: 999999 };

// æ ‡å‡†åŒ–å±‚çº§ç³»ç»Ÿ
const zIndexLevels = {
  base: 1,
  dropdown: 10,
  modal: 100,
  tooltip: 1000
};
// ç»Ÿä¸€æ ‡å‡†ï¼Œä¾¿äºç®¡ç†
```

```python
# å‘é‡å½’ä¸€åŒ–ä¹Ÿæ˜¯å»ºç«‹ç»Ÿä¸€æ ‡å‡†
embeddings_from_different_models = [...]

# å½’ä¸€åŒ–å
normalized = [v / np.linalg.norm(v) for v in embeddings_from_different_models]
# ç»Ÿä¸€å°ºåº¦ï¼Œä¾¿äºæ¯”è¾ƒ
```

---

### ç±»æ¯”5ï¼šå½’ä¸€åŒ– = å•ä½è½¬æ¢ ğŸ“

```javascript
// ä¸åŒå•ä½çš„é•¿åº¦
const meters = 1.5;
const centimeters = 150;
const millimeters = 1500;

// ç»Ÿä¸€ä¸ºç±³
const toMeters = {
  meters: meters,
  centimeters: centimeters / 100,
  millimeters: millimeters / 1000
};
// éƒ½æ˜¯1.5ç±³
```

```python
# å‘é‡å½’ä¸€åŒ–ï¼šç»Ÿä¸€"å•ä½"ä¸ºé•¿åº¦1
v1 = np.array([3, 4])      # é•¿åº¦5
v2 = np.array([6, 8])      # é•¿åº¦10
v3 = np.array([0.3, 0.4])  # é•¿åº¦0.5

# å½’ä¸€åŒ–åéƒ½æ˜¯é•¿åº¦1
v1_norm = v1 / np.linalg.norm(v1)  # [0.6, 0.8]
v2_norm = v2 / np.linalg.norm(v2)  # [0.6, 0.8]
v3_norm = v3 / np.linalg.norm(v3)  # [0.6, 0.8]

# æ–¹å‘ç›¸åŒçš„å‘é‡ï¼Œå½’ä¸€åŒ–åå®Œå…¨ç›¸åŒï¼
```

---

### ç±»æ¯”æ€»ç»“è¡¨ ğŸ“Š

| NumPyæ¦‚å¿µ | å‰ç«¯ç±»æ¯” | æ ¸å¿ƒç›¸ä¼¼ç‚¹ |
|----------|---------|-----------|
| å‘é‡å½’ä¸€åŒ– | CSS Normalize | ç»Ÿä¸€ä¸åŒæ¥æºçš„å·®å¼‚ |
| é•¿åº¦ç»Ÿä¸€ä¸º1 | å“åº”å¼ç™¾åˆ†æ¯” | æ¶ˆé™¤ç»å¯¹å°ºåº¦ |
| ä¿æŒæ–¹å‘ | ä¿æŒæ¯”ä¾‹ | æ ¸å¿ƒç‰¹å¾ä¸å˜ |
| ç‚¹ç§¯=ç›¸ä¼¼åº¦ | å•ä½ç»Ÿä¸€åå¯æ¯”è¾ƒ | æ ‡å‡†åŒ–ä¾¿äºæ¯”è¾ƒ |
| æ‰¹é‡å½’ä¸€åŒ– | æ‰¹é‡æ ·å¼å¤„ç† | é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ® |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘æœ€å®¹æ˜“é”™çš„3ä¸ªè¯¯åŒº

### è¯¯åŒº1ï¼šå½’ä¸€åŒ–åªæ˜¯ä¸ºäº†å¥½çœ‹/æ•´é½ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å½’ä¸€åŒ–ä¸æ˜¯"ç¾åŒ–"æ•°æ®
- å®ƒæœ‰**å®é™…çš„æ•°å­¦å’Œæ€§èƒ½æ„ä¹‰**
- ç›´æ¥å½±å“ç›¸ä¼¼åº¦è®¡ç®—å’Œæ£€ç´¢æ•ˆç‡

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- "å½’ä¸€åŒ–"å¬èµ·æ¥åƒ"æ•´ç†æ•°æ®"
- ä¸äº†è§£ä½™å¼¦ç›¸ä¼¼åº¦å’Œç‚¹ç§¯çš„å…³ç³»
- æ²¡æœ‰æ„è¯†åˆ°æ€§èƒ½å·®å¼‚

**æ­£ç¡®ç†è§£ï¼š**
```python
import numpy as np
import time

# 100ä¸‡ä¸ªå‘é‡
docs = np.random.rand(1000000, 768).astype(np.float32)
query = np.random.rand(768).astype(np.float32)

# æ–¹æ³•1ï¼šç›´æ¥ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆæœªå½’ä¸€åŒ–ï¼‰
start = time.time()
doc_norms = np.linalg.norm(docs, axis=1)
query_norm = np.linalg.norm(query)
cosine_sims = (docs @ query) / (doc_norms * query_norm)
time_cosine = time.time() - start

# æ–¹æ³•2ï¼šå½’ä¸€åŒ–åç‚¹ç§¯
start = time.time()
docs_norm = docs / np.linalg.norm(docs, axis=1, keepdims=True)
query_norm = query / np.linalg.norm(query)
dot_sims = docs_norm @ query_norm
time_dot = time.time() - start

print(f"ä½™å¼¦å…¬å¼: {time_cosine:.4f}ç§’")
print(f"å½’ä¸€åŒ–ç‚¹ç§¯: {time_dot:.4f}ç§’")
print(f"ç»“æœç›¸åŒ: {np.allclose(cosine_sims, dot_sims)}")
```

**çœŸæ­£çš„ä»·å€¼ï¼š**
1. **æ€§èƒ½**ï¼šç‚¹ç§¯æ¯”ä½™å¼¦å¿«2-3å€
2. **å­˜å‚¨**ï¼šé¢„å½’ä¸€åŒ–é¿å…é‡å¤è®¡ç®—
3. **ç²¾åº¦**ï¼šæ•°å€¼æ›´ç¨³å®š

---

### è¯¯åŒº2ï¼šæ‰€æœ‰å‘é‡æ•°æ®åº“éƒ½è‡ªåŠ¨å½’ä¸€åŒ– âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å¤§å¤šæ•°å‘é‡æ•°æ®åº“**ä¸ä¼š**è‡ªåŠ¨å½’ä¸€åŒ–
- éœ€è¦**ç”¨æˆ·è‡ªå·±**åœ¨å…¥åº“å‰å½’ä¸€åŒ–
- é”™è¯¯çš„å‡è®¾ä¼šå¯¼è‡´æ£€ç´¢ç»“æœé”™è¯¯

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- è®¤ä¸ºæ•°æ®åº“ä¼š"æ™ºèƒ½å¤„ç†"
- æ··æ·†äº†åº¦é‡ç±»å‹ï¼ˆIP vs COSINE vs L2ï¼‰
- æ–‡æ¡£æ²¡ä»”ç»†çœ‹

**æ­£ç¡®ç†è§£ï¼š**

| æ•°æ®åº“ | è‡ªåŠ¨å½’ä¸€åŒ– | å»ºè®®åšæ³• |
|-------|-----------|---------|
| Milvus | âŒ ä¸ä¼š | æ‰‹åŠ¨å½’ä¸€åŒ– + IPåº¦é‡ |
| Pinecone | âŒ ä¸ä¼š | æ‰‹åŠ¨å½’ä¸€åŒ– |
| Weaviate | âœ… ä½¿ç”¨cosineåº¦é‡æ—¶ | å¯ä¸å½’ä¸€åŒ– |
| Faiss | âŒ ä¸ä¼š | æ‰‹åŠ¨å½’ä¸€åŒ– |

**Milvusç¤ºä¾‹ï¼š**
```python
from pymilvus import Collection

# âŒ é”™è¯¯ï¼šå‡è®¾è‡ªåŠ¨å½’ä¸€åŒ–
embeddings = model.encode(texts)
collection.insert([ids, embeddings])  # æœªå½’ä¸€åŒ–ï¼

# ä½¿ç”¨IPåº¦é‡ï¼Œç»“æœä¼šé”™è¯¯
collection.search(query_embedding, metric_type="IP")  # âŒ

# âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨å½’ä¸€åŒ–
embeddings = model.encode(texts)
embeddings_norm = embeddings / np.linalg.norm(embeddings, axis=1, keepdims=True)
collection.insert([ids, embeddings_norm.tolist()])

# æŸ¥è¯¢ä¹Ÿè¦å½’ä¸€åŒ–
query_norm = query_embedding / np.linalg.norm(query_embedding)
collection.search([query_norm], metric_type="IP")  # âœ…
```

---

### è¯¯åŒº3ï¼šå½’ä¸€åŒ–ä¼šä¸¢å¤±é‡è¦ä¿¡æ¯ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- å½’ä¸€åŒ–åªä¸¢å¼ƒ**é•¿åº¦ä¿¡æ¯**
- ä¿ç•™äº†æœ€é‡è¦çš„**æ–¹å‘ä¿¡æ¯**
- è¯­ä¹‰ç›¸ä¼¼åº¦å…³å¿ƒçš„æ˜¯æ–¹å‘ï¼Œä¸æ˜¯é•¿åº¦

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- ç›´è§‰ä¸Š"é™¤ä»¥æŸä¸ªæ•°"åƒæ˜¯"ä¸¢æ‰äº†ä»€ä¹ˆ"
- ä¸ç†è§£è¯­ä¹‰å‘é‡çš„æœ¬è´¨
- æ··æ·†äº†å½’ä¸€åŒ–å’Œå…¶ä»–æ•°æ®å¤„ç†

**æ­£ç¡®ç†è§£ï¼š**

**è¯­ä¹‰ç›¸ä¼¼åº¦å…³å¿ƒçš„æ˜¯ä»€ä¹ˆï¼Ÿ**
```python
# æ–‡æœ¬è¯­ä¹‰
text1 = "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„å­é¢†åŸŸ"
text2 = "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„å­é¢†åŸŸï¼ï¼ï¼"  # åªåŠ äº†æ„Ÿå¹å·

emb1 = model.encode(text1)
emb2 = model.encode(text2)

# èŒƒæ•°å¯èƒ½ä¸åŒï¼ˆå› ä¸ºæ„Ÿå¹å·ï¼‰
print(f"emb1èŒƒæ•°: {np.linalg.norm(emb1):.4f}")
print(f"emb2èŒƒæ•°: {np.linalg.norm(emb2):.4f}")

# ä½†æ–¹å‘å‡ ä¹ç›¸åŒï¼ˆè¯­ä¹‰ç›¸åŒï¼‰
cosine = np.dot(emb1, emb2) / (np.linalg.norm(emb1) * np.linalg.norm(emb2))
print(f"ä½™å¼¦ç›¸ä¼¼åº¦: {cosine:.4f}")  # æ¥è¿‘1.0

# å½’ä¸€åŒ–åï¼š
emb1_norm = emb1 / np.linalg.norm(emb1)
emb2_norm = emb2 / np.linalg.norm(emb2)
print(f"å½’ä¸€åŒ–ç‚¹ç§¯: {np.dot(emb1_norm, emb2_norm):.4f}")  # åŒæ ·æ¥è¿‘1.0
```

**é•¿åº¦ä¿¡æ¯æœ‰ç”¨å—ï¼Ÿ**
- åœ¨è¯­ä¹‰æœç´¢ä¸­ï¼š**é€šå¸¸æ— ç”¨**
- é•¿åº¦å˜åŒ–å¯èƒ½æ˜¯ç”±äºï¼š
  - æ–‡æœ¬é•¿åº¦ä¸åŒ
  - æ¨¡å‹éšæœºæ€§
  - ç¼–ç ç»†èŠ‚å·®å¼‚
- è¿™äº›éƒ½**ä¸ä»£è¡¨è¯­ä¹‰å·®å¼‚**

**ä»€ä¹ˆæ—¶å€™é•¿åº¦é‡è¦ï¼Ÿ**
```python
# ç‰¹æ®Šåœºæ™¯ï¼šæ–‡æ¡£é‡è¦æ€§åŠ æƒ
# æœ‰äº›ç³»ç»Ÿç”¨èŒƒæ•°è¡¨ç¤º"ç½®ä¿¡åº¦"

# ä½†è¿™æ˜¯å°‘æ•°æƒ…å†µï¼Œä¸”é€šå¸¸æœ‰ä¸“é—¨å­—æ®µå­˜å‚¨
document = {
    "embedding": normalized_embedding,  # å½’ä¸€åŒ–åçš„å‘é‡
    "confidence": original_norm         # å•ç‹¬å­˜å‚¨èŒƒæ•°
}
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘ä¸€ä¸ªèƒ½è·‘çš„ä¾‹å­

```python
import numpy as np
import time

print("=" * 70)
print(" å‘é‡æ•°æ®åº“å½’ä¸€åŒ–å®Œæ•´ç¤ºä¾‹")
print("=" * 70)

# ===== 1. åŸºç¡€å½’ä¸€åŒ– =====
print("\n=== 1. å•å‘é‡å½’ä¸€åŒ– ===\n")

v = np.array([3, 4, 0])
print(f"åŸå‘é‡: {v}")
print(f"åŸèŒƒæ•°: {np.linalg.norm(v)}")

# å½’ä¸€åŒ–
v_normalized = v / np.linalg.norm(v)
print(f"å½’ä¸€åŒ–å‘é‡: {v_normalized}")
print(f"å½’ä¸€åŒ–åèŒƒæ•°: {np.linalg.norm(v_normalized):.10f}")  # 1.0

# ===== 2. æ‰¹é‡å½’ä¸€åŒ– =====
print("\n=== 2. æ‰¹é‡å½’ä¸€åŒ– ===\n")

# æ¨¡æ‹Ÿ1000ä¸ª768ç»´embedding
np.random.seed(42)
embeddings = np.random.randn(1000, 768).astype(np.float32)

print(f"æ•°æ®å½¢çŠ¶: {embeddings.shape}")
print(f"åŸå§‹èŒƒæ•°èŒƒå›´: [{np.linalg.norm(embeddings, axis=1).min():.2f}, "
      f"{np.linalg.norm(embeddings, axis=1).max():.2f}]")

# æ‰¹é‡å½’ä¸€åŒ–
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (1000, 1)
embeddings_normalized = embeddings / norms

# éªŒè¯
normalized_norms = np.linalg.norm(embeddings_normalized, axis=1)
print(f"å½’ä¸€åŒ–åèŒƒæ•°èŒƒå›´: [{normalized_norms.min():.6f}, {normalized_norms.max():.6f}]")
print("æ‰€æœ‰å‘é‡èŒƒæ•°éƒ½æ˜¯1.0!")

# ===== 3. æ€§èƒ½å¯¹æ¯” =====
print("\n=== 3. æ€§èƒ½å¯¹æ¯”ï¼šå¾ªç¯ vs å‘é‡åŒ– ===\n")

# 10ä¸‡ä¸ªå‘é‡
large_embeddings = np.random.randn(100000, 768).astype(np.float32)

# æ–¹æ³•1ï¼šå¾ªç¯ï¼ˆé‡‡æ ·1000ä¸ªä¼°ç®—ï¼‰
sample = large_embeddings[:1000]
start = time.time()
normalized_loop = np.array([v / np.linalg.norm(v) for v in sample])
time_loop = (time.time() - start) * 100  # ä¼°ç®—10ä¸‡ä¸ª

# æ–¹æ³•2ï¼šå‘é‡åŒ–
start = time.time()
norms = np.linalg.norm(large_embeddings, axis=1, keepdims=True)
normalized_vec = large_embeddings / norms
time_vec = time.time() - start

print(f"å¾ªç¯å½’ä¸€åŒ–ï¼ˆä¼°ç®—ï¼‰: {time_loop:.2f}ç§’")
print(f"å‘é‡åŒ–å½’ä¸€åŒ–: {time_vec:.4f}ç§’")
print(f"åŠ é€Ÿæ¯”: {time_loop/time_vec:.0f}å€")

# ===== 4. å½’ä¸€åŒ–ä¸ç›¸ä¼¼åº¦ =====
print("\n=== 4. å½’ä¸€åŒ–ä¸ç›¸ä¼¼åº¦çš„å…³ç³» ===\n")

v1 = np.array([3, 4])
v2 = np.array([4, 3])

print(f"v1 = {v1}, èŒƒæ•° = {np.linalg.norm(v1):.2f}")
print(f"v2 = {v2}, èŒƒæ•° = {np.linalg.norm(v2):.2f}")

# ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆå®Œæ•´å…¬å¼ï¼‰
cosine_formula = np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))
print(f"\nä½™å¼¦å…¬å¼: {cosine_formula:.6f}")

# å½’ä¸€åŒ–åç‚¹ç§¯
v1_norm = v1 / np.linalg.norm(v1)
v2_norm = v2 / np.linalg.norm(v2)
cosine_dot = np.dot(v1_norm, v2_norm)
print(f"å½’ä¸€åŒ–ç‚¹ç§¯: {cosine_dot:.6f}")

print(f"ç»“æœç›¸åŒ: {np.isclose(cosine_formula, cosine_dot)}")

# ===== 5. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®— =====
print("\n=== 5. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®— ===\n")

# 5ä¸ªæ–‡æ¡£ï¼Œ8ç»´ï¼ˆç®€åŒ–æ¼”ç¤ºï¼‰
docs = np.random.randn(5, 8).astype(np.float32)
query = np.random.randn(8).astype(np.float32)

# å½’ä¸€åŒ–
docs_norm = docs / np.linalg.norm(docs, axis=1, keepdims=True)
query_norm = query / np.linalg.norm(query)

# è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆç‚¹ç§¯ï¼‰
similarities = docs_norm @ query_norm

print(f"æŸ¥è¯¢ä¸å„æ–‡æ¡£çš„ç›¸ä¼¼åº¦:")
for i, sim in enumerate(similarities):
    print(f"  æ–‡æ¡£{i}: {sim:.4f}")

# æ‰¾æœ€ç›¸ä¼¼
top_idx = np.argmax(similarities)
print(f"\næœ€ç›¸ä¼¼æ–‡æ¡£: æ–‡æ¡£{top_idx}, ç›¸ä¼¼åº¦ = {similarities[top_idx]:.4f}")

# ===== 6. å¤„ç†é›¶å‘é‡ =====
print("\n=== 6. å®‰å…¨å½’ä¸€åŒ–ï¼ˆå¤„ç†é›¶å‘é‡ï¼‰===\n")

def safe_normalize(vectors, eps=1e-8):
    """å®‰å…¨å½’ä¸€åŒ–ï¼Œé¿å…é™¤ä»¥0"""
    norms = np.linalg.norm(vectors, axis=-1, keepdims=True)
    norms = np.maximum(norms, eps)  # é¿å…é™¤ä»¥0
    return vectors / norms

# åŒ…å«é›¶å‘é‡
data = np.array([[3, 4], [0, 0], [1, 0]], dtype=np.float32)
print(f"åŸæ•°æ®:\n{data}")

normalized = safe_normalize(data)
print(f"\nå®‰å…¨å½’ä¸€åŒ–å:\n{normalized}")
print(f"èŒƒæ•°: {np.linalg.norm(normalized, axis=1)}")

# ===== 7. æ¬§æ°è·ç¦»ä¸ä½™å¼¦çš„å…³ç³» =====
print("\n=== 7. å½’ä¸€åŒ–å‘é‡çš„è·ç¦»å…³ç³» ===\n")

v1 = np.array([1, 0])
v2 = np.array([0.6, 0.8])  # å·²å½’ä¸€åŒ–

# ä½™å¼¦ç›¸ä¼¼åº¦
cosine = np.dot(v1, v2)
print(f"ä½™å¼¦ç›¸ä¼¼åº¦: {cosine:.4f}")

# æ¬§æ°è·ç¦»
euclidean = np.linalg.norm(v1 - v2)
print(f"æ¬§æ°è·ç¦»: {euclidean:.4f}")

# éªŒè¯å…³ç³»ï¼šæ¬§æ°è·ç¦»Â² = 2 - 2*cos
euclidean_squared = euclidean ** 2
relation = 2 - 2 * cosine
print(f"\næ¬§æ°è·ç¦»Â² = {euclidean_squared:.4f}")
print(f"2 - 2*cos = {relation:.4f}")
print(f"å…³ç³»æˆç«‹: {np.isclose(euclidean_squared, relation)}")

# ===== 8. å‘é‡æ•°æ®åº“æ¨¡æ‹Ÿ =====
print("\n=== 8. å‘é‡æ•°æ®åº“æ¨¡æ‹Ÿ ===\n")

class SimpleVectorDB:
    """ç®€å•çš„å‘é‡æ•°æ®åº“æ¨¡æ‹Ÿ"""
    
    def __init__(self):
        self.embeddings = []
        self.texts = []
    
    def insert(self, text, embedding):
        """æ’å…¥æ—¶å½’ä¸€åŒ–"""
        embedding_norm = embedding / np.linalg.norm(embedding)
        self.embeddings.append(embedding_norm)
        self.texts.append(text)
    
    def search(self, query_embedding, top_k=3):
        """æœç´¢æœ€ç›¸ä¼¼çš„æ–‡æ¡£"""
        query_norm = query_embedding / np.linalg.norm(query_embedding)
        
        # è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆç‚¹ç§¯ï¼‰
        embeddings_matrix = np.array(self.embeddings)
        similarities = embeddings_matrix @ query_norm
        
        # è¿”å›Top-K
        top_indices = np.argsort(similarities)[::-1][:top_k]
        return [(self.texts[i], similarities[i]) for i in top_indices]

# ä½¿ç”¨ç¤ºä¾‹
db = SimpleVectorDB()

# æ¨¡æ‹Ÿæ–‡æ¡£embedding
np.random.seed(123)
documents = [
    ("æœºå™¨å­¦ä¹ åŸºç¡€", np.random.randn(16)),
    ("æ·±åº¦å­¦ä¹ å…¥é—¨", np.random.randn(16)),
    ("Pythonç¼–ç¨‹", np.random.randn(16)),
    ("æ•°æ®åˆ†æ", np.random.randn(16)),
    ("è‡ªç„¶è¯­è¨€å¤„ç†", np.random.randn(16))
]

for text, emb in documents:
    db.insert(text, emb)

print("å·²æ’å…¥æ–‡æ¡£:")
for text, _ in documents:
    print(f"  - {text}")

# æŸ¥è¯¢
query_emb = np.random.randn(16)
results = db.search(query_emb, top_k=3)

print(f"\næŸ¥è¯¢ç»“æœ Top-3:")
for text, score in results:
    print(f"  {text}: {score:.4f}")

# ===== 9. å¤§è§„æ¨¡æ€§èƒ½æµ‹è¯• =====
print("\n=== 9. å¤§è§„æ¨¡æ€§èƒ½æµ‹è¯• ===\n")

# 100ä¸‡æ–‡æ¡£
num_docs = 1000000
dim = 768

print(f"æµ‹è¯•è§„æ¨¡: {num_docs}ä¸ªæ–‡æ¡£, {dim}ç»´")

# ç”Ÿæˆæ•°æ®
docs_large = np.random.randn(num_docs, dim).astype(np.float32)
query_large = np.random.randn(dim).astype(np.float32)

# å½’ä¸€åŒ–
start = time.time()
docs_norm = docs_large / np.linalg.norm(docs_large, axis=1, keepdims=True)
query_norm = query_large / np.linalg.norm(query_large)
time_normalize = time.time() - start

# ç›¸ä¼¼åº¦è®¡ç®—
start = time.time()
similarities = docs_norm @ query_norm
time_search = time.time() - start

# Top-10
start = time.time()
top_10 = np.argpartition(similarities, -10)[-10:]
top_10_sorted = top_10[np.argsort(similarities[top_10])[::-1]]
time_topk = time.time() - start

print(f"å½’ä¸€åŒ–è€—æ—¶: {time_normalize:.3f}ç§’")
print(f"ç›¸ä¼¼åº¦è®¡ç®—: {time_search:.3f}ç§’")
print(f"Top-10æ’åº: {time_topk*1000:.3f}æ¯«ç§’")
print(f"\nTop-10ç´¢å¼•: {top_10_sorted}")
print(f"Top-10ç›¸ä¼¼åº¦: {similarities[top_10_sorted]}")

# ===== 10. å†…å­˜ä¼˜åŒ– =====
print("\n=== 10. å†…å­˜ä¼˜åŒ–ï¼šfloat32 vs float64 ===\n")

docs_f64 = np.random.randn(100000, 768)  # float64
docs_f32 = docs_f64.astype(np.float32)   # float32

print(f"float64å†…å­˜: {docs_f64.nbytes / (1024**2):.2f} MB")
print(f"float32å†…å­˜: {docs_f32.nbytes / (1024**2):.2f} MB")
print(f"èŠ‚çœ: {(1 - docs_f32.nbytes/docs_f64.nbytes)*100:.0f}%")

# ç²¾åº¦å¯¹æ¯”
docs_f64_norm = docs_f64 / np.linalg.norm(docs_f64, axis=1, keepdims=True)
docs_f32_norm = docs_f32 / np.linalg.norm(docs_f32, axis=1, keepdims=True)

diff = np.abs(docs_f64_norm - docs_f32_norm.astype(np.float64)).max()
print(f"\nç²¾åº¦å·®å¼‚ï¼ˆæœ€å¤§ï¼‰: {diff:.2e}")
print("å·®å¼‚æå°ï¼Œfloat32è¶³å¤Ÿç”¨äºå‘é‡æ•°æ®åº“ï¼")

print("\n" + "=" * 70)
print(" æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
print("=" * 70)
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
======================================================================
 å‘é‡æ•°æ®åº“å½’ä¸€åŒ–å®Œæ•´ç¤ºä¾‹
======================================================================

=== 1. å•å‘é‡å½’ä¸€åŒ– ===

åŸå‘é‡: [3 4 0]
åŸèŒƒæ•°: 5.0
å½’ä¸€åŒ–å‘é‡: [0.6 0.8 0. ]
å½’ä¸€åŒ–åèŒƒæ•°: 1.0000000000

=== 2. æ‰¹é‡å½’ä¸€åŒ– ===

æ•°æ®å½¢çŠ¶: (1000, 768)
åŸå§‹èŒƒæ•°èŒƒå›´: [21.45, 32.89]
å½’ä¸€åŒ–åèŒƒæ•°èŒƒå›´: [1.000000, 1.000000]
æ‰€æœ‰å‘é‡èŒƒæ•°éƒ½æ˜¯1.0!

=== 3. æ€§èƒ½å¯¹æ¯”ï¼šå¾ªç¯ vs å‘é‡åŒ– ===

å¾ªç¯å½’ä¸€åŒ–ï¼ˆä¼°ç®—ï¼‰: 2.34ç§’
å‘é‡åŒ–å½’ä¸€åŒ–: 0.0123ç§’
åŠ é€Ÿæ¯”: 190å€

...
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘å¦‚æœè¢«é—®åˆ°ï¼Œæ€ä¹ˆç­”å‡ºå½©

### é—®é¢˜ï¼š"ä¸ºä»€ä¹ˆå‘é‡æ•°æ®åº“è¦å¯¹embeddingè¿›è¡Œå½’ä¸€åŒ–ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"å½’ä¸€åŒ–æ˜¯ä¸ºäº†ç»Ÿä¸€å‘é‡çš„é•¿åº¦ï¼Œè®©å®ƒä»¬æ›´å¥½æ¯”è¾ƒã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **å‘é‡æ•°æ®åº“å½’ä¸€åŒ–æœ‰ä¸‰ä¸ªæ ¸å¿ƒåŸå› ï¼š**
>
> 1. **ç®€åŒ–ç›¸ä¼¼åº¦è®¡ç®—**
>    - ä½™å¼¦ç›¸ä¼¼åº¦å…¬å¼ï¼šcos(Î¸) = (vâ‚Â·vâ‚‚) / (||vâ‚|| Ã— ||vâ‚‚||)
>    - å½’ä¸€åŒ–åï¼ˆ||v|| = 1ï¼‰ï¼šcos(Î¸) = vâ‚Â·vâ‚‚ = ç‚¹ç§¯
>    - çœå»äº†èŒƒæ•°è®¡ç®—ï¼Œæ€§èƒ½æå‡2-3å€
>
> 2. **ç»Ÿä¸€ä¸åŒæ¥æºçš„å‘é‡**
>    - ä¸åŒæ¨¡å‹è¾“å‡ºçš„èŒƒæ•°å·®å¼‚å¾ˆå¤§ï¼ˆBERT ~20ï¼ŒOpenAI ~1ï¼‰
>    - ç›´æ¥ç”¨ç‚¹ç§¯ä¼šåå‘å¤§èŒƒæ•°å‘é‡
>    - å½’ä¸€åŒ–ååªæ¯”è¾ƒæ–¹å‘ï¼Œå…¬å¹³åˆç†
>
> 3. **æ•°å€¼ç¨³å®šæ€§**
>    - é¿å…å¤§èŒƒæ•°å¯¼è‡´çš„æº¢å‡º
>    - å½’ä¸€åŒ–åç›¸ä¼¼åº¦å§‹ç»ˆåœ¨[-1, 1]
>    - æ•°å€¼è®¡ç®—æ›´ç¨³å®š
>
> **å®é™…æ“ä½œï¼š**
> - å…¥åº“æ—¶å½’ä¸€åŒ–ï¼š`embedding / np.linalg.norm(embedding)`
> - æŸ¥è¯¢æ—¶ä¹Ÿå½’ä¸€åŒ–
> - ä½¿ç”¨IPï¼ˆå†…ç§¯ï¼‰åº¦é‡ï¼Œç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦
>
> **æ³¨æ„ï¼š** å¤§å¤šæ•°å‘é‡æ•°æ®åº“ä¸ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±å¤„ç†ï¼
> - Milvusï¼šæ‰‹åŠ¨å½’ä¸€åŒ– + IPåº¦é‡
> - Pineconeï¼šæ‰‹åŠ¨å½’ä¸€åŒ–
> - Weaviateï¼šä½¿ç”¨cosineåº¦é‡æ—¶è‡ªåŠ¨å¤„ç†

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… ç»™å‡ºäº†ä¸‰ä¸ªå±‚æ¬¡çš„åŸå› ï¼ˆè®¡ç®—ã€å…¬å¹³æ€§ã€ç¨³å®šæ€§ï¼‰
2. âœ… è¯´æ˜äº†æ•°å­¦åŸç†ï¼ˆä½™å¼¦ = ç‚¹ç§¯ï¼‰
3. âœ… æåˆ°äº†å…·ä½“æ€§èƒ½æå‡
4. âœ… ç»™å‡ºäº†å®é™…æ“ä½œæ–¹æ³•
5. âœ… æŒ‡å‡ºäº†å¸¸è§è¯¯åŒºï¼ˆä¸è‡ªåŠ¨å½’ä¸€åŒ–ï¼‰
6. âœ… åˆ—ä¸¾äº†ä¸»æµæ•°æ®åº“çš„åšæ³•

---

### å»¶ä¼¸é—®é¢˜ï¼š"å½’ä¸€åŒ–ä¼šä¸¢å¤±ä¿¡æ¯å—ï¼Ÿ"

**å‡ºå½©å›ç­”ï¼š**

> **å½’ä¸€åŒ–åªä¸¢å¼ƒé•¿åº¦ä¿¡æ¯ï¼Œä¿ç•™æ–¹å‘ä¿¡æ¯ï¼Œè¿™åœ¨è¯­ä¹‰æœç´¢ä¸­æ˜¯åˆç†çš„ï¼š**
>
> 1. **è¯­ä¹‰ç›¸ä¼¼åº¦å…³å¿ƒæ–¹å‘**
>    - "æœºå™¨å­¦ä¹ "å’Œ"æœºå™¨å­¦ä¹ ï¼ï¼ï¼"è¯­ä¹‰ç›¸åŒ
>    - å®ƒä»¬çš„embeddingæ–¹å‘ç›¸è¿‘ï¼Œä½†èŒƒæ•°å¯èƒ½ä¸åŒ
>    - å½’ä¸€åŒ–åå®ƒä»¬å‡ ä¹ç›¸åŒï¼Œç¬¦åˆé¢„æœŸ
>
> 2. **é•¿åº¦å˜åŒ–çš„æ¥æº**
>    - æ–‡æœ¬é•¿åº¦ä¸åŒ
>    - æ¨¡å‹éšæœºæ€§
>    - ç¼–ç ç»†èŠ‚å·®å¼‚
>    - è¿™äº›éƒ½ä¸ä»£è¡¨è¯­ä¹‰å·®å¼‚
>
> 3. **ç‰¹æ®Šæƒ…å†µ**
>    - å¦‚æœé•¿åº¦çœŸçš„é‡è¦ï¼ˆå¦‚ç½®ä¿¡åº¦ï¼‰
>    - å¯ä»¥å•ç‹¬å­˜å‚¨ï¼š`{"embedding": normalized, "confidence": norm}`
>    - ä½†è¿™æ˜¯å°‘æ•°åœºæ™¯
>
> **ç»“è®ºï¼š** å¯¹äºè¯­ä¹‰æœç´¢ï¼Œå½’ä¸€åŒ–ä¸¢å¼ƒçš„æ˜¯å™ªéŸ³ï¼Œä¿ç•™çš„æ˜¯ä¿¡å·ã€‚

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘10ä¸ª2åˆ†é’ŸçŸ¥è¯†å¡ç‰‡

### å¡ç‰‡1ï¼šå½’ä¸€åŒ–çš„æœ¬è´¨ ğŸ¯

**ä¸€å¥è¯ï¼š** å½’ä¸€åŒ– = æŠŠå‘é‡é•¿åº¦å˜æˆ1ï¼Œåªä¿ç•™æ–¹å‘

**æ•°å­¦å…¬å¼ï¼š**
```
vÌ‚ = v / ||v||
```

**ä»£ç ï¼š**
```python
v = np.array([3, 4])
v_norm = v / np.linalg.norm(v)  # [0.6, 0.8]
```

**åº”ç”¨ï¼š** å‘é‡æ•°æ®åº“å­˜å‚¨å‰çš„å¿…è¦é¢„å¤„ç†

---

### å¡ç‰‡2ï¼šä¸ºä»€ä¹ˆè¦å½’ä¸€åŒ– ğŸ“Š

**ä¸‰å¤§åŸå› ï¼š**

1. **ç®€åŒ–è®¡ç®—**ï¼šä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯
2. **ç»Ÿä¸€å°ºåº¦**ï¼šä¸åŒæ¨¡å‹è¾“å‡ºå¯æ¯”è¾ƒ
3. **æ•°å€¼ç¨³å®š**ï¼šé¿å…æº¢å‡º/ä¸‹æº¢

**å…¬å¼æ¨å¯¼ï¼š**
```
cos(Î¸) = (vâ‚Â·vâ‚‚) / (||vâ‚|| Ã— ||vâ‚‚||)

å¦‚æœ ||vâ‚|| = ||vâ‚‚|| = 1ï¼š
cos(Î¸) = vâ‚Â·vâ‚‚  â† ç›´æ¥ç‚¹ç§¯ï¼
```

---

### å¡ç‰‡3ï¼šå•å‘é‡å½’ä¸€åŒ– ğŸ“

**ä»£ç æ¨¡æ¿ï¼š**
```python
import numpy as np

# åŸå§‹å‘é‡
v = np.array([3, 4, 0])

# å½’ä¸€åŒ–
v_normalized = v / np.linalg.norm(v)

# éªŒè¯
print(np.linalg.norm(v_normalized))  # 1.0
```

**æ³¨æ„ï¼š** é›¶å‘é‡ä¸èƒ½å½’ä¸€åŒ–ï¼

---

### å¡ç‰‡4ï¼šæ‰¹é‡å½’ä¸€åŒ– ğŸš€

**é«˜æ•ˆæ–¹æ³•ï¼ˆå‘é‡åŒ–ï¼‰ï¼š**
```python
# embeddings.shape = (N, dim)
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (N, 1)
normalized = embeddings / norms  # (N, dim)
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
- å¾ªç¯ï¼š~2ç§’ï¼ˆ10ä¸‡å‘é‡ï¼‰
- å‘é‡åŒ–ï¼š~0.01ç§’
- **åŠ é€Ÿ200å€ï¼**

---

### å¡ç‰‡5ï¼škeepdimsçš„ä½œç”¨ ğŸ”§

**é—®é¢˜ï¼š** ä¸ºä»€ä¹ˆè¦`keepdims=True`ï¼Ÿ

```python
embeddings = np.random.rand(1000, 768)  # (1000, 768)

# ä¸ä¿æŒç»´åº¦
norms = np.linalg.norm(embeddings, axis=1)  # (1000,)
# embeddings / norms  âŒ å½¢çŠ¶ä¸åŒ¹é…ï¼

# ä¿æŒç»´åº¦
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)  # (1000, 1)
# embeddings / norms  âœ… å¹¿æ’­æ­£ç¡®ï¼
```

**è®°ä½ï¼š** æ‰¹é‡å½’ä¸€åŒ–å¿…é¡»ç”¨`keepdims=True`

---

### å¡ç‰‡6ï¼šå®‰å…¨å½’ä¸€åŒ– ğŸ›¡ï¸

**é—®é¢˜ï¼š** é›¶å‘é‡é™¤ä»¥0ä¼šå‡ºé”™

**è§£å†³æ–¹æ¡ˆï¼š**
```python
def safe_normalize(vectors, eps=1e-8):
    norms = np.linalg.norm(vectors, axis=-1, keepdims=True)
    norms = np.maximum(norms, eps)  # é¿å…é™¤0
    return vectors / norms
```

**é€‚ç”¨åœºæ™¯ï¼š**
- æ•°æ®å¯èƒ½åŒ…å«é›¶å‘é‡
- ç”Ÿäº§ç¯å¢ƒå¿…å¤‡

---

### å¡ç‰‡7ï¼šå½’ä¸€åŒ–ä¸ç‚¹ç§¯ ğŸ”—

**æ ¸å¿ƒå…³ç³»ï¼š**
```
å½’ä¸€åŒ–åï¼šä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯
```

**éªŒè¯ï¼š**
```python
v1_norm = v1 / np.linalg.norm(v1)
v2_norm = v2 / np.linalg.norm(v2)

# ä¸¤ç§æ–¹æ³•ç»“æœç›¸åŒ
cosine = np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))
dot_product = np.dot(v1_norm, v2_norm)

np.isclose(cosine, dot_product)  # True
```

---

### å¡ç‰‡8ï¼šå‘é‡æ•°æ®åº“å®è·µ ğŸ—„ï¸

**Milvusç¤ºä¾‹ï¼š**
```python
# å…¥åº“æ—¶å½’ä¸€åŒ–
embeddings = model.encode(texts)
embeddings_norm = embeddings / np.linalg.norm(embeddings, axis=1, keepdims=True)
collection.insert([ids, embeddings_norm.tolist()])

# æŸ¥è¯¢æ—¶ä¹Ÿå½’ä¸€åŒ–
query_emb = model.encode(query)
query_norm = query_emb / np.linalg.norm(query_emb)
collection.search([query_norm], metric_type="IP")
```

**æ³¨æ„ï¼š** ä½¿ç”¨IPåº¦é‡ï¼Œä¸æ˜¯COSINEï¼

---

### å¡ç‰‡9ï¼šfloat32è¶³å¤Ÿ ğŸ’¾

**å†…å­˜å¯¹æ¯”ï¼š**
```python
f64 = np.random.randn(100000, 768)           # 585 MB
f32 = np.random.randn(100000, 768).astype(np.float32)  # 293 MB
```

**ç²¾åº¦å·®å¼‚ï¼š** ~1e-7ï¼Œå®Œå…¨å¯æ¥å—

**ç»“è®ºï¼š** å‘é‡æ•°æ®åº“ç”¨float32ï¼

---

### å¡ç‰‡10ï¼šå¸¸è§è¯¯åŒº âš ï¸

**è¯¯åŒº1ï¼š** æ•°æ®åº“è‡ªåŠ¨å½’ä¸€åŒ–
- äº‹å®ï¼šå¤§å¤šæ•°ä¸ä¼šï¼

**è¯¯åŒº2ï¼š** å½’ä¸€åŒ–ä¸¢å¤±ä¿¡æ¯
- äº‹å®ï¼šåªä¸¢é•¿åº¦ï¼Œä¿ç•™æ–¹å‘ï¼ˆè¯­ä¹‰ï¼‰

**è¯¯åŒº3ï¼š** å½’ä¸€åŒ–åªæ˜¯ä¸ºäº†å¥½çœ‹
- äº‹å®ï¼šæ€§èƒ½æå‡2-3å€ï¼

**æœ€ä½³å®è·µï¼š**
```python
# æ°¸è¿œè‡ªå·±å½’ä¸€åŒ–
embedding = model.encode(text)
embedding = embedding / np.linalg.norm(embedding)
db.insert(embedding)
```

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**å‘é‡å½’ä¸€åŒ–æ˜¯å°†embeddingé•¿åº¦ç»Ÿä¸€ä¸º1çš„é¢„å¤„ç†æ“ä½œï¼Œä½¿ä½™å¼¦ç›¸ä¼¼åº¦ç®€åŒ–ä¸ºç‚¹ç§¯è®¡ç®—ï¼Œæ˜¯å‘é‡æ•°æ®åº“å®ç°é«˜æ•ˆæ£€ç´¢çš„åŸºç¡€ï¼Œæ‰€æœ‰embeddingåœ¨å…¥åº“å’ŒæŸ¥è¯¢æ—¶éƒ½åº”è¯¥å½’ä¸€åŒ–ã€‚**

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡ ğŸ“‹

### æ ¸å¿ƒä»£ç é€ŸæŸ¥

```python
import numpy as np

# ===== å•å‘é‡å½’ä¸€åŒ– =====
v_norm = v / np.linalg.norm(v)

# ===== æ‰¹é‡å½’ä¸€åŒ– =====
norms = np.linalg.norm(embeddings, axis=1, keepdims=True)
normalized = embeddings / norms

# ===== å®‰å…¨å½’ä¸€åŒ– =====
def safe_normalize(vectors, eps=1e-8):
    norms = np.linalg.norm(vectors, axis=-1, keepdims=True)
    return vectors / np.maximum(norms, eps)

# ===== ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå½’ä¸€åŒ–åï¼‰=====
similarity = np.dot(v1_norm, v2_norm)  # å•å¯¹
similarities = embeddings_norm @ query_norm  # æ‰¹é‡

# ===== Top-Kæ£€ç´¢ =====
top_k_idx = np.argsort(similarities)[::-1][:k]
```

### å­¦ä¹ æ£€æŸ¥æ¸…å• âœ…

- [ ] ç†è§£å½’ä¸€åŒ–çš„æ•°å­¦å®šä¹‰ï¼ˆv / ||v||ï¼‰
- [ ] çŸ¥é“å½’ä¸€åŒ–çš„ä¸‰å¤§ä»·å€¼ï¼ˆè®¡ç®—ã€å…¬å¹³ã€ç¨³å®šï¼‰
- [ ] æŒæ¡å•å‘é‡å½’ä¸€åŒ–ä»£ç 
- [ ] æŒæ¡æ‰¹é‡å½’ä¸€åŒ–ä»£ç 
- [ ] ç†è§£keepdimså‚æ•°çš„ä½œç”¨
- [ ] ä¼šå¤„ç†é›¶å‘é‡ï¼ˆå®‰å…¨å½’ä¸€åŒ–ï¼‰
- [ ] çŸ¥é“å½’ä¸€åŒ–åç‚¹ç§¯ = ä½™å¼¦ç›¸ä¼¼åº¦
- [ ] äº†è§£ä¸»æµå‘é‡æ•°æ®åº“çš„å½’ä¸€åŒ–ç­–ç•¥
- [ ] çŸ¥é“ä½¿ç”¨float32è¶³å¤Ÿ
- [ ] èƒ½ç‹¬ç«‹å®ç°å‘é‡æ£€ç´¢æµç¨‹

### ä¸‹ä¸€æ­¥å­¦ä¹  ğŸš€

æŒæ¡äº†å½’ä¸€åŒ–åï¼Œå»ºè®®å­¦ä¹ ï¼š

1. **å¹¿æ’­æœºåˆ¶ä¸np.newaxis**ï¼šæ‰¹é‡è®¡ç®—çš„æ ¸å¿ƒ
2. **ANNç®—æ³•**ï¼šHNSWã€IVFç­‰è¿‘ä¼¼æœç´¢
3. **Milvuså®æˆ˜**ï¼šå®Œæ•´çš„å‘é‡æ•°æ®åº“ä½¿ç”¨

**å­¦ä¹ è·¯å¾„ï¼š**
```
NumPyæ•°ç»„åˆ›å»º
    â†“
å‘é‡åŒ–è¿ç®—
    â†“
å¹¿æ’­æœºåˆ¶åŸºç¡€
    â†“
å‘é‡æ•°æ®åº“å½’ä¸€åŒ–ï¼ˆå½“å‰ï¼‰âœ…
    â†“
å¹¿æ’­æœºåˆ¶ä¸np.newaxis
    â†“
å‘é‡æ•°æ®åº“å®æˆ˜
```

---

## å‚è€ƒèµ„æº ğŸ“š

1. **NumPyèŒƒæ•°æ–‡æ¡£**ï¼šhttps://numpy.org/doc/stable/reference/generated/numpy.linalg.norm.html
2. **Milvuså½’ä¸€åŒ–æŒ‡å—**ï¼šhttps://milvus.io/docs/metric.md
3. **Pineconeæœ€ä½³å®è·µ**ï¼šhttps://docs.pinecone.io/docs/manage-indexes
4. **ä½™å¼¦ç›¸ä¼¼åº¦è¯¦è§£**ï¼šhttps://en.wikipedia.org/wiki/Cosine_similarity

---

**ç»“è¯­ï¼š** å½’ä¸€åŒ–æ˜¯å‘é‡æ•°æ®åº“çš„åŸºç¡€æ“ä½œï¼Œçœ‹ä¼¼ç®€å•å´è‡³å…³é‡è¦ã€‚æŒæ¡äº†å½’ä¸€åŒ–ï¼Œä½ å°±æŒæ¡äº†é«˜æ•ˆæ£€ç´¢çš„ç¬¬ä¸€æ­¥ï¼ç»§ç»­åŠ æ²¹ï¼ğŸ’ª
